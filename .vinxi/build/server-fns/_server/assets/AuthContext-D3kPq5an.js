import{createComponent as f}from"solid-js/web";import{useContext as h,createContext as p,createSignal as a,createEffect as g}from"solid-js";const c=p(),w=()=>{const[s,l]=a(null),[u,i]=a(!1),n=t=>{l(t),typeof window<"u"&&(t?sessionStorage.setItem("user",JSON.stringify(t)):sessionStorage.removeItem("user"))};g(()=>{if(typeof window>"u")return;process.env.DISABLE_DEV_USER==="true"&&localStorage.setItem("DISABLE_DEV_USER","true");const o=typeof window<"u"?sessionStorage.getItem("user"):null;if(o)try{const e=JSON.parse(o),r=e.user||e;r&&typeof r=="object"&&r.id?(n(r),d(r)):typeof window<"u"&&sessionStorage.removeItem("user")}catch{n(null),typeof window<"u"&&sessionStorage.removeItem("user")}i(!0),i(!0)});const d=async t=>{try{i(!1);const e=await(await fetch("/api/auth/verify",{method:"GET",credentials:"include",headers:{"Content-Type":"application/json","Cache-Control":"no-cache",Pragma:"no-cache"}})).json();e.valid&&e.user?(console.log("Session verified:",e.user),n({...e.user,role:e.user.role||"user"})):(console.log("No valid session found"),n(null),typeof window<"u"&&sessionStorage.removeItem("user"))}catch(o){console.error("Session verification error:",o),n(null),typeof window<"u"&&sessionStorage.removeItem("user")}finally{i(!0)}};return{user:s,login:async(t,o)=>{try{const e=await fetch("/api/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({username:t,password:o})}),r=await e.json();if(!e.ok)throw new Error(r?.error||"Login failed");if(!r.user)throw new Error("Invalid server response: missing user data");return n(r.user),r.user}catch(e){throw console.error("Login error:",e),e}},logout:async()=>{try{try{const o=await fetch("/api/game/leave",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include"});o.ok?console.log("Successfully left game before logout"):console.warn("Failed to leave game before logout:",await o.text())}catch(o){console.warn("Error leaving game before logout:",o)}if(!(await fetch("/api/auth/logout",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include"})).ok)throw new Error("Logout failed");n(null),window.location.href="/"}catch{n(null),window.location.href="/"}},isInitialized:u}},E=s=>f(c.Provider,{get value(){return w()},get children(){return s.children}}),I=()=>{const s=h(c);if(!s)throw new Error("useAuth must be used within an AuthProvider");return s};export{E as A,I as u};
