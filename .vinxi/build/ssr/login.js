import{g as m,a as p}from"./assets/db-PRkUVS-C.js";import{g as c}from"./assets/jwt-CO0ye28h.js";import{serialize as d}from"cookie";import"crypto";import"sqlite3";import"sqlite";import"fs";import"path";import"./assets/utils-AQpNWTN2.js";import"pako";import"jsonwebtoken";function o(a,{status:r=200,headers:t={}}={}){return new Response(JSON.stringify(a),{status:r,headers:{"Content-Type":"application/json",...t}})}async function T({request:a}){try{const r=await a.json(),{username:t,password:i}=r;if(!t||!i)return o({error:"Username and password are required"},{status:400});let e=await(await m()).get("SELECT id, username FROM users WHERE username = ?",[t]);if(!e)return o({error:"Invalid credentials"},{status:401});try{const s=await p();(await s.getByUser(e.id)).length===0&&await s.add(e.id,0,0)}catch(s){console.error("Error initializing base points:",s)}const n=c({userId:e.id,username:e.username}),u=d("auth_token",n,{httpOnly:!0,secure:!0,sameSite:"strict",maxAge:3600*24*7,path:"/"});return o({user:{id:e.id,username:e.username}},{status:200,headers:{"Set-Cookie":u}})}catch(r){return console.error("Login error:",r),o({error:"Failed to log in"},{status:500})}}export{T as POST};
