import{ssrElement as N,escape as P,mergeProps as _t,ssr as v,getRequestEvent as M,isServer as k,renderToString as vt,renderToStream as Pt,createComponent as E,delegateEvents as At,ssrHydrationKey as A,useAssets as It,NoHydration as ut,Hydration as $t,ssrAttribute as L,HydrationScript as Ct}from"solid-js/web";import{lazy as xt,createComponent as Ot,sharedConfig as x,children as Dt,createMemo as J,getOwner as Mt,untrack as kt,Show as pt,on as Nt,createRoot as Lt,createSignal as dt,onCleanup as K,Suspense as Ht,catchError as Ut,ErrorBoundary as qt}from"solid-js";import{provideRequestEvent as Bt}from"solid-js/web/storage";import{H3Event as Y,setResponseStatus as Gt,setHeader as Ft,getRequestIP as jt,getResponseStatus as Xt,getResponseStatusText as Wt,getResponseHeader as Yt,setResponseHeader as zt,removeResponseHeader as Vt,appendResponseHeader as Zt,getResponseHeaders as Jt,getRequestURL as Kt,getRequestWebStream as Qt,sendRedirect as te,getCookie as ee,setCookie as se,eventHandler as oe}from"h3";import{getContext as re}from"unctx";import{AsyncLocalStorage as ne}from"node:async_hooks";import{createRouter as ie}from"radix3";import{M as ht}from"./assets/index-BdnVf8ln.js";import{u as ae,A as ce}from"./assets/AuthContext-D3kPq5an.js";import{U as le}from"./assets/UserContext-DYj2Vavi.js";import{c as ue,a as pe,R as de,g as he,b as me,d as Q,e as fe,m as ge,f as ye,k as we,s as Ee,n as Te}from"./assets/routing-CWq3BRWv.js";import{g as mt,a as B}from"./assets/db-PRkUVS-C.js";import{getRandomSlopes as ft,getSlopeConditions as tt}from"./assets/randomSlopes-izTC2X1N.js";import{performance as j}from"perf_hooks";import{t as et}from"./assets/tile-cache.service-CfnteglI.js";import{basePointEventService as q}from"./assets/base-point-events-C2UNy6C4.js";import{randomInt as H}from"crypto";import{B as D,c as Re}from"./assets/game-eWeYT9Is.js";import"sqlite3";import"sqlite";import"fs";import"path";import"./assets/utils-AQpNWTN2.js";import"pako";import"events";function Se(s){let e;const t=yt(s),r={duplex:"half",method:s.method,headers:s.headers};return s.node.req.body instanceof ArrayBuffer?new Request(t,{...r,body:s.node.req.body}):new Request(t,{...r,get body(){return e||(e=De(s),e)}})}function be(s){return s.web??={request:Se(s),url:yt(s)},s.web.request}function _e(){return Le()}const gt=Symbol("$HTTPEvent");function ve(s){return typeof s=="object"&&(s instanceof Y||s?.[gt]instanceof Y||s?.__is_event__===!0)}function b(s){return function(...e){let t=e[0];if(ve(t))e[0]=t instanceof Y||t.__is_event__?t:t[gt];else{if(!globalThis.app.config.server.experimental?.asyncContext)throw new Error("AsyncLocalStorage was not enabled. Use the `server.experimental.asyncContext: true` option in your app configuration to enable it. Or, pass the instance of HTTPEvent that you have as the first argument to the function.");if(t=_e(),!t)throw new Error("No HTTPEvent found in AsyncLocalStorage. Make sure you are using the function within the server runtime.");e.unshift(t)}return s(...e)}}const yt=b(Kt),Pe=b(jt),z=b(Gt),st=b(Xt),Ae=b(Wt),U=b(Jt),ot=b(Yt),Ie=b(zt),$e=b(Zt),rt=b(te),Ce=b(ee),xe=b(se),Oe=b(Ft),De=b(Qt),Me=b(Vt),ke=b(be);function Ne(){return re("nitro-app",{asyncContext:!!globalThis.app.config.server.experimental?.asyncContext,AsyncLocalStorage:ne})}function Le(){return Ne().use().event}const wt=[{page:!0,$component:{src:"src/routes/[...404].tsx?pick=default&pick=$css",build:()=>import("./_...404_.js"),import:()=>import("./_...404_.js")},path:"/*404",filePath:"/home/n/data/l/windsurf/solidstart/solid-project/src/routes/[...404].tsx"},{page:!1,$GET:{src:"src/routes/api/admin/performance.ts?pick=GET",build:()=>import("./performance.js"),import:()=>import("./performance.js")},$HEAD:{src:"src/routes/api/admin/performance.ts?pick=GET",build:()=>import("./performance.js"),import:()=>import("./performance.js")},path:"/api/admin/performance",filePath:"/home/n/data/l/windsurf/solidstart/solid-project/src/routes/api/admin/performance.ts"},{page:!1,$POST:{src:"src/routes/api/auth/index.ts?pick=POST",build:()=>import("./index.js"),import:()=>import("./index.js")},path:"/api/auth/",filePath:"/home/n/data/l/windsurf/solidstart/solid-project/src/routes/api/auth/index.ts"},{page:!1,$POST:{src:"src/routes/api/auth/login.ts?pick=POST",build:()=>import("./login.js"),import:()=>import("./login.js")},path:"/api/auth/login",filePath:"/home/n/data/l/windsurf/solidstart/solid-project/src/routes/api/auth/login.ts"},{page:!1,$POST:{src:"src/routes/api/auth/logout.ts?pick=POST",build:()=>import("./logout.js"),import:()=>import("./logout.js")},path:"/api/auth/logout",filePath:"/home/n/data/l/windsurf/solidstart/solid-project/src/routes/api/auth/logout.ts"},{page:!1,$POST:{src:"src/routes/api/auth/register.ts?pick=POST",build:()=>import("./register.js"),import:()=>import("./register.js")},path:"/api/auth/register",filePath:"/home/n/data/l/windsurf/solidstart/solid-project/src/routes/api/auth/register.ts"},{page:!1,$GET:{src:"src/routes/api/auth/verify.ts?pick=GET",build:()=>import("./verify.js"),import:()=>import("./verify.js")},$HEAD:{src:"src/routes/api/auth/verify.ts?pick=GET",build:()=>import("./verify.js"),import:()=>import("./verify.js")},path:"/api/auth/verify",filePath:"/home/n/data/l/windsurf/solidstart/solid-project/src/routes/api/auth/verify.ts"},{page:!1,$GET:{src:"src/routes/api/base-points/count.ts?pick=GET",build:()=>import("./count.js"),import:()=>import("./count.js")},$HEAD:{src:"src/routes/api/base-points/count.ts?pick=GET",build:()=>import("./count.js"),import:()=>import("./count.js")},path:"/api/base-points/count",filePath:"/home/n/data/l/windsurf/solidstart/solid-project/src/routes/api/base-points/count.ts"},{page:!1,$DELETE:{src:"src/routes/api/base-points.ts?pick=DELETE",build:()=>import("./base-points.js"),import:()=>import("./base-points.js")},$GET:{src:"src/routes/api/base-points.ts?pick=GET",build:()=>import("./base-points2.js"),import:()=>import("./base-points2.js")},$HEAD:{src:"src/routes/api/base-points.ts?pick=GET",build:()=>import("./base-points2.js"),import:()=>import("./base-points2.js")},$POST:{src:"src/routes/api/base-points.ts?pick=POST",build:()=>import("./base-points3.js"),import:()=>import("./base-points3.js")},path:"/api/base-points",filePath:"/home/n/data/l/windsurf/solidstart/solid-project/src/routes/api/base-points.ts"},{page:!1,$POST:{src:"src/routes/api/calculate-squares.ts?pick=POST",build:()=>import("./calculate-squares.js"),import:()=>import("./calculate-squares.js")},path:"/api/calculate-squares",filePath:"/home/n/data/l/windsurf/solidstart/solid-project/src/routes/api/calculate-squares.ts"},{page:!1,$GET:{src:"src/routes/api/events.ts?pick=GET",build:()=>import("./events.js"),import:()=>import("./events.js")},$HEAD:{src:"src/routes/api/events.ts?pick=GET",build:()=>import("./events.js"),import:()=>import("./events.js")},path:"/api/events",filePath:"/home/n/data/l/windsurf/solidstart/solid-project/src/routes/api/events.ts"},{page:!1,$POST:{src:"src/routes/api/game/join.ts?pick=POST",build:()=>import("./join.js"),import:()=>import("./join.js")},path:"/api/game/join",filePath:"/home/n/data/l/windsurf/solidstart/solid-project/src/routes/api/game/join.ts"},{page:!1,$POST:{src:"src/routes/api/game/leave.ts?pick=POST",build:()=>import("./leave.js"),import:()=>import("./leave.js")},path:"/api/game/leave",filePath:"/home/n/data/l/windsurf/solidstart/solid-project/src/routes/api/game/leave.ts"},{page:!1,$GET:{src:"src/routes/api/game/status.ts?pick=GET",build:()=>import("./status.js"),import:()=>import("./status.js")},$HEAD:{src:"src/routes/api/game/status.ts?pick=GET",build:()=>import("./status.js"),import:()=>import("./status.js")},path:"/api/game/status",filePath:"/home/n/data/l/windsurf/solidstart/solid-project/src/routes/api/game/status.ts"},{page:!1,$GET:{src:"src/routes/api/map/tile/[tileX]/[tileY].ts?pick=GET",build:()=>import("./_tileY_.js"),import:()=>import("./_tileY_.js")},$HEAD:{src:"src/routes/api/map/tile/[tileX]/[tileY].ts?pick=GET",build:()=>import("./_tileY_.js"),import:()=>import("./_tileY_.js")},$OPTIONS:{src:"src/routes/api/map/tile/[tileX]/[tileY].ts?pick=OPTIONS",build:()=>import("./_tileY_2.js"),import:()=>import("./_tileY_2.js")},path:"/api/map/tile/:tileX/:tileY",filePath:"/home/n/data/l/windsurf/solidstart/solid-project/src/routes/api/map/tile/[tileX]/[tileY].ts"},{page:!1,$POST:{src:"src/routes/api/reset-game-progress.ts?pick=POST",build:()=>import("./reset-game-progress.js"),import:()=>import("./reset-game-progress.js")},path:"/api/reset-game-progress",filePath:"/home/n/data/l/windsurf/solidstart/solid-project/src/routes/api/reset-game-progress.ts"},{page:!0,$component:{src:"src/routes/game/index.tsx?pick=default&pick=$css",build:()=>import("./index2.js"),import:()=>import("./index2.js")},path:"/game/",filePath:"/home/n/data/l/windsurf/solidstart/solid-project/src/routes/game/index.tsx"},{page:!0,$component:{src:"src/routes/index.tsx?pick=default&pick=$css",build:()=>import("./index3.js"),import:()=>import("./index3.js")},path:"/",filePath:"/home/n/data/l/windsurf/solidstart/solid-project/src/routes/index.tsx"},{page:!0,$component:{src:"src/routes/login.tsx?pick=default&pick=$css",build:()=>import("./login2.js"),import:()=>import("./login2.js")},path:"/login",filePath:"/home/n/data/l/windsurf/solidstart/solid-project/src/routes/login.tsx"},{page:!0,$component:{src:"src/routes/register.tsx?pick=default&pick=$css",build:()=>import("./register2.js"),import:()=>import("./register2.js")},path:"/register",filePath:"/home/n/data/l/windsurf/solidstart/solid-project/src/routes/register.tsx"}],He=Ue(wt.filter(s=>s.page));function Ue(s){function e(t,r,o,n){const l=Object.values(t).find(a=>o.startsWith(a.id+"/"));return l?(e(l.children||(l.children=[]),r,o.slice(l.id.length)),t):(t.push({...r,id:o,path:o.replace(/\([^)/]+\)/g,"").replace(/\/+/g,"/")}),t)}return s.sort((t,r)=>t.path.length-r.path.length).reduce((t,r)=>e(t,r,r.path,r.path),[])}function qe(s,e){const t=Ge.lookup(s);if(t&&t.route){const r=e==="HEAD"?t.route.$HEAD||t.route.$GET:t.route[`$${e}`];return r===void 0?void 0:{handler:r,params:t.params}}}function Be(s){return s.$HEAD||s.$GET||s.$POST||s.$PUT||s.$PATCH||s.$DELETE}const Ge=ie({routes:wt.reduce((s,e)=>{if(!Be(e))return s;let t=e.path.replace(/\([^)/]+\)/g,"").replace(/\/+/g,"/").replace(/\*([^/]*)/g,(r,o)=>`**:${o}`).split("/").map(r=>r.startsWith(":")||r.startsWith("*")?r:encodeURIComponent(r)).join("/");if(/:[^/]*\?/g.test(t))throw new Error(`Optional parameters are not supported in API routes: ${t}`);if(s[t])throw new Error(`Duplicate API routes for "${t}" found at "${s[t].route.path}" and "${e.path}"`);return s[t]={route:e},s},{})}),X="solidFetchEvent";function Fe(s){return{request:ke(s),response:We(s),clientAddress:Pe(s),locals:{},nativeEvent:s}}function je(s){if(!s.context[X]){const e=Fe(s);s.context[X]=e}return s.context[X]}class Xe{event;constructor(e){this.event=e}get(e){const t=ot(this.event,e);return Array.isArray(t)?t.join(", "):t||null}has(e){return this.get(e)!==void 0}set(e,t){return Ie(this.event,e,t)}delete(e){return Me(this.event,e)}append(e,t){$e(this.event,e,t)}getSetCookie(){const e=ot(this.event,"Set-Cookie");return Array.isArray(e)?e:[e]}forEach(e){return Object.entries(U(this.event)).forEach(([t,r])=>e(Array.isArray(r)?r.join(", "):r,t,this))}entries(){return Object.entries(U(this.event)).map(([e,t])=>[e,Array.isArray(t)?t.join(", "):t])[Symbol.iterator]()}keys(){return Object.keys(U(this.event))[Symbol.iterator]()}values(){return Object.values(U(this.event)).map(e=>Array.isArray(e)?e.join(", "):e)[Symbol.iterator]()}[Symbol.iterator](){return this.entries()[Symbol.iterator]()}}function We(s){return{get status(){return st(s)},set status(e){z(s,e)},get statusText(){return Ae(s)},set statusText(e){z(s,st(s),e)},headers:new Xe(s)}}function Ye(s){s.forEach(e=>{if(!e.attrs.href)return;let t=document.head.querySelector(`link[href="${e.attrs.href}"]`);t||(t=document.createElement("link"),t.setAttribute("rel","preload"),t.setAttribute("as","style"),t.setAttribute("href",e.attrs.href),document.head.appendChild(t))})}var ze=" ";const Ve={style:s=>N("style",s.attrs,()=>s.children,!0),link:s=>N("link",s.attrs,void 0,!0),script:s=>s.attrs.src?N("script",_t(()=>s.attrs,{get id(){return s.key}}),()=>v(ze),!0):null,noscript:s=>N("noscript",s.attrs,()=>P(s.children),!0)};function V(s,e){let{tag:t,attrs:{key:r,...o}={key:void 0},children:n}=s;return Ve[t]({attrs:{...o,nonce:e},key:r,children:n})}function Ze(s,e,t,r="default"){return xt(async()=>{{const n=(await s.import())[r],a=(await e.inputs?.[s.src].assets()).filter(h=>h.tag==="style"||h.attrs.rel==="stylesheet");return typeof window<"u"&&Ye(a),{default:h=>[...a.map(m=>V(m)),Ot(n,h)]}}})}function Et(){function s(t){return{...t,...t.$$route?t.$$route.require().route:void 0,info:{...t.$$route?t.$$route.require().route.info:{},filesystem:!0},component:t.$component&&Ze(t.$component,globalThis.MANIFEST.client,globalThis.MANIFEST.ssr),children:t.children?t.children.map(s):void 0}}return He.map(s)}let nt;const Je=k?()=>M().routes:()=>nt||(nt=Et());function Ke(s){const e=Ce(s.nativeEvent,"flash");if(e)try{let t=JSON.parse(e);if(!t||!t.result)return;const r=[...t.input.slice(0,-1),new Map(t.input[t.input.length-1])],o=t.error?new Error(t.result):t.result;return{input:r,url:t.url,pending:!1,result:t.thrown?void 0:o,error:t.thrown?o:void 0}}catch(t){console.error(t)}finally{xe(s.nativeEvent,"flash","",{maxAge:0})}}async function Qe(s){const e=globalThis.MANIFEST.client;return globalThis.MANIFEST.ssr,s.response.headers.set("Content-Type","text/html"),Object.assign(s,{manifest:await e.json(),assets:[...await e.inputs[e.handler].assets()],router:{submission:Ke(s)},routes:Et(),complete:!1,$islands:new Set})}const ts=new Set([301,302,303,307,308]);function Z(s){return s.status&&ts.has(s.status)?s.status:302}function es(s,e,t={},r){return oe({handler:o=>{const n=je(o);return Bt(n,async()=>{const l=qe(new URL(n.request.url).pathname,n.request.method);if(l){const y=await l.handler.import(),R=n.request.method==="HEAD"?y.HEAD||y.GET:y[n.request.method];n.params=l.params||{},x.context={event:n};const i=await R(n);if(i!==void 0)return i;if(n.request.method!=="GET")throw new Error(`API handler for ${n.request.method} "${n.request.url}" did not return a response.`)}const a=await e(n),u=typeof t=="function"?await t(a):{...t},h=u.mode||"stream";if(u.nonce&&(a.nonce=u.nonce),h==="sync"){const y=vt(()=>(x.context.event=a,s(a)),u);if(a.complete=!0,a.response&&a.response.headers.get("Location")){const R=Z(a.response);return rt(o,a.response.headers.get("Location"),R)}return y}if(u.onCompleteAll){const y=u.onCompleteAll;u.onCompleteAll=R=>{at(a)(R),y(R)}}else u.onCompleteAll=at(a);if(u.onCompleteShell){const y=u.onCompleteShell;u.onCompleteShell=R=>{it(a,o)(),y(R)}}else u.onCompleteShell=it(a,o);const m=Pt(()=>(x.context.event=a,s(a)),u);if(a.response&&a.response.headers.get("Location")){const y=Z(a.response);return rt(o,a.response.headers.get("Location"),y)}if(h==="async")return m;const{writable:_,readable:T}=new TransformStream;return m.pipeTo(_),T})}})}function it(s,e){return()=>{if(s.response&&s.response.headers.get("Location")){const t=Z(s.response);z(e,t),Oe(e,"Location",s.response.headers.get("Location"))}}}function at(s){return({write:e})=>{s.complete=!0;const t=s.response&&s.response.headers.get("Location");t&&e(`<script>window.location="${t}"<\/script>`)}}function ss(s,e,t){return es(s,Qe,e)}const Tt=s=>e=>{const{base:t}=e,r=Dt(()=>e.children),o=J(()=>ue(r(),e.base||""));let n;const l=pe(s,o,()=>n,{base:t,singleFlight:e.singleFlight,transformUrl:e.transformUrl});return s.create&&s.create(l),E(de.Provider,{value:l,get children(){return E(os,{routerState:l,get root(){return e.root},get preload(){return e.rootPreload||e.rootLoad},get children(){return[(n=Mt())&&null,E(rs,{routerState:l,get branches(){return o()}})]}})}})};function os(s){const e=s.routerState.location,t=s.routerState.params,r=J(()=>s.preload&&kt(()=>{s.preload({params:t,location:e,intent:he()||"initial"})}));return E(pt,{get when(){return s.root},keyed:!0,get fallback(){return s.children},children:o=>E(o,{params:t,location:e,get data(){return r()},get children(){return s.children}})})}function rs(s){if(k){const o=M();if(o&&o.router&&o.router.dataOnly){ns(o,s.routerState,s.branches);return}o&&((o.router||(o.router={})).matches||(o.router.matches=s.routerState.matches().map(({route:n,path:l,params:a})=>({path:n.originalPath,pattern:n.pattern,match:l,params:a,info:n.info}))))}const e=[];let t;const r=J(Nt(s.routerState.matches,(o,n,l)=>{let a=n&&o.length===n.length;const u=[];for(let h=0,m=o.length;h<m;h++){const _=n&&n[h],T=o[h];l&&_&&T.route.key===_.route.key?u[h]=l[h]:(a=!1,e[h]&&e[h](),Lt(y=>{e[h]=y,u[h]=me(s.routerState,u[h-1]||s.routerState.base,ct(()=>r()[h+1]),()=>s.routerState.matches()[h])}))}return e.splice(o.length).forEach(h=>h()),l&&a?l:(t=u[0],u)}));return ct(()=>r()&&t)()}const ct=s=>()=>E(pt,{get when(){return s()},keyed:!0,children:e=>E(fe.Provider,{value:e,get children(){return e.outlet()}})});function ns(s,e,t){const r=new URL(s.request.url),o=Q(t,new URL(s.router.previousUrl||s.request.url).pathname),n=Q(t,r.pathname);for(let l=0;l<n.length;l++){(!o[l]||n[l].route!==o[l].route)&&(s.router.dataOnly=!0);const{route:a,params:u}=n[l];a.preload&&a.preload({params:u,location:e.location,intent:"preload"})}}function is([s,e],t,r){return[s,r?o=>e(r(o)):e]}function as(s){let e=!1;const t=o=>typeof o=="string"?{value:o}:o,r=is(dt(t(s.get()),{equals:(o,n)=>o.value===n.value&&o.state===n.state}),void 0,o=>(!e&&s.set(o),x.registry&&!x.done&&(x.done=!0),o));return s.init&&K(s.init((o=s.get())=>{e=!0,r[1](t(o)),e=!1})),Tt({signal:r,create:s.create,utils:s.utils})}function cs(s,e,t){return s.addEventListener(e,t),()=>s.removeEventListener(e,t)}function ls(s,e){const t=s&&document.getElementById(s);t?t.scrollIntoView():e&&window.scrollTo(0,0)}function us(s){const e=new URL(s);return e.pathname+e.search}function ps(s){let e;const t={value:s.url||(e=M())&&us(e.request.url)||""};return Tt({signal:[()=>t,r=>Object.assign(t,r)]})(s)}const ds=new Map;function hs(s=!0,e=!1,t="/_server",r){return o=>{const n=o.base.path(),l=o.navigatorFactory(o.base);let a,u;function h(i){return i.namespaceURI==="http://www.w3.org/2000/svg"}function m(i){if(i.defaultPrevented||i.button!==0||i.metaKey||i.altKey||i.ctrlKey||i.shiftKey)return;const c=i.composedPath().find(w=>w instanceof Node&&w.nodeName.toUpperCase()==="A");if(!c||e&&!c.hasAttribute("link"))return;const d=h(c),p=d?c.href.baseVal:c.href;if((d?c.target.baseVal:c.target)||!p&&!c.hasAttribute("state"))return;const S=(c.getAttribute("rel")||"").split(/\s+/);if(c.hasAttribute("download")||S&&S.includes("external"))return;const f=d?new URL(p,document.baseURI):new URL(p);if(!(f.origin!==window.location.origin||n&&f.pathname&&!f.pathname.toLowerCase().startsWith(n.toLowerCase())))return[c,f]}function _(i){const c=m(i);if(!c)return;const[d,p]=c,g=o.parsePath(p.pathname+p.search+p.hash),S=d.getAttribute("state");i.preventDefault(),l(g,{resolve:!1,replace:d.hasAttribute("replace"),scroll:!d.hasAttribute("noscroll"),state:S?JSON.parse(S):void 0})}function T(i){const c=m(i);if(!c)return;const[d,p]=c;r&&(p.pathname=r(p.pathname)),o.preloadRoute(p,d.getAttribute("preload")!=="false")}function y(i){clearTimeout(a);const c=m(i);if(!c)return u=null;const[d,p]=c;u!==d&&(r&&(p.pathname=r(p.pathname)),a=setTimeout(()=>{o.preloadRoute(p,d.getAttribute("preload")!=="false"),u=d},20))}function R(i){if(i.defaultPrevented)return;let c=i.submitter&&i.submitter.hasAttribute("formaction")?i.submitter.getAttribute("formaction"):i.target.getAttribute("action");if(!c)return;if(!c.startsWith("https://action/")){const p=new URL(c,ge);if(c=o.parsePath(p.pathname+p.search),!c.startsWith(t))return}if(i.target.method.toUpperCase()!=="POST")throw new Error("Only POST forms are supported for Actions");const d=ds.get(c);if(d){i.preventDefault();const p=new FormData(i.target,i.submitter);d.call({r:o,f:i.target},i.target.enctype==="multipart/form-data"?p:new URLSearchParams(p))}}At(["click","submit"]),document.addEventListener("click",_),s&&(document.addEventListener("mousemove",y,{passive:!0}),document.addEventListener("focusin",T,{passive:!0}),document.addEventListener("touchstart",T,{passive:!0})),document.addEventListener("submit",R),K(()=>{document.removeEventListener("click",_),s&&(document.removeEventListener("mousemove",y),document.removeEventListener("focusin",T),document.removeEventListener("touchstart",T)),document.removeEventListener("submit",R)})}}function ms(s){if(k)return ps(s);const e=()=>{const r=window.location.pathname.replace(/^\/+/,"/")+window.location.search,o=window.history.state&&window.history.state._depth&&Object.keys(window.history.state).length===1?void 0:window.history.state;return{value:r+window.location.hash,state:o}},t=ye();return as({get:e,set({value:r,replace:o,scroll:n,state:l}){o?window.history.replaceState(we(l),"",r):window.history.pushState(l,"",r),ls(decodeURIComponent(window.location.hash.slice(1)),n),Ee()},init:r=>cs(window,"popstate",Te(r,o=>{if(o&&o<0)return!t.confirm(o);{const n=e();return!t.confirm(n.value,{state:n.state})}})),create:hs(s.preload,s.explicitLinks,s.actionBase,s.transformUrl),utils:{go:r=>window.history.go(r),beforeLeave:t}})(s)}function fs(){const[s,e]=dt(!1);return ae(),null}const gs=()=>E(ms,{root:s=>E(ht,{get children(){return E(ce,{get children(){return E(le,{get children(){return E(Ht,{get children(){return[s.children,E(fs,{})]}})}})}})}}),get children(){return E(Je,{})}}),Rt=k?s=>{const e=M();return e.response.status=s.code,e.response.statusText=s.text,K(()=>!e.nativeEvent.handled&&!e.complete&&(e.response.status=200)),null}:s=>null;var ys=["<span",' style="font-size:1.5em;text-align:center;position:fixed;left:0px;bottom:55%;width:100%;">',"</span>"],ws=["<span",' style="font-size:1.5em;text-align:center;position:fixed;left:0px;bottom:55%;width:100%;">500 | Internal Server Error</span>'];const Es=s=>{const e=k?"500 | Internal Server Error":"Error | Uncaught Client Exception";return E(qt,{fallback:t=>(console.error(t),[v(ys,A(),P(e)),E(Rt,{code:500})]),get children(){return s.children}})},Ts=s=>{let e=!1;const t=Ut(()=>s.children,r=>{console.error(r),e=!!r});return e?[v(ws,A()),E(Rt,{code:500})]:t};var lt=["<script",">","<\/script>"],Rs=["<script",' type="module"'," async","><\/script>"],Ss=["<script",' type="module" async',"><\/script>"];const bs=v("<!DOCTYPE html>");function St(s,e,t=[]){for(let r=0;r<e.length;r++){const o=e[r];if(o.path!==s[0].path)continue;let n=[...t,o];if(o.children){const l=s.slice(1);if(l.length===0||(n=St(l,o.children,n),!n))continue}return n}}function _s(s){const e=M(),t=e.nonce;let r=[];return Promise.resolve().then(async()=>{let o=[];if(e.router&&e.router.matches){const n=[...e.router.matches];for(;n.length&&(!n[0].info||!n[0].info.filesystem);)n.shift();const l=n.length&&St(n,e.routes);if(l){const a=globalThis.MANIFEST.client.inputs;for(let u=0;u<l.length;u++){const h=l[u],m=a[h.$component.src];o.push(m.assets())}}}r=await Promise.all(o).then(n=>[...new Map(n.flat().map(l=>[l.attrs.key,l])).values()].filter(l=>l.attrs.rel==="modulepreload"&&!e.assets.find(a=>a.attrs.key===l.attrs.key)))}),It(()=>r.length?r.map(o=>V(o)):void 0),E(ut,{get children(){return[bs,E(Ts,{get children(){return E(s.document,{get assets(){return[E(Ct,{}),e.assets.map(o=>V(o,t))]},get scripts(){return t?[v(lt,A()+L("nonce",P(t,!0),!1),`window.manifest = ${JSON.stringify(e.manifest)}`),v(Rs,A(),L("nonce",P(t,!0),!1),L("src",P(globalThis.MANIFEST.client.inputs[globalThis.MANIFEST.client.handler].output.path,!0),!1))]:[v(lt,A(),`window.manifest = ${JSON.stringify(e.manifest)}`),v(Ss,A(),L("src",P(globalThis.MANIFEST.client.inputs[globalThis.MANIFEST.client.handler].output.path,!0),!1))]},get children(){return E($t,{get children(){return E(Es,{get children(){return E(gs,{})}})}})}})}})]}})}async function vs(s,e=[]){const t=j.now(),r=await s.all("SELECT game_created_at_ms as id, x, y FROM base_points ORDER BY game_created_at_ms");if(console.log(`[Cleanup] Checking ${r.length} points`),r.length<=1)return console.log("[Cleanup] Not enough points to check for lines"),{points:[],duration:0};const o=[];try{let n=[];if(e.length>0){const i=new Set,c=d=>{i.add(d),d!==0&&i.add(1/d),i.add(-d),d!==0&&i.add(-1/d)};e.forEach(d=>c(d)),n=Array.from(i)}else n=ft(2);const l=tt(n),a=new Map;n.forEach(i=>{const c=Math.round(Math.abs(i)*100)/100;a.has(c)||a.set(c,[]),a.get(c).push(i)});const u=await s.all(`
      WITH points_with_ts AS (
        SELECT 
          id,
          x,
          y,
          game_created_at_ms,
          ROW_NUMBER() OVER (PARTITION BY x ORDER BY game_created_at_ms) as rn
        FROM base_points
        WHERE (x, y) != (0, 0)  -- Exclude (0,0) from cleanup
      )
      SELECT 
        x,
        GROUP_CONCAT(id) as point_ids,
        GROUP_CONCAT(y) as y_coords,
        GROUP_CONCAT(game_created_at_ms) as timestamps,
        COUNT(*) as point_count
      FROM points_with_ts
      GROUP BY x
      HAVING point_count > 1
      ORDER BY point_count DESC
    `);for(const i of u){const c=i.point_ids.split(",").map(Number),d=i.y_coords.split(",").map(Number),p=i.timestamps.split(",").map(Number),g=c.map((f,w)=>({id:f,x:i.x,y:d[w],game_created_at_ms:p[w]})),S=g.reduce((f,w)=>w.game_created_at_ms<f.game_created_at_ms?w:f);for(const f of g)f.id!==S.id&&!(f.x===0&&f.y===0)&&(o.some(w=>w.id===f.id)||o.push(f))}const h=await s.all(`
      SELECT 
        y,
        GROUP_CONCAT(id) as point_ids,
        GROUP_CONCAT(x) as x_coords,
        GROUP_CONCAT(game_created_at_ms) as timestamps,
        COUNT(*) as point_count
      FROM base_points
      WHERE (x, y) != (0, 0)  -- Exclude (0,0) from cleanup
      GROUP BY y
      HAVING point_count > 1
      ORDER BY point_count DESC
    `);for(const i of h){const c=i.point_ids.split(",").map(Number),d=i.x_coords.split(",").map(Number),p=i.timestamps.split(",").map(Number),g=c.map((f,w)=>({id:f,x:d[w],y:i.y,game_created_at_ms:p[w]})),S=g.reduce((f,w)=>w.game_created_at_ms<f.game_created_at_ms?w:f);for(const f of g)f.id!==S.id&&!(f.x===0&&f.y===0)&&(o.some(w=>w.id===f.id)||o.push(f))}const m=5,_=[];for(let i=0;i<n.length;i+=m){const c=n.slice(i,i+m),d=tt(c);console.log(`[Cleanup] Processing slopes batch ${i/m+1}/${Math.ceil(n.length/m)}`);try{const p=await s.all(`
          SELECT 
            p1.id as p1_id, p1.x as p1_x, p1.y as p1_y, p1.game_created_at_ms as p1_created_at,
            p2.id as p2_id, p2.x as p2_x, p2.y as p2_y, p2.game_created_at_ms as p2_created_at
          FROM base_points p1
          JOIN base_points p2 ON p1.id < p2.id
          WHERE ${d}
            AND NOT (p1.x = 0 AND p1.y = 0)  -- Exclude (0,0) from cleanup
            AND NOT (p2.x = 0 AND p2.y = 0)  -- Exclude (0,0) from cleanup
        `);_.push(...p)}catch(p){console.error(`[Cleanup] Error processing slopes batch ${i/m+1}:`,p)}}const T=new Map;for(const i of _){const c=i.p2_y-i.p1_y,d=i.p1_x-i.p2_x,p=i.p2_x*i.p1_y-i.p1_x*i.p2_y,g=`${c}_${d}_${p}`;T.has(g)||T.set(g,[]);const S={id:i.p1_id,x:i.p1_x,y:i.p1_y,game_created_at_ms:i.p1_created_at},f={id:i.p2_id,x:i.p2_x,y:i.p2_y,game_created_at_ms:i.p2_created_at};T.get(g).some(w=>w.id===S.id)||T.get(g).push(S),T.get(g).some(w=>w.id===f.id)||T.get(g).push(f)}for(const[i,c]of T.entries()){if(c.length<2)continue;const d=c.reduce((p,g)=>g.game_created_at_ms<p.game_created_at_ms?g:p);for(const p of c)p.id!==d.id&&(o.some(g=>g.id===p.id)||o.push(p))}const R=j.now()-t;return console.log(`[Cleanup] Found ${o.length} points to remove`),{points:o,duration:R}}catch(n){const a=j.now()-t;return console.error("[Cleanup] Error in getPointsInLines:",{message:n instanceof Error?n.message:"Unknown error",stack:n instanceof Error?n.stack:void 0,duration:`${a.toFixed(2)}ms`,timestamp:new Date().toISOString()}),{points:[],duration:a}}}const G=64;function Ps(s,e){return{tileX:Math.floor(s/G),tileY:Math.floor(e/G)}}function As(s,e){const t=Ps(s,e),r=[t],o=(s+1)%G===0,n=(e+1)%G===0;return o&&r.push({tileX:t.tileX+1,tileY:t.tileY}),n&&r.push({tileX:t.tileX,tileY:t.tileY+1}),o&&n&&r.push({tileX:t.tileX+1,tileY:t.tileY+1}),r}class I{static instance;isInitialized=!1;constructor(){}static getInstance(){return I.instance||(I.instance=new I),I.instance}initialize(){this.isInitialized||(q.on("created",e=>this.handleBasePointChange(e)),q.on("updated",e=>this.handleBasePointChange(e)),q.on("deleted",e=>this.handleBasePointChange(e)),this.isInitialized=!0)}handleBasePointChange(e){try{const t=As(e.x,e.y);for(const{tileX:r,tileY:o}of t)et.invalidate(r,o)}catch(t){console.error("Error handling base point change:",t)}}invalidateArea(e,t,r,o){const n=this.worldToTileCoords(e,t),l=this.worldToTileCoords(r,o);for(let a=Math.min(n.tileY,l.tileY);a<=Math.max(n.tileY,l.tileY);a++)for(let u=Math.min(n.tileX,l.tileX);u<=Math.max(n.tileX,l.tileX);u++)et.invalidate(u,a)}worldToTileCoords(e,t){return{tileX:Math.floor(e/64),tileY:Math.floor(t/64)}}}const bt=I.getInstance();bt.initialize();const Is={up:[0,0],down:[0,0],right:[0,0],left:[0,0]};async function $s(s,e,t){try{const{getDb:r}=await import("./assets/db-PRkUVS-C.js").then(y=>y.d),{BasePointRepository:o}=await import("./assets/db-PRkUVS-C.js").then(y=>y.c),n=await r(),a=await new o(n).getAll();if(!Array.isArray(a))throw new Error(`Expected basePoints to be an array, got ${typeof a}`);const u=a.length>0?[...new Map(a.map(y=>[`${y.x},${y.y}`,y])).values()]:[],[h,m]=Is[t],_=s.flatMap(y=>{const R=y%D.GRID_SIZE-e[0],i=Math.floor(y/D.GRID_SIZE)-e[1];return u.flatMap(({x:c,y:d})=>{if(c===R&&d===i)return[];const p=Math.abs(R-c),g=Math.abs(i-d);if(p===0||g===0||p===g||2*p===g||2*g===p||3*p===g||3*g===p||5*p===g||5*g===p){const S=R+e[0]+h,f=i+e[1]+m;return S>=0&&S<D.GRID_SIZE&&f>=0&&f<D.GRID_SIZE?[S+f*D.GRID_SIZE]:[]}return[]})}),T=new Set(s);return[...new Set(_)].filter(y=>T.has(y))}catch(r){return console.error("Error in calculateRestrictedSquaresForSimulation:",r),[]}}class ${static instance;moveDirection;moveCount=0;totalMoves=0;isRunning=!1;simulationInterval=null;GRID_SIZE=15;VIEW_RADIUS=Math.floor(this.GRID_SIZE/2);MAX_COORDINATE=1e3;playerPosition={x:0,y:0};placedBasePoints=[{x:0,y:0}];restrictedSquares=[];constructor(){const e=["right","left","up","down"];this.moveDirection=e[Math.floor(Math.random()*e.length)]}static getInstance(){return $.instance||($.instance=new $),$.instance}async start(){if(this.isRunning)return;this.isRunning=!0;const e=parseInt(process.env.SIMULATION_MOVE_DELAY||"1000",10),t=parseInt(process.env.SIMULATION_NUM_POINTS||"800",10);process.env.SIMULATION_START_X&&process.env.SIMULATION_START_Y?this.playerPosition={x:parseInt(process.env.SIMULATION_START_X,10),y:parseInt(process.env.SIMULATION_START_Y,10)}:(this.playerPosition={x:H(-this.MAX_COORDINATE,this.MAX_COORDINATE+1),y:H(-this.MAX_COORDINATE,this.MAX_COORDINATE+1)},console.log(`Using random starting position: [${this.playerPosition.x}, ${this.playerPosition.y}]`)),console.log("🚀 Starting simulation service with:"),console.log(`- Starting position: [${this.playerPosition.x}, ${this.playerPosition.y}]`),console.log(`- Target points: ${t}`),console.log(`- Move delay: ${e}ms`),console.log("🔄 Preparing simulation environment..."),await this.resetBasePoints(),await this.fetchRestrictedSquares(),this.simulationInterval=setInterval(async()=>{try{await this.simulationStep()}catch(r){console.error("Error in simulation step:",r)}},e)}stop(){this.simulationInterval&&(clearInterval(this.simulationInterval),this.simulationInterval=null),this.isRunning=!1}isSimulationRunning(){return this.isRunning}async simulationStep(){const e=this.playerPosition.x+H(-this.VIEW_RADIUS,this.VIEW_RADIUS)+this.VIEW_RADIUS,t=this.playerPosition.y+H(-this.VIEW_RADIUS,this.VIEW_RADIUS)+this.VIEW_RADIUS;if(e<-this.MAX_COORDINATE||e>this.MAX_COORDINATE||t<-this.MAX_COORDINATE||t>this.MAX_COORDINATE){await this.moveToNewPosition();return}await this.placeBasePoint(e,t),await this.moveToNewPosition()}async resetBasePoints(){const e=await mt();try{await e.get("SELECT id FROM users WHERE id = ?",["simulation"])||(console.log("Creating simulation user..."),await e.run("INSERT INTO users (id, username, password_hash) VALUES (?, ?, ?)",["simulation","simulation","simulation_hashed_password"]),console.log("✅ Created simulation user")),console.log("🧹 Resetting base points for simulation...");const r=await B(),o=await r.getByUser("simulation");for(const n of o)await r.deleteBasePoint(n.id);console.log(`✅ Successfully deleted ${o.length} base points from database`),this.placedBasePoints=[],console.log("Adding (0,0) base point for simulation..."),await r.add("simulation",0,0),this.placedBasePoints=[{x:0,y:0}],console.log("✅ Successfully added (0,0) base point for simulation")}catch(t){throw console.error("Error resetting base points:",t),t}}async fetchRestrictedSquares(e="up"){try{const t=this.GRID_SIZE,r=Math.floor(t/2),o={left:-this.playerPosition.x,right:-this.playerPosition.x+15,top:-this.playerPosition.y,bottom:-this.playerPosition.y+15},n=[];switch(e){case"up":for(let a=o.left;a<=o.right;a++){const u=o.top,h=(a%t+t)%t,m=(u%t+t)%t;n.push(m*t+h)}break;case"down":for(let a=o.left;a<=o.right;a++){const u=o.bottom,h=(a%t+t)%t,m=(u%t+t)%t;n.push(m*t+h)}break;case"left":for(let a=o.top;a<=o.bottom;a++){const h=(o.left%t+t)%t,m=(a%t+t)%t;n.push(m*t+h)}break;case"right":for(let a=o.top;a<=o.bottom;a++){const h=(o.right%t+t)%t,m=(a%t+t)%t;n.push(m*t+h)}break}const l=await $s(Array.from({length:225},(a,u)=>u),[-this.playerPosition.x,-this.playerPosition.y],e);return this.restrictedSquares=l.map(a=>{const u=a%t+this.playerPosition.x,h=Math.floor(a/t)+this.playerPosition.y;return Re(u,h)}),this.restrictedSquares}catch(t){return console.error("Error in fetchRestrictedSquares:",t),this.restrictedSquares=[],[]}}isRestricted(e,t){return e===-this.playerPosition.x+this.VIEW_RADIUS&&t===-this.playerPosition.y+this.VIEW_RADIUS?!0:this.restrictedSquares.some(r=>r[0]===e&&r[1]===t)}async placeBasePoint(e,t){try{return this.placedBasePoints.find(n=>n.x===e&&n.y===t)||this.isRestricted(e,t)?!1:(await(await B()).add("simulation",e,t),this.placedBasePoints.push({x:e,y:t}),q.emitCreated({x:e,y:t,userId:"simulation",id:Date.now(),createdAtMs:Date.now()}),console.log(`✅ Placed base point at [${e}, ${t}] (Total: ${this.placedBasePoints.length})`),!0)}catch(r){return console.error(`Failed to place base point at (${e}, ${t}):`,r),!1}}async moveToNewPosition(){let e=0,t=0;const r={right:[{dx:1,dy:0},{dx:0,dy:-1}],left:[{dx:-1,dy:0},{dx:0,dy:1}],up:[{dx:0,dy:-1},{dx:-1,dy:0}],down:[{dx:0,dy:1},{dx:1,dy:0}]};if(this.moveCount%200===0&&this.moveCount>0){const m=["right","left","up","down"].filter(_=>_!==this.moveDirection);this.moveDirection=m[Math.floor(Math.random()*m.length)],console.log(`Changed direction to: ${this.moveDirection} after ${this.moveCount} moves`)}const o=r[this.moveDirection],n=o[Math.floor(Math.random()*o.length)];this.moveCount++,e=n.dx,t=n.dy;const l=Math.max(-this.MAX_COORDINATE,Math.min(this.MAX_COORDINATE,-this.playerPosition.x-e)),a=Math.max(-this.MAX_COORDINATE,Math.min(this.MAX_COORDINATE,-this.playerPosition.y-t));this.totalMoves++,this.playerPosition={x:-l,y:-a};let u="up";e>0?u="left":e<0&&(u="right"),t>0?u="up":t<0&&(u="down"),await this.fetchRestrictedSquares(u)}}const W=$.getInstance();class C{static instance;isInitialized=!1;cleanupInterval=null;constructor(){}static getInstance(){return C.instance||(C.instance=new C),C.instance}async initialize(){if(this.isInitialized){console.log("Server already initialized, skipping...");return}this.isInitialized=!0,console.log("Initializing server...");try{if(console.log("Skipping migrations in production (already handled during build)"),bt.initialize(),process.env.ENABLE_SIMULATION==="true")try{await W.start(),console.log("Simulation service started")}catch(e){console.error("Failed to start simulation service:",e)}this.setupCleanupInterval(),console.log("Server initialization complete")}catch(e){console.error("Failed to initialize server:",e),process.exit(1)}}async cleanup(){this.cleanupInterval&&(clearInterval(this.cleanupInterval),this.cleanupInterval=null),process.env.ENABLE_SIMULATION==="true"&&W.isSimulationRunning()&&(W.stop(),console.log("Simulation service stopped")),this.isInitialized=!1}setupCleanupInterval(){this.cleanupInterval&&clearInterval(this.cleanupInterval),console.log("[Cleanup] Setting up cleanup interval (every 10s)"),this.cleanupInterval=setInterval(async()=>{console.log("[Cleanup] Cleanup interval triggered");const e=performance.now();try{const t=await mt(),r=await B(),o=ft(16),n=performance.now(),l=await r.getCountExcludingOrigin(),a=await r.getTotalCount();console.log(`[Cleanup] Initial count: ${l} (excluding origin), ${a} (total)`);const h=[...[...new Set(o.filter(c=>Math.abs(c)>=1).map(c=>Math.round(Math.abs(c))))]].sort((c,d)=>c-d);console.log(`
          [Cleanup] Starting cleanup with slopes: ${h.join(", ")}
        `);const{points:m,duration:_}=await vs(t,o);if(m.length>0){console.log(`[Cleanup] Removing ${m.length} points in batches...`);const c=10,d=await B();let p=0;const g=performance.now();for(let w=0;w<m.length;w+=c){const O=m.slice(w,w+c);try{O.length>1?await d.deletePoints(O):O.length===1&&await d.deleteBasePoint(O[0].id),p+=O.length,w%(c*5)===0&&console.log(`[Cleanup] Progress: ${p}/${m.length} points...`),w+c<m.length&&await new Promise(F=>setTimeout(F,10))}catch(F){console.error(`[Cleanup] Error in batch ${w/c+1}:`,F)}}const S=performance.now()-g,f=performance.now()-n;f>5e3&&console.warn(`[Cleanup] WARNING: Cleanup took ${(f/1e3).toFixed(2)}s (over 5s threshold)`),console.log(`[Cleanup] Removed ${p} points in ${S.toFixed(2)}ms (total: ${f.toFixed(2)}ms)`)}const T=await r.getCountExcludingOrigin(),y=await r.getTotalCount();console.log(`[Cleanup] Final count: ${T} (excluding origin), ${y} (total)`);const R=800;if(T>=R){console.log(`[World Reset] Triggering world reset - ${T} non-origin points reached the threshold of ${R}`),await t.run("DELETE FROM base_points WHERE x != 0 OR y != 0"),await t.run("DELETE FROM map_tiles");const{getOldestPrimeTimestamp:c}=await import("./assets/randomSlopes-izTC2X1N.js"),d=c(),{basePointEventService:p}=await import("./assets/base-point-events-C2UNy6C4.js"),g={type:"worldReset",reason:"base_point_threshold_reached",threshold:R,pointsBeforeReset:T,timestamp:new Date().toISOString(),oldestPrimeTimestamp:d};p.broadcast("worldReset",g),console.log("[World Reset] World has been reset. All non-origin base points and map tiles have been cleared.")}else{const{getOldestPrimeTimestamp:c}=await import("./assets/randomSlopes-izTC2X1N.js"),d=c(),{basePointEventService:p}=await import("./assets/base-point-events-C2UNy6C4.js"),g={type:"cleanup",initialCount:l,totalBasePoints:T,totalIncludingOrigin:y,timestamp:new Date().toISOString(),oldestPrimeTimestamp:d};p.broadcast("cleanup",g)}const i=performance.now();console.log(`[Cleanup] Cleanup completed in ${(i-e).toFixed(0)}ms`)}catch(t){console.error("[Cleanup] Error:",t)}},1e4)}}const Cs=C.getInstance();var xs=["<title",">Superstar</title>"],Os=['<head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.svg" type="image/svg+xml">',"","</head>"],Ds=["<html",' lang="en">','<body><div id="app">',"</div><!--$-->","<!--/--></body></html>"];typeof window>"u"&&Cs.initialize();const no=ss(()=>E(_s,{document:({assets:s,children:e,scripts:t})=>v(Ds,A(),E(ut,{get children(){return v(Os,P(E(ht,{get children(){return v(xs,A())}})),P(s))}}),P(e),P(t))}));export{no as default};
