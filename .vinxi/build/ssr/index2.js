import{createComponent as G,ssr as E,ssrHydrationKey as P,escape as e,ssrAttribute as c,ssrStyleProperty as ie,ssrStyle as De,ssrElement as He,mergeProps as Je}from"solid-js/web";import{T as Ye}from"./assets/index-BdnVf8ln.js";import{createSignal as N,createContext as Qe,useContext as Ke,batch as Xe,createEffect as ve,onMount as Se,on as et,Show as ge,onCleanup as be}from"solid-js";import{u as Le}from"./assets/AuthContext-D3kPq5an.js";import{c as ue,B as $}from"./assets/game-eWeYT9Is.js";import{u as tt}from"./assets/UserContext-DYj2Vavi.js";import{u as ot}from"./assets/routing-CWq3BRWv.js";import{inflate as rt}from"pako";const We=Qe();function st(o){const[r,n]=N(null),[s,a]=N([]);return G(We.Provider,{value:{position:r,setPosition:n,restrictedSquares:s,setRestrictedSquares:a},get children(){return o.children}})}function Oe(){const o=Ke(We);if(!o)throw new Error("usePlayerPosition must be used within a PlayerPositionProvider");return o}const nt="_board_n5ult_4",at="_positionIndicator_n5ult_38",it="_boundaryMessage_n5ult_53",ct="_grid_n5ult_91",lt="_square_n5ult_106",dt="_basePoint_n5ult_122",ut="_selected_n5ult_122",ft="_restricted_n5ult_122",gt="_loading_n5ult_11",mt="_basePointMarker_n5ult_212",ht="_emptyMarker_n5ult_225",pt="_errorMessage_n5ult_242",_t="_playerPosition_n5ult_256",F={board:nt,positionIndicator:at,boundaryMessage:it,grid:ct,square:lt,basePoint:dt,selected:ut,restricted:ft,"valid-hover":"_valid-hover_n5ult_141","invalid-hover":"_invalid-hover_n5ult_150",loading:gt,basePointMarker:mt,emptyMarker:ht,errorMessage:pt,playerPosition:_t};var vt=["<button",' class="','">',"</button>"],yt=["<div","></div>"],wt=["<div",">×</div>"];const Tt=o=>{const{position:r,state:n,onHover:s,onClick:a}=o,{x:l,y:p,worldX:h,worldY:g}=r,{isBasePoint:y,isSelected:C,isPlayerPosition:B,isHovered:m,isValid:D,isSaving:q}=n,v=()=>{const O=[F.square];return y&&(O.push(F.basePoint),X(h,g)&&O.push(F.restricted)),C&&O.push(F.selected),B&&O.push(F.playerPosition),q&&m?O.push(F.loading):m&&O.push(D?F["valid-hover"]:F["invalid-hover"]),O.join(" ")},V=(O,R,A,ne)=>{const b=A-O,z=ne-R;return b===0&&z===0?!1:b===0||z===0||b===z||b===-z||z===2*b||b===2*z||z===-2*b||b===-2*z},X=(O,R)=>!!V(O,R,0,0);return E(vt,P(),`${e(v(),!0)||""} ${e(e(F.gridCell,!0),!0)} ${y?e(e(F.basePoint,!0),!0):""} ${C?e(e(F.selected,!0),!0):""} ${B?e(e(F.playerPosition,!0),!0):""} ${m?e(e(F.hovered,!0),!0):""} ${D&&!q?e(e(F.valid,!0),!0):""}`,y?E(yt,P()+c("class",e(F.basePointMarker,!0),!1)):C?e(null):E(wt,P()+c("class",e(F.emptyMarker,!0),!1)))};async function Me(o){try{const n=[];for(let l=0;l<15;l++)for(let p=0;p<15;p++)n.push(l*15+p);const s=await fetch("/api/calculate-squares",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({borderIndices:n,currentPosition:o,direction:"up"})});if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);return(await s.json())?.data?.squares||[]}catch(r){return console.error("Failed to fetch restricted squares:",r),null}}async function $t(o,r,n){try{const s=ue(Math.floor(o),Math.floor(r)),a=await Me(s);return a===null?(console.error("Failed to fetch restricted squares"),null):(n(s),console.log(`Jumped to position: [${o}, ${r}] with ${a.length} restricted squares`),{position:s,restrictedSquares:a})}catch(s){return console.error("Failed to jump to position:",s),null}}function bt(){const{setPosition:o}=Oe();return{jumpToPosition:async(r,n)=>{try{const s=ue(r,n);console.log(`Jumping to position: [${r}, ${n}]`);const a=await Me(s);return a===null?(console.error("Failed to fetch restricted squares"),null):(console.log(`Jumped to position: [${r}, ${n}] with ${a.length} restricted squares`),{restrictedSquares:a})}catch(s){return console.error("Failed to jump to position:",s),null}},fetchRestrictedSquares:Me}}const pe=$.GRID_SIZE,Ie=o=>{const r=pe-1;switch(o){case"top":return Array.from({length:pe},(s,a)=>a);case"bottom":return Array.from({length:pe},(s,a)=>r*pe+a);case"left":return Array.from({length:pe},(s,a)=>a*pe);case"right":return Array.from({length:pe},(s,a)=>a*pe+r);default:return o}},Pe={up:{delta:ue(0,-1),borderIndices:Ie("bottom")},down:{delta:ue(0,1),borderIndices:Ie("top")},left:{delta:ue(-1,0),borderIndices:Ie("right")},right:{delta:ue(1,0),borderIndices:Ie("left")}},St=([o,r],n)=>{const{delta:[s,a]}=Pe[n];return ue(o+s,r+a)},It=(o,r,n)=>o.map(s=>St(s,r)).filter(([s,a])=>s>=0&&s<pe&&a>=0&&a<pe),Ct=async({x:o,y:r,currentUser:n,isSaving:s,setIsSaving:a,setBasePoints:l,isBasePoint:p})=>{if(!n)return{success:!1,error:"User not authenticated",timestamp:Date.now()};if(s())return{success:!1,error:"Operation already in progress",timestamp:Date.now()};if(!Be(o)||!Be(r))return{success:!1,error:`Coordinates must be integers between ${$.WORLD_BOUNDS.MIN_X} and ${$.WORLD_BOUNDS.MAX_X} (inclusive)`,timestamp:Date.now()};const h=await new Promise(g=>{l(y=>(g(y),y))});if(p(o,r,h))return{success:!1,error:"Base point already exists at these coordinates",timestamp:Date.now()};try{a(!0);const g=await fetch("/api/base-points",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:JSON.stringify({x:o,y:r})});if(!g.ok)return{success:!1,error:(await g.json().catch(()=>({}))).error||`Failed to save base point: ${g.status} ${g.statusText}`,timestamp:Date.now()};const y=await g.json();if(!y.success)return{success:!1,error:y.error||"Failed to save base point",timestamp:Date.now()};const C={x:o,y:r,userId:y.data?.userId||n.id,createdAtMs:y.data?.createdAtMs||Date.now(),id:y.data?.id||0};return l(B=>[...B,C]),{success:!0,data:C,timestamp:Date.now()}}catch(g){return{success:!1,error:g instanceof Error?g.message:"Failed to save base point",timestamp:Date.now()}}finally{a(!1)}},Et=(o,r,n)=>{const[s,a]=o,[l,p]=n,h=$.GRID_SIZE,g=h*h-1,y=s+l,C=a+p,B=q=>q>=0&&q<=g,m=(q,v)=>{const V=[];let X=y+q,O=C+v;for(;X>=0&&X<h&&O>=0&&O<h;){const R=X+O*h;B(R)&&V.push(R),X+=q,O+=v}return V},D=[...m(1,0),...m(-1,0),...m(0,1),...m(0,-1),...m(1,-1),...m(-1,-1),...m(1,1),...m(-1,1),...m(2,-1),...m(-2,-1),...m(1,-2),...m(-1,-2),...m(2,1),...m(-2,1),...m(1,2),...m(-1,2)].filter(q=>q!==s+a*h);return[...new Set([...r,...D.filter(q=>q>=0&&q<=g)])]};let xe=0;const Ae=50,Pt=async(o,r)=>{const{isMoving:n,currentPosition:s,setCurrentPosition:a,restrictedSquares:l,setRestrictedSquares:p,setIsMoving:h,isBasePoint:g}=r,y=Date.now(),C=y-xe,B=C<5e3;if(!(n()||B&&C<Ae)){xe=y,h(!0);try{const[m,D]=s(),[q,v]=Pe[o].delta,V=m+q,X=D+v;if(V<$.WORLD_BOUNDS.MIN_X||V>$.WORLD_BOUNDS.MAX_X||X<$.WORLD_BOUNDS.MIN_Y||X>$.WORLD_BOUNDS.MAX_Y)return;const O=ue(V,X),R=Dt([...l()]),A=It(R,o,O),ne=Ne(A);Xe(()=>{a(O),p(J=>[...ne])});const b=[...Pe[o].borderIndices],z=await fetch("/api/calculate-squares",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({borderIndices:b,currentPosition:O,direction:o})});if(!z.ok)throw new Error(`API call failed with status: ${z.status} ${z.statusText}`);const W=await z.json();if(!W.success||!W.data?.squares||!Array.isArray(W.data.squares))throw new Error(`Invalid API response format: ${JSON.stringify(W)}`);const ce=Ne(A),le=ce.filter(J=>W.data.squares.includes(J));if(le.length>0)throw new Error(`Duplicate restricted squares found: ${le.join(", ")}`);const me=[...ce,...W.data.squares],[_e,ee]=s(),ae=me.filter(J=>{const d=J%$.GRID_SIZE,u=Math.floor(J/$.GRID_SIZE),f=d-_e,S=u-ee;return!g(f,S)});p(ae)}catch(m){throw m instanceof Error?m:new Error("Failed to process movement",{cause:m})}finally{const m=Ae-(Date.now()-xe);setTimeout(()=>{h(!1)},Math.max(0,m))}}},Dt=o=>o.map(r=>ue(r%$.GRID_SIZE,Math.floor(r/$.GRID_SIZE))),Ne=o=>o.map(([r,n])=>n*$.GRID_SIZE+r),Be=o=>Number.isInteger(o)&&o>=$.WORLD_BOUNDS.MIN_X&&o<=$.WORLD_BOUNDS.MAX_X,Ee=(o,r,n)=>n.some(s=>s.x===o&&s.y===r),xt=({index:o,currentUser:r,currentPosition:n,basePoints:s,restrictedSquares:a})=>{if(!r)return{isValid:!1,reason:"Not logged in"};const l=o%$.GRID_SIZE,p=Math.floor(o/$.GRID_SIZE),[h,g]=n,y=l-h,C=p-g;return y===0&&C===0?{isValid:!1,reason:"Cannot place on player position"}:Ee(y,C,s)?{isValid:!1,reason:"Base point already exists here"}:a.includes(o)?{isValid:!1,reason:"Cannot place in restricted area"}:{isValid:!0}},Mt=async({user:o,currentPosition:r,lastFetchTime:n,isFetching:s,setBasePoints:a,setLastFetchTime:l,setIsFetching:p})=>{if(!o()){console.log("[Board:fetchBasePoints] setBasePoints([])"),a([]);return}const g=Date.now(),y=g-n();if(console.log("[Board:fetchBasePoints] setIsFetching(true)"),!(s()||y<1e3)){p(!0);try{let[C,B]=r();C=-C,B=-B;const m=await fetch(`/api/base-points?x=${C}&y=${B}`,{credentials:"include",headers:{"Cache-Control":"no-cache",Pragma:"no-cache"}});if(!m.ok)throw new Error(`HTTP error! status: ${m.status}`);const{data:D}=await m.json();if(!D||!Array.isArray(D.basePoints))throw new Error("Invalid response: expected data.basePoints to be an array");const q=D.basePoints;a(q),l(g)}catch(C){console.error("Error fetching base points:",C)}finally{p(!1)}}};var Lt=["<div","><!--$-->","<!--/--><div",">Position: (<!--$-->","<!--/-->, <!--$-->","<!--/-->)</div><div",">","</div><!--$-->","<!--/--></div>"],Ot=["<div",">You've reached the edge of the world!</div>"],At=["<div",">","</div>"];const Nt=()=>{const{user:o}=Le(),r=o(),[n,s]=N(ue($.DEFAULT_POSITION[0],$.DEFAULT_POSITION[1])),[a,l]=N([]);ve(()=>{const d=q();if(d){const[u,f]=d,[S,Y]=n();(u!==S||f!==Y)&&(console.log(`[Board] Syncing position from context: [${u}, ${f}]`),s(ue(u,f)))}});const[p,h]=N(0),[g,y]=N(!1),[C,B]=N(!1),[m,D]=N(!1),{position:q,setPosition:v,restrictedSquares:V,setRestrictedSquares:X}=Oe();Se(async()=>{document.documentElement.style.setProperty("--grid-size",$.GRID_SIZE.toString());try{const d=await $t($.DEFAULT_POSITION[0],$.DEFAULT_POSITION[1],v);if(!d)throw new Error("Failed to initialize game: Could not determine starting position");const{position:u,restrictedSquares:f}=d;s(u),X(f),await me()}catch(d){throw d instanceof Error?new Error(`Failed to initialize game: ${d.message}`):new Error("Failed to initialize game: Unknown error occurred")}});const[O,R]=N(null),[A,ne]=N(null),[b,z]=N(!1),W=d=>xt({index:d,currentUser:r,currentPosition:n(),basePoints:a(),restrictedSquares:V()}),ce=d=>{if(R(d),d===null)ne(null);else{const u=W(d);u.isValid?ne(null):ne(u.reason||"Invalid placement")}};let le=null;const me=async()=>{const d=n(),u=Mt({user:()=>r,currentPosition:()=>d,lastFetchTime:p,isFetching:g,setBasePoints:l,setLastFetchTime:h,setIsFetching:y});return u?(le=u.finally(()=>{le=null}),le):Promise.resolve()};ve(et(()=>o(),d=>{if(d!==void 0){if(!d){X([]);return}me().catch(console.error)}},{defer:!0})),ve(()=>{const[d,u]=n();if(!o())return;console.log(`[Board] Effect1 - Position changed to [${d}, ${u}], fetching base points`);const S=requestIdleCallback(()=>{me().catch(console.error)});return()=>cancelIdleCallback(S)});const _e=d=>{if(!(S=>typeof S=="string"&&S in $.DIRECTION_MAP)(d.key))return;d.preventDefault();const f=$.DIRECTION_MAP[d.key];J(f)},ee=d=>{};Se(()=>{const d=[["keydown",_e],["keyup",ee]];return d.forEach(([u,f])=>{window.addEventListener(u,f)}),()=>{d.forEach(([u,f])=>{window.removeEventListener(u,f)})}});const ae=async d=>{const u=d%$.GRID_SIZE,f=Math.floor(d/$.GRID_SIZE),[S,Y]=n(),Z=u-S,he=f-Y;try{const t=await Ct({x:Z,y:he,currentUser:r,isSaving:m,setIsSaving:D,setBasePoints:l,isBasePoint:(i,_)=>Ee(i,_,a())});if(t.success&&t.data){const i=Et(ue(Z,he),V(),n());X(i)}else t.error&&ne(t.error)}catch(t){const i=t instanceof Error?t.message:"An unknown error occurred";ne(i)}},J=async d=>{z(!1);const u=n(),[f,S]=Pe[d].delta,Y=u[0]+f,Z=u[1]+S,he=ue(Y,Z);if(Y<$.WORLD_BOUNDS.MIN_X||Y>$.WORLD_BOUNDS.MAX_X||Z<$.WORLD_BOUNDS.MIN_Y||Z>$.WORLD_BOUNDS.MAX_Y){z(!0);return}let t=!1;t=!1;try{await Pt(d,{isMoving:C,currentPosition:()=>n(),setCurrentPosition:i=>{if(t)return console.warn("Position already updated, ignoring duplicate update"),he;const _=typeof i=="function"?i(n()):i;s(_),v(_),t=!0},restrictedSquares:V,setRestrictedSquares:X,setIsMoving:B,isBasePoint:(i,_)=>Ee(i,_,a())})}catch(i){throw s(n()),v(n()),i}};return E(Lt,P()+c("class",e(F.board,!0),!1),b()&&E(Ot,P()+c("class",e(F.boundaryMessage,!0),!1)),c("class",e(F.positionIndicator,!0),!1),e(n()[0]),e(n()[1]),c("class",e(F.grid,!0),!1),e(Array.from({length:$.GRID_SIZE*$.GRID_SIZE}).map((d,u)=>{const f=u%$.GRID_SIZE,S=Math.floor(u/$.GRID_SIZE),[Y,Z]=n(),he=f-Y,t=S-Z,i=S*$.GRID_SIZE+f,_=Ee(he,t,a()),I=V().includes(i),w={isBasePoint:_,isSelected:I,isPlayerPosition:he===0&&t===0,isHovered:O()===u,isValid:W(u).isValid&&!m(),isSaving:m()};return G(Tt,{position:{x:f,y:S,worldX:he,worldY:t},state:w,onHover:M=>{ce(M?S*$.GRID_SIZE+f:null)},onClick:M=>{M.stopPropagation(),M.preventDefault(),!(I||m()||_)&&ae(i).catch(T=>console.error("Error processing click:",T))}})})),A()&&E(At,P()+c("class",e(F.errorMessage,!0),!1),e(A())))},Bt="_sidePanel_1sqod_1",qt="_menuToggle_1sqod_16",Rt="_open_1sqod_42",kt="_overlay_1sqod_50",zt="_tabs_1sqod_63",Ut="_tab_1sqod_63",jt="_active_1sqod_84",Vt="_tabContent_1sqod_90",Ft="_notificationsSection_1sqod_143",Gt="_counters_1sqod_158",Xt="_counter_1sqod_158",Wt="_counterNumber_1sqod_182",Zt="_added_1sqod_195",Ht="_deleted_1sqod_204",Jt="_counterLabel_1sqod_208",Yt="_notificationItem_1sqod_241",Qt="_notificationTime_1sqod_253",Kt="_notificationText_1sqod_258",eo="_gameStatusContainer_1sqod_267",to="_infoTab_1sqod_322",oo="_settingsTab_1sqod_328",x={sidePanel:Bt,menuToggle:qt,open:Rt,overlay:kt,tabs:zt,tab:Ut,active:jt,tabContent:Vt,notificationsSection:Ft,counters:Gt,counter:Xt,counterNumber:Wt,added:Zt,deleted:Ht,counterLabel:Jt,notificationItem:Yt,notificationTime:Qt,notificationText:Kt,gameStatusContainer:eo,infoTab:to,settingsTab:oo},ro="_gameStatus_13a4o_3",so="_loading_13a4o_11",no="_errorMessage_13a4o_18",ao="_successMessage_13a4o_28",io="_statusInfo_13a4o_38",co="_isLoading_13a4o_48",lo="_statusRow_13a4o_53",uo="_statusLabel_13a4o_66",fo="_statusValue_13a4o_71",go="_actions_13a4o_76",mo="_joinButton_13a4o_83",ho="_leaveButton_13a4o_84",se={gameStatus:ro,loading:so,errorMessage:no,successMessage:ao,statusInfo:io,isLoading:co,statusRow:lo,statusLabel:uo,statusValue:fo,actions:go,joinButton:mo,leaveButton:ho};var po=["<div",">Loading game status...</div>"],qe=["<div",">","</div>"],_o=["<div","><span",">Home Base:</span><span",">(<!--$-->","<!--/-->, <!--$-->","<!--/-->)</span></div>"],Re=["<button","",">","</button>"],vo=["<div","><!--$-->","<!--/--><!--$-->","<!--/--><!--$-->",'<!--/--><div class="','"><div',"><span",">Game Status:</span><span",">","</span></div><!--$-->","<!--/--></div><div",">","</div></div>"];function yo(){const[o,r]=N({gameJoined:!1,homeX:0,homeY:0,isLoading:!0,error:null,message:null}),n=tt();Le(),ot(),bt();const{setPosition:s,setRestrictedSquares:a}=Oe(),l=h=>{r(g=>({...g,...h,...h.isLoading===!0?{error:null,message:null}:{}}))},p=async()=>{if(!n.user()){l({isLoading:!1,error:"You must be logged in to view game status"});return}l({isLoading:!0});try{const h=await fetch("/api/game/status",{credentials:"include"}),g=await h.json();if(!h.ok)throw new Error(g.error||"Failed to fetch game status");l({isLoading:!1,gameJoined:g.gameJoined,homeX:g.homeX,homeY:g.homeY,message:g.message||null})}catch(h){console.error("Error fetching game status:",h),l({isLoading:!1,error:h instanceof Error?h.message:"Failed to load game status",message:"An error occurred while loading the game status."})}};return Se(()=>{p()}),ve(()=>{n.user()&&p()}),E(vo,P()+c("class",e(se.gameStatus,!0),!1),e(G(ge,{get when(){return o().isLoading},get children(){return E(po,P()+c("class",e(se.loading,!0),!1))}})),e(G(ge,{get when(){return o().error},get children(){return E(qe,P()+c("class",e(se.errorMessage,!0),!1),e(o().error))}})),e(G(ge,{get when(){return o().message&&!o().isLoading},get children(){return E(qe,P()+c("class",e(se.successMessage,!0),!1),e(o().message))}})),`${e(se.statusInfo,!0)||""} ${o().isLoading?e(e(se.isLoading,!0),!0):""}`,c("class",e(se.statusRow,!0),!1),c("class",e(se.statusLabel,!0),!1),c("class",e(se.statusValue,!0),!1),o().gameJoined?"✅ Joined":"❌ Not Joined",e(G(ge,{get when(){return o().gameJoined},get children(){return E(_o,P()+c("class",e(se.statusRow,!0),!1),c("class",e(se.statusLabel,!0),!1),c("class",e(se.statusValue,!0),!1),e(o().homeX),e(o().homeY))}})),c("class",e(se.actions,!0),!1),e(G(ge,{get when(){return o().gameJoined},get fallback(){return E(Re,P(),c("disabled",o().isLoading,!0)+c("class",e(se.joinButton,!0),!1),o().isLoading?"Joining...":"Join Game")},get children(){return E(Re,P(),c("disabled",o().isLoading,!0)+c("class",e(se.leaveButton,!0),!1),o().isLoading?"Leaving...":"Leave Game")}})))}var wo=["<p",">Total base points: <!--$-->","<!--/--></p>"],To=["<div",' style="','"><h4>Oldest Prime Notification</h4><div',"><div",">","</div><div",">","</div></div></div>"],$o=["<div","><h3>Player: <!--$-->","<!--/--></h3><div","><h4>Activity Counters</h4><div","><div",'><span class="','">',"</span><span",">Added</span></div><div",'><span class="','">',"</span><span",">Removed</span></div></div><div","><h3>Game Information</h3><div",">","</div><!--$-->","<!--/--><!--$-->","<!--/--></div></div></div>"];const bo=o=>E($o,P()+c("class",e(x.infoTab,!0),!1),e(o.username),c("class",e(x.notifications,!0),!1),c("class",e(x.counters,!0),!1),c("class",e(x.counter,!0),!1),`${e(x.counterNumber,!0)} ${e(x.added,!0)}`,e(o.addedCount),c("class",e(x.counterLabel,!0),!1),c("class",e(x.counter,!0),!1),`${e(x.counterNumber,!0)} ${e(x.deleted,!0)}`,e(o.deletedCount),c("class",e(x.counterLabel,!0),!1),c("class",e(x.tabContent,!0),!1),c("class",e(x.gameStatusContainer,!0),!1),e(G(yo,{})),e(G(ge,{get when(){return o.totalBasePoints()!==null},get children(){return E(wo,P(),e(o.totalBasePoints()))}})),e(G(ge,{get when(){return o.oldestPrimeNotification},get children(){return E(To,P()+c("class",e(x.notificationsSection,!0),!1),ie("margin-top:","1rem"),c("class",e(x.notificationItem,!0),!1),c("class",e(x.notificationText,!0),!1),e(o.oldestPrimeNotification?.message),c("class",e(x.notificationTime,!0),!1),e(new Date(o.oldestPrimeNotification?.timestamp||0).toLocaleString()))}})));var So=["<div","><h3>Settings</h3><div","><div","><h4>Account</h4><button",">Logout</button></div></div></div>"];const Io=o=>E(So,P()+c("class",e(x.settingsTab,!0),!1),c("class",e(x.settingsContent,!0),!1),c("class",e(x.settingGroup,!0),!1),c("class",e(x.logoutButton,!0),!1));var Co=["<div",' class="','"><div','><button class="','">Info</button><button class="','">Settings</button></div><div',">","</div><button",">",'</button><div class="','"></div></div>'],Eo=["<div",">","</div>"];const Po=o=>{const[r,n]=N([]),[s,a]=N(null),[l,p]=N(0),[h,g]=N(0),[y,C]=N(null),[B,m]=N(null),[D,q]=N(!1);let v=null,V=0;const X=5;let O=!1,R,A;const ne=5e3;let b=!0;const z={},W=()=>{if(V<X){const ee=Math.min(1e3*Math.pow(2,V),3e4);R=setTimeout(()=>{me()},ee)}else console.error("[SSE] Max reconnection attempts reached")},ce=ee=>{try{if(!ee.data||ee.data.trim()==="")return;let ae=ee.type,J={};if(ee.data.startsWith("event: ")){const u=ee.data.match(/^event: (\w+)\s*(\{.*\})?/s);if(u&&(ae=u[1],u[2]))try{J=JSON.parse(u[2].trim())}catch(f){console.error("[SSE] Error parsing message data:",f)}}else try{J=JSON.parse(ee.data)}catch(u){console.error("[SSE] Error parsing message data as JSON:",u);return}if(ae==="ping"||J?.type==="ping")return;const d=J;if(d.type==="basePointChanged"||d.event==="basePointChanged"||d.type==="basePointDeleted"||d.event==="basePointDeleted"){const u=d.point||d;if(u){const f=d.type==="basePointDeleted"||d.event==="basePointDeleted",S=d.count||1;f?g(Z=>Z+(S||1)):p(Z=>Z+(S||1));const Y={id:u.id||Date.now(),message:f?`Removed ${S} base point${S>1?"s":""} at (${u.x}, ${u.y})`:`Added ${S} base point${S>1?"s":""} at (${u.x}, ${u.y})`,timestamp:u.timestamp||Date.now(),userId:u.userId,count:S};(u.isPrime||u.message&&u.message.toLowerCase().includes("prime"))&&a(Z=>!Z||Y.timestamp<Z.timestamp?Y:Z),n(Z=>[Y,...Z].slice(0,50))}}if(d.type==="cleanup"||d.event==="cleanup"){if(d.totalBasePoints!==void 0||d.initialCount!==void 0){const u=d.initialCount!==void 0?d.initialCount:d.totalBasePoints;C(f=>u)}d.oldestPrimeTimestamp!==void 0&&(m(d.oldestPrimeTimestamp),s()||a({id:"system-prime",message:"Initial prime point detected",timestamp:d.oldestPrimeTimestamp}))}else if(d.type==="worldReset"||d.event==="worldReset"){console.log("[World Reset] Received world reset event:",d),C(0),p(0),g(0),a(null);const u={id:Date.now(),message:`World has been reset! ${d.pointsBeforeReset} points were cleared.`,timestamp:Date.now()};n(f=>[u,...f]),d.oldestPrimeTimestamp!==void 0&&m(d.oldestPrimeTimestamp)}}catch(ae){console.error("[SSE] Error processing message:",ae)}},le=()=>{A&&(clearTimeout(A),A=void 0),v&&(v.onopen=null,v.onerror=null,v.onmessage=null,v.close(),v=null)},me=()=>{if(!b)return;le(),R&&(clearTimeout(R),R=void 0);const ae=`/api/events?_=${Date.now()}`;try{v=new EventSource(ae,{withCredentials:!0}),O=!1,A=setTimeout(()=>{b&&v?.readyState===EventSource.CONNECTING&&(console.error("[SSE] Connection timeout - server is not responding"),fetch(v.url,{method:"GET",credentials:"include",headers:{Accept:"text/event-stream","Cache-Control":"no-cache"}}).then(f=>f.text().then(S=>({status:f.status,statusText:f.statusText,headers:Object.fromEntries(f.headers.entries()),text:S.substring(0,200)}))).catch(f=>console.error("[SSE] Test fetch error:",f)).finally(()=>{le(),W()}))},ne),v.onopen=f=>{A&&(clearTimeout(A),A=void 0);const S=new Date().toISOString();O=!0,V=0},v.onmessage=f=>{ce({...f,type:"message",data:f.data})};const J=v;if(!J){console.error("[SSE] Cannot add event listeners: eventSource is null");return}["created","updated","deleted","ping","cleanup"].forEach(f=>{const S=Y=>{ce({...Y,type:Y.type,data:Y.data})};z[f]=S,J.addEventListener(f,S)});const u=()=>{v&&Object.entries(z).forEach(([f,S])=>{v?.removeEventListener(f,S)}),Object.keys(z).forEach(f=>delete z[f])};be(()=>{b=!1,u(),le(),R&&(clearTimeout(R),R=void 0),A&&(clearTimeout(A),A=void 0),v&&(v.close(),v=null)}),v.onerror=f=>{v&&(O=!1,v.readyState,EventSource.CLOSED,W())}}catch(J){console.error("[SSE] Error creating EventSource:",J),W()}};Se(()=>(me(),()=>{if(R&&(clearTimeout(R),R=void 0),v)try{v.removeEventListener("created",ce),v.removeEventListener("updated",ce),v.removeEventListener("deleted",ce),v.readyState!==EventSource.CLOSED&&v.close(),v=null}catch(ee){console.error("Error during cleanup:",ee)}}));const _e=ee=>{};return ve(()=>{D()?document.addEventListener("mousedown",_e):document.removeEventListener("mousedown",_e),be(()=>{document.removeEventListener("mousedown",_e)})}),ve(()=>{D()&&q(!1)}),E(Co,P(),`${e(x.sidePanel,!0)} ${D()?e(x.open,!0):""}`,c("class",e(x.tabs,!0),!1),`${e(x.tab,!0)} ${o.activeTab==="info"?e(x.active,!0):""}`,`${e(x.tab,!0)} ${o.activeTab==="settings"?e(x.active,!0):""}`,c("class",e(x.content,!0),!1),o.activeTab==="info"?E(Eo,P(),e(G(bo,{get username(){return o.username},get addedCount(){return l()},get deletedCount(){return h()},totalBasePoints:y,get oldestPrimeNotification(){return s()}}))):e(G(Io,{get onLogout(){return o.onLogout}})),c("class",e(x.menuToggle,!0),!1),D()?"×":"☰",`${e(x.overlay,!0)} ${D()?e(x.open,!0):""}`)},ke="mapTilesDB",ye="tiles",Ce=1,ze=100;class Ze{db=null;dbName=ke;storeName=ye;isInitialized=!1;initPromise=null;maxAge=30*1e3;refreshThreshold=20*1e3;lastUpdateTime=0;refreshInterval=null;accessTimes=new Map;constructor(){this.init()}async init(){if(console.log("[TileCache] Initializing IndexedDB..."),this.isInitialized){console.log("[TileCache] Already initialized");return}return this.initPromise?(console.log("[TileCache] Initialization already in progress, waiting..."),this.initPromise):(console.log("[TileCache] Starting new initialization"),this.initPromise=new Promise((r,n)=>{if(typeof window>"u"){console.log("[TileCache] Skipping IndexedDB initialization in SSR"),this.isInitialized=!0,r();return}console.log(`[TileCache] Opening IndexedDB: ${this.dbName} v${Ce}`);const s=indexedDB.open(this.dbName,Ce);s.onblocked=a=>{console.error("[TileCache] Database access blocked:",a),n(new Error("Database access is blocked"))},s.onerror=a=>{const l=a.target;console.error("[TileCache] Error opening IndexedDB:",{error:l.error,name:l.error?.name,message:l.error?.message,type:a.type,dbName:this.dbName,version:Ce}),n(l.error||new Error("Unknown error opening database"))},s.onerror=a=>{const l=a.target;console.error("[TileCache] Error opening IndexedDB:",{error:l.error,type:a.type,target:l});const p=l.error||new Error("Unknown error opening IndexedDB");n(p)},s.onsuccess=a=>{const l=a.target.result;if(this.db=l,this.isInitialized=!0,console.log(`[TileCache] Database '${ke}' v${Ce} ready`),console.log("[TileCache] Object stores:",Array.from(l.objectStoreNames)),l.objectStoreNames.contains("tiles")){const g=l.transaction(["tiles"],"readonly").objectStore("tiles").count();g.onsuccess=()=>{console.log(`[TileCache] Found ${g.result} tiles in the store`)},g.onerror=y=>{console.error("[TileCache] Error counting tiles:",y)}}else console.error("[TileCache] Tiles store not found in database!");this.cleanupOldTiles().catch(console.error),r()},s.onupgradeneeded=a=>{const l=a.target.result;if(console.log(`[TileCache] Database upgrade needed for ${this.dbName} v${a.oldVersion} -> v${a.newVersion}`),l.objectStoreNames.contains(this.storeName))console.log(`[TileCache] Object store ${this.storeName} already exists`);else{console.log(`[TileCache] Creating object store: ${this.storeName}`);try{l.createObjectStore(this.storeName,{keyPath:["x","y"]}).createIndex("timestamp","timestamp",{unique:!1}),console.log("[TileCache] Object store and index created")}catch(p){throw console.error("[TileCache] Error creating object store:",p),p}}}}),this.initPromise)}getStore(r){if(typeof window>"u")return console.error("[TileCache] Not in browser environment"),null;if(!this.db)return console.error("[TileCache] Database not initialized"),null;try{const n=this.db.transaction([ye],r);return n.onerror=s=>{console.error("[TileCache] Transaction error:",s.target.error)},n.oncomplete=()=>{},n.onabort=s=>{console.error("[TileCache] Transaction aborted:",s.target.error)},n.objectStore(ye)}catch(n){return console.error("[TileCache] Error getting store:",n),null}}async deleteTile(r,n){return new Promise((s,a)=>{const l=this.getStore("readwrite");if(!l){a(new Error("Failed to get store for deletion"));return}const p=l.delete([r,n]);p.onsuccess=()=>{this.accessTimes.delete(`${r},${n}`),s()},p.onerror=h=>{console.error(`[TileCache] Error deleting tile (${r},${n}):`,h.target.error),a(h.target.error)}})}async getTile(r,n,s=!1){if(!this.isInitialized)try{await this.init()}catch(l){return console.error("[TileCache] Error initializing in getTile:",l),null}if(typeof window>"u"||s)return null;const a=`${r},${n}`;this.accessTimes.set(a,Date.now());try{const l=this.getStore("readonly");if(!l)return console.error("[TileCache] Failed to get store"),null;const p=l.get([r,n]);return new Promise(h=>{p.onsuccess=()=>{const g=p.result;if(!g){h(null);return}Date.now()-g.timestamp>this.maxAge?this.deleteTile(r,n).then(()=>{console.log(`[TileCache] Deleted expired tile (${r},${n})`),h(null)}).catch(B=>{console.error(`[TileCache] Error deleting expired tile (${r},${n}):`,B),h(null)}):h(g)},p.onerror=()=>{console.error(`[TileCache] Error checking tile (${r},${n}):`,p.error),h(null)}})}catch(l){return console.error(`[TileCache] Error in getTile for (${r},${n}):`,l),null}}async setTile(r,n,s,a){if(!this.isInitialized)try{await this.init()}catch(h){throw console.error("[TileCache] Error initializing in setTile:",h),h}this.lastUpdateTime=Date.now();const l=`${r},${n}`;this.accessTimes.set(l,Date.now());const p=await this.getCacheSize();if(p>=ze&&await this.evictLRUTiles(p-ze+1),this.refreshInterval||this.scheduleNextCleanup(),!(typeof window>"u"))return new Promise((h,g)=>{try{const y=this.getStore("readwrite");if(!y){const m=new Error("Failed to access IndexedDB store");console.error("[TileCache]",m),g(m);return}const C={x:r,y:n,data:s,timestamp:Date.now(),etag:a},B=y.put(C);B.onsuccess=()=>{y.get([r,n]).onsuccess=m=>{m.target.result||console.error(`[TileCache] Failed to verify tile (${r}, ${n}) was stored`),h()}},B.onerror=m=>{const D=B.error||new Error("Unknown error setting tile in cache");console.error(`[TileCache] Error storing tile (${r}, ${n}):`,{error:D,event:m.type,target:m.target.result}),g(D)}}catch(y){console.error("Error in setTile:",y),g(y)}})}async clear(){}async cleanupOldTiles(){return new Promise(r=>{if(!this.db){console.log("[TileCache] No database to clean up"),r();return}const a=this.db.transaction([ye],"readwrite").objectStore(ye).index("timestamp"),p=Date.now()-this.maxAge,h=a.openCursor(IDBKeyRange.upperBound(p)),g=[];h.onsuccess=y=>{const C=y.target.result;if(C)g.push([C.value.x,C.value.y]),C.continue();else if(g.length>0){const B=this.db.transaction([ye],"readwrite"),m=B.objectStore(ye);g.forEach(([D,q])=>{m.delete([D,q])}),B.oncomplete=()=>{this.scheduleNextCleanup(),r()},B.onerror=D=>{console.error("[TileCache] Error deleting old tiles:",D),r()}}else this.scheduleNextCleanup(),r()},h.onerror=y=>{console.error("[TileCache] Error cleaning up old tiles:",y),r()}})}async evictLRUTiles(r){if(r<=0)return;const s=Array.from(this.accessTimes.entries()).map(([a,l])=>({key:a,lastAccess:l,coords:a.split(",").map(Number)})).sort((a,l)=>a.lastAccess-l.lastAccess).slice(0,r);for(const{coords:[a,l],key:p}of s)await this.deleteTile(a,l),this.accessTimes.delete(p)}scheduleNextCleanup(){this.refreshInterval&&clearTimeout(this.refreshInterval),this.refreshInterval=window.setTimeout(()=>{this.cleanupOldTiles().catch(console.error)},1e4)}async getCacheSize(){return this.isInitialized||await this.init(),typeof window>"u"?0:new Promise((r,n)=>{try{const s=this.getStore("readonly");if(!s){r(0);return}const a=s.count();a.onsuccess=()=>{r(a.result)},a.onerror=()=>{const l=a.error||new Error("Unknown error getting cache size");console.error("Error getting cache size",l),r(0)}}catch(s){console.error("Error in getCacheSize:",s),r(0)}})}}new Ze;const Do="_mapContainer_10ovn_4",xo="_mapViewport_10ovn_20",Mo="_mapViewportDragging_10ovn_29",Lo="_mapContent_10ovn_35",Oo="_tileContainer_10ovn_59",Ao="_tile_10ovn_59",No="_fallbackTile_10ovn_118",Bo="_loading_10ovn_137",qo="_gridLabel_10ovn_173",Ro="_major_10ovn_188",ko="_zero_10ovn_194",zo="_tileLabel_10ovn_201",Uo="_loadingIndicator_10ovn_218",jo="_spin_10ovn_1",Vo="_tileImage_10ovn_234",Fo="_tileSvg_10ovn_235",Go="_fallbackTileContent_10ovn_285",Xo="_error_10ovn_293",Wo="_gridOverlay_10ovn_321",Zo="_tileImageScaled_10ovn_365",Ho="_tileImageScaledDynamic_10ovn_381",Jo="_tileContent_10ovn_403",Yo="_coordinateLabel_10ovn_411",Qo="_loadingOverlay_10ovn_417",Ko="_errorOverlay_10ovn_418",er="_controls_10ovn_435",tr="_coordinates_10ovn_468",L={mapContainer:Do,mapViewport:xo,mapViewportDragging:Mo,mapContent:Lo,tileContainer:Oo,tile:Ao,fallbackTile:No,loading:Bo,"loading-progress":"_loading-progress_10ovn_1",gridLabel:qo,major:Ro,zero:ko,tileLabel:zo,loadingIndicator:Uo,spin:jo,tileImage:Vo,tileSvg:Fo,fallbackTileContent:Go,error:Xo,gridOverlay:Wo,tileImageScaled:Zo,tileImageScaledDynamic:Ho,tileContent:Jo,coordinateLabel:Yo,loadingOverlay:Qo,errorOverlay:Ko,controls:er,coordinates:tr,"loading-pulse":"_loading-pulse_10ovn_1"};var Ue=["<div","></div>"],je=["<div",' class="','"><div',">Error<div","><!--$-->","<!--/-->,<!--$-->","<!--/--></div></div></div>"],or=["<div",' class="','" style="','"><div',"><div","></div><div","><!--$-->","<!--/-->,<!--$-->","<!--/--></div></div></div>"],Ve=["<div",' style="','"><div',"><div","><!--$-->","<!--/-->,<!--$-->","<!--/--></div></div></div>"],rr=["<div","><svg",' viewBox="','"',">","</svg><div","><!--$-->","<!--/-->,<!--$-->","<!--/--><!--$-->","<!--/--></div></div>"],sr=["<div",' class="','" style="','"',">","</div>"],nr=["<div","><div","><div",' style="','"><div style="','">',"</div></div></div><!--$-->","<!--/--><div","><div",">Position: <!--$-->","<!--/-->, <!--$-->","<!--/--><br>Tiles: <!--$-->","<!--/--></div></div></div>"],ar=["<div",">Loading map...</div>"];const oe=64,we={BATCH_SIZE:4,MAX_TILES_TO_LOAD:30,BATCH_DELAY:100,BATCH_TIMEOUT:5e3,MAX_TILES_IN_MEMORY:50},Fe=800,Ge=600,ir=()=>{const[o,r]=N({}),n=()=>{const t=Fe,i=Ge;return console.log(`width, height: ${t}, ${i}`),{x:0,y:0,width:t,height:i}},[s,a]=N(n());r({});const[l,p]=N(!1),[h,g]=N(null),[y,C]=N({x:0,y:0,startX:0,startY:0}),[B,m]=N(!1),D=new Ze;let q=!1;D.init().then(()=>{q=!0}).catch(t=>{console.error("[MapView] Failed to initialize tile cache:",t)});const[v,V]=N([]),[X,O]=N(!1),R=new Set;let A=null,ne=!1;const[b,z]=N(!1),W=Math.floor(Math.random()*1e6),ce=t=>!t||t.error?!0:Date.now()-t.timestamp>20*1e3,le=()=>{if(!b())return;const t=o();Object.values(t).forEach(i=>{ce(i)&&u(i.x,i.y,!0).catch(_=>{console.error(`[loadVisibleTiles] Error refreshing tile (${i.x}, ${i.y}):`,_)})})};Se(()=>{z(!0),le();const t=setInterval(()=>{b()&&le()},10*1e3);return()=>{clearInterval(t),z(!1)}}),ve(()=>{const t=()=>{if(!b())return;console.log("[MapView] Effect initialLoad");const _=Fe,I=Ge;console.log(`[MapView] Effect initialLoad width: ${_}, height: ${I}`),a(w=>({...w,width:_,height:I}))},i=setTimeout(()=>{b()&&t()},50);be(()=>{clearTimeout(i)})});const me=(t,i,_)=>{const I=[];I.push({x:t,y:i,distance:0});for(let w=1;w<=_;w++){let k=w,M=-w;for(;k>=-w;k--)I.push({x:t+k,y:i+M,distance:w});for(k++,M++;M<=w;M++)I.push({x:t+k,y:i+M,distance:w});for(M--,k++;k<=w;k++)I.push({x:t+k,y:i+M,distance:w});for(k--,M--;M>-w;M--)I.push({x:t+k,y:i+M,distance:w})}return I},_e=t=>{const i=s(),_=Math.floor(Math.abs(i.x)/64),I=Math.floor(Math.abs(i.y)/64);if(_>16||I>16||ne)return;const w=v(),k=w.length;if(k>=we.MAX_TILES_TO_LOAD){ae();return}const M=2,T=J(i.x,i.y),H=me(T.tileX,T.tileY,M),U=[],Q=new Set(w.map(K=>`${K.x},${K.y}`));for(const{x:K,y:re,distance:de}of H){const fe=`${K},${re}`,Te=o()[fe];Te?.data||Te?.loading||Q.has(fe)||U.push({x:K,y:re,priority:de})}console.log(`visibleTiles: ${U}`),U.sort((K,re)=>K.priority-re.priority);const j=Math.max(0,we.MAX_TILES_TO_LOAD-k),te=U.slice(0,j);te.length>0&&(V(K=>{const re=[...K],de=new Set(re.map(fe=>`${fe.x},${fe.y}`));for(const fe of te){const Te=`${fe.x},${fe.y}`;de.has(Te)||(re.push({x:fe.x,y:fe.y}),de.add(Te))}return re}),X()||setTimeout(ae,0))};be(()=>{if(!b())return;ne=!0,z(!1),A!==null&&(clearTimeout(A),A=null);const t=Array.from(R);R.clear(),t.forEach(i=>{try{i.abort()}catch(_){console.warn("Error aborting operation:",_)}}),Xe(()=>{V([]),r({})})});const ee=()=>{if(!b())throw new Error("Cannot create operation - component not mounted");const t=new AbortController;return R.add(t),{signal:t.signal,cleanup:()=>{R.delete(t)}}},ae=async()=>{if(!(X()||!b())){A&&(clearTimeout(A),A=null);try{if(O(!0),!b())return;const t=v();if(t.length===0)return;const i=s(),_=i.width/2,I=i.height/2,w=[...t].sort((U,Q)=>{const j=Math.sqrt(Math.pow(U.x-_,2)+Math.pow(U.y-I,2)),te=Math.sqrt(Math.pow(Q.x-_,2)+Math.pow(Q.y-I,2));return j-te}),k=Math.min(we.BATCH_SIZE,w.length),M=w.slice(0,k),T=M.map(({x:U,y:Q})=>u(U,Q).catch(j=>(b()&&console.error(`[processTileQueue] Error loading tile (${U},${Q}):`,j),null)));if(await Promise.race([Promise.all(T),new Promise(U=>setTimeout(U,we.BATCH_TIMEOUT||5e3))]),!b())return;V(U=>{const Q=new Set(M.map(j=>`${j.x},${j.y}`));return U.filter(j=>!Q.has(`${j.x},${j.y}`))}),v().length>0&&b()?A=window.setTimeout(()=>{b()&&ae()},we.BATCH_DELAY):console.log("[processTileQueue] Queue processing complete")}catch(t){b()&&console.error("[processTileQueue] Error in queue processing:",t)}finally{b()&&O(!1)}}},J=(t,i)=>({tileX:Math.floor(t/oe),tileY:Math.floor(i/oe)}),d=(t,i)=>`${t},${i}`,u=async(t,i,_=!1)=>{const I=o();if(Object.keys(I).length>=we.MAX_TILES_IN_MEMORY){const T=s(),H=Math.floor(T.x/64),U=Math.floor(T.y/64),Q=Object.entries(I).filter(([j,te])=>!te.loading).sort((j,te)=>{const K=Math.abs(j[1].x-H)+Math.abs(j[1].y-U),re=Math.abs(te[1].x-H)+Math.abs(te[1].y-U);return-(K-re)});if(Q.length>0){const[j]=Q[0];r(te=>{const K={...te};return delete K[j],K})}}if(!q)try{await D.init(),q=!0}catch(T){console.error("[loadTile] Error initializing tile cache:",T)}const w=d(t,i);if(I[w]?.loading&&!_||!b())return;if(!_)try{const T=await D.getTile(t,i);if(T){const H=Date.now()-T.timestamp;r(Q=>({...Q,[w]:{x:t,y:i,data:T.data,loading:!1,error:!1,timestamp:Date.now(),mountId:W,fromCache:!0}}));const U=20*1e3;H>U&&u(t,i,!0).catch(console.error);return}}catch(T){console.error(`[loadTile] Error reading from cache for tile (${t}, ${i}):`,T)}r(T=>{const H=T[w];return{...T,[w]:{x:t,y:i,data:H?.data||null,loading:!0,error:!1,timestamp:H?.timestamp||0,mountId:W}}});let M=null;try{const{signal:T,cleanup:H}=ee();M=H;const U=typeof window<"u"?sessionStorage.getItem("token"):null,Q={Accept:"application/json"};U&&(Q.Authorization=`Bearer ${U}`);const j=await fetch(`/api/map/tile/${t}/${i}`,{signal:T,headers:Q,credentials:"include"});if(!j.ok)throw new Error(`HTTP ${j.status}: ${j.statusText}`);const te=await j.json();if(!b()){console.log(`[loadTile] Component unmounted during fetch for tile (${t}, ${i})`);return}if(!te.success||!te.data)throw console.error(`[loadTile] Invalid response format for tile (${t}, ${i}):`,te),new Error("Invalid response format");const K=te.data;let re;if(typeof K.data=="string")try{const de=K.data.split(",").map(Number);if(de.some(isNaN))throw new Error("Invalid number in tile data");re=new Uint8Array(de);try{await D.setTile(t,i,re)}catch(fe){console.error(`[loadTile] Error caching tile (${t}, ${i}):`,fe)}}catch(de){throw console.error("Error parsing tile data:",de),new Error("Failed to parse tile data")}else if(Array.isArray(K.data)){re=new Uint8Array(K.data);try{await D.setTile(t,i,re)}catch(de){console.error(`[loadTile] Error caching tile (${t}, ${i}):`,de)}}else throw new Error("Unexpected tile data format");b()&&r(de=>({...de,[w]:{x:t,y:i,data:re,loading:!1,error:!1,timestamp:Date.now(),mountId:W,fromCache:!1}}))}catch(T){if(T instanceof Error&&T.name==="AbortError")return;b()&&r(H=>({...H,[w]:{...H[w]||{x:t,y:i},loading:!1,error:!0,timestamp:Date.now(),mountId:W}}))}finally{M&&M()}};be(()=>{document.body.style.cursor="",V([]),A&&(clearTimeout(A),A=null)}),ve(()=>{s();const t=setTimeout(()=>{_e()},50);return()=>clearTimeout(t)});const f=(t,i)=>`hsl(${(t*13+i*7)%360}, 70%, ${o()[`${t},${i}`]?.data?"85%":"90%"})`,S=t=>{s();const i=(t.x+16)*oe,_=(t.y+16)*oe,I=Math.round(i),w=Math.round(_),k=I,M=w;let T=E(Ue,P());if(t.error)T=E(je,P(),`${e(L.fallbackTile,!0)} ${e(L.error,!0)}`,c("class",e(L.fallbackTileContent,!0),!1),c("class",e(L.tileCoords,!0),!1),e(t.x),e(t.y));else if(t.loading&&(!t.data||t.data.length===0))T=E(or,P(),`${e(L.fallbackTile,!0)} loading`,De(`--tile-bg-color: ${f(t.x,t.y)}`),c("class",e(L.fallbackTileContent,!0),!1),c("class",e(L.loadingSpinner,!0),!1),c("class",e(L.tileCoords,!0),!1),e(t.x),e(t.y));else if(!t.data||t.data.length===0)T=E(Ve,P()+c("class",e(L.fallbackTile,!0),!1),De(`--tile-bg-color: ${f(t.x,t.y)}`),c("class",e(L.fallbackTileContent,!0),!1),c("class",e(L.tileCoords,!0),!1),e(t.x),e(t.y));else try{const H=Z(t.data);H.length>0?T=E(rr,P()+c("class",e(L.tileContent,!0),!1),c("width",e(oe,!0),!1)+c("height",e(oe,!0),!1),`0 0 ${e(oe,!0)} ${e(oe,!0)}`,c("class",e(L.tileSvg,!0),!1),e(H.map(({x:U,y:Q},j)=>{const te={cx:U+.5,cy:Q+.5,r:2,fill:"black"};return He("circle",Je(te,{key:j}),void 0,!0)})),c("class",e(L.tileLabel,!0),!1),e(t.x),e(t.y),t.loading&&E(Ue,P()+c("class",e(L.loadingIndicator,!0),!1))):T=E(Ve,P()+c("class",e(L.fallbackTile,!0),!1),De(`--tile-bg-color: ${f(t.x,t.y)}`),c("class",e(L.fallbackTileContent,!0),!1),c("class",e(L.tileCoords,!0),!1),e(t.x),e(t.y))}catch(H){console.error("Error rendering tile:",H),T=E(je,P(),`${e(L.fallbackTile,!0)} ${e(L.error,!0)}`,c("class",e(L.fallbackTileContent,!0),!1),c("class",e(L.tileCoords,!0),!1),e(t.x),e(t.y))}return E(sr,P(),`${e(L.tileContainer,!0)} ${e(L.tile,!0)}`,ie("--tile-pos-x:",`${e(k,!0)}px`)+ie(";--tile-pos-y:",`${e(M,!0)}px`)+ie(";--tile-size:",`${e(oe,!0)}px`)+ie(";--tile-base-size:",`${e(oe,!0)}px`),c("data-tile-x",e(t.x,!0),!1)+c("data-tile-y",e(t.y,!0),!1)+c("data-world-x",e(i,!0),!1)+c("data-world-y",e(_,!0),!1)+c("data-pos-x",e(k,!0),!1)+c("data-pos-y",e(M,!0),!1),e(T))},Y=t=>{const i=[];let _=0;for(let I=0;I<t.length&&_<oe*oe;I++){const w=t[I];for(let k=7;k>=0&&_<oe*oe;k--,_++)if(w>>k&1){const M=_%oe,T=Math.floor(_/oe);i.push({x:M,y:T})}}return i},Z=t=>{if(typeof document>"u")return[];if(!(t instanceof Uint8Array)||t.length===0)return console.log("Invalid or empty tile data"),[];if(t[0]!==1)return console.log("Unsupported data format or missing version byte"),[];try{const i=t.subarray(1),_=rt(i),I=Math.ceil(oe*oe/8);return _.length!==I&&console.warn(`Unexpected decompressed size: ${_.length}, expected ${I}`),Y(_)}catch(i){return console.error("Failed to process tile data:",i),[]}},he=()=>{const _=[];for(let I=-16;I<=16;I++)for(let w=-16;w<=16;w++){const k=`${w},${I}`,T=o()[k]||{x:w,y:I,loading:!1,error:!1,data:null,mountId:W,timestamp:Date.now(),fromCache:!1};_.push(S(T))}return _};return E(nr,P()+c("class",e(L.mapContainer,!0),!1),c("class",l()?e(L.mapViewportDragging,!0):e(L.mapViewport,!0),!1),c("class",e(L.mapContent,!0),!1),ie("--translate-x:","0px")+ie(";--translate-y:","0px")+ie(";transform:",`translate(${-s().x-1024}px, ${-s().y-1024}px)`),ie("position:","absolute")+ie(";top:",0)+ie(";left:",0)+ie(";width:","100%")+ie(";height:","100%")+ie(";z-index:",2),e(he()),B()&&E(ar,P()+c("class",e(L.loadingOverlay,!0),!1)),c("class",e(L.controls,!0),!1),c("class",e(L.coordinates,!0),!1),e(Math.round(s().x)),e(Math.round(s().y)),e(Object.keys(o()).length))},cr="_container_5fa2b_3",lr="_gameContainer_5fa2b_11",dr="_gameBoard_5fa2b_60",ur="_loadingContainer_5fa2b_67",fr="_loginContainer_5fa2b_68",$e={container:cr,gameContainer:lr,gameBoard:dr,loadingContainer:ur,loginContainer:fr};var gr=["<div","><!--$-->","<!--/--><div","><!--$-->","<!--/--><!--$-->","<!--/--></div></div>"],mr=["<div","><!--$-->","<!--/--><!--$-->","<!--/--></div>"],hr=["<div","><h1>Loading Game...</h1><div>Initializing authentication...</div></div>"],pr=["<div","><h1>Not Logged In</h1><p>Please log in to access the game.</p></div>"];function Ir(){const{user:o,isInitialized:r,logout:n}=Le(),[s,a]=N("info");return E(mr,P()+c("class",e($e.container,!0),!1),e(G(Ye,{children:"Game"})),e(G(ge,{get when(){return r()},get fallback(){return E(hr,P()+c("class",e($e.loadingContainer,!0),!1))},get children(){return G(ge,{get when(){return o()},get fallback(){return E(pr,P()+c("class",e($e.loginContainer,!0),!1))},get children(){return G(st,{get children(){return E(gr,P()+c("class",e($e.gameContainer,!0),!1),e(G(Po,{get activeTab(){return s()},onTabChange:l=>a(l),get username(){return o().username},get userId(){return o().id},onLogout:n})),c("class",e($e.gameBoard,!0),!1),e(G(ge,{get when(){return s()==="info"},get children(){return G(Nt,{})}})),e(G(ge,{get when(){return s()==="settings"},get children(){return G(ir,{})}})))}})}})}})))}export{Ir as default};
