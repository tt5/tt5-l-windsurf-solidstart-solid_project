import{e as ue,b as ye,w as Vn,x as Yn,h as it,i as te,t as fe,l as U,y as le,z as y,A as En,r as Fe,B as Cn,C as qe,D as tt,o as Wn,v as ee,m as Ye,S as De,F as Nt,G as Jn,f as Qe,H as kn,I as Ae,J as mt,j as Kn,k as Qn,K as Ze,T as eo}from"./index-BtiM2clC.js";import{u as At}from"./AuthContext-CwAE7fDx.js";import{u as to}from"./UserContext-C63u1NZh.js";import{u as no}from"./routing-DQha3BAi.js";const In=Vn();function oo(t){const[n,e]=ue(null),[i,a]=ue([]);return ye(In.Provider,{value:{position:n,setPosition:e,restrictedSquares:i,setRestrictedSquares:a},get children(){return t.children}})}function Mt(){const t=Yn(In);if(!t)throw new Error("usePlayerPosition must be used within a PlayerPositionProvider");return t}const io="_board_n5ult_4",ro="_positionIndicator_n5ult_38",so="_boundaryMessage_n5ult_53",ao="_grid_n5ult_91",lo="_square_n5ult_106",co="_basePoint_n5ult_122",uo="_selected_n5ult_122",fo="_restricted_n5ult_122",ho="_loading_n5ult_11",go="_basePointMarker_n5ult_212",_o="_emptyMarker_n5ult_225",vo="_errorMessage_n5ult_242",mo="_playerPosition_n5ult_256",pe={board:io,positionIndicator:ro,boundaryMessage:so,grid:ao,square:lo,basePoint:co,selected:uo,restricted:fo,"valid-hover":"_valid-hover_n5ult_141","invalid-hover":"_invalid-hover_n5ult_150",loading:ho,basePointMarker:go,emptyMarker:_o,errorMessage:vo,playerPosition:mo};var bo=fe("<button>"),wo=fe("<div>"),xo=fe("<div>×");const $o=t=>{const{position:n,state:e,onHover:i,onClick:a}=t,{x:o,y:f,worldX:l,worldY:b}=n,{isBasePoint:r,isSelected:s,isPlayerPosition:k,isHovered:d,isValid:c,isSaving:w}=e;let z=!0,m=!1,E=0;const P=300,A=g=>{z=g.button===0,m=!0,E=Date.now(),g.preventDefault()},h=g=>{const S=Date.now()-E;m=!1,g.currentTarget&&g.target&&!g.currentTarget.contains(g.target)&&S<P&&(z=!1),g.preventDefault()},C=()=>{i(!1),m&&Date.now()-E<P&&(z=!1)},Y=g=>{g.stopPropagation(),g.preventDefault(),!(!z||s||w||r)&&a(g)},_=()=>{const g=[pe.square];return r&&(g.push(pe.basePoint),x(l,b)&&g.push(pe.restricted)),s&&g.push(pe.selected),k&&g.push(pe.playerPosition),w&&d?g.push(pe.loading):d&&g.push(c?pe["valid-hover"]:pe["invalid-hover"]),g.join(" ")},R=(g,S,oe,he)=>{const v=oe-g,M=he-S;return v===0&&M===0?!1:v===0||M===0||v===M||v===-M||M===2*v||v===2*M||M===-2*v||v===-2*M},x=(g,S)=>!!R(g,S,0,0);return(()=>{var g=te(bo);return g.$$contextmenu=S=>{S.preventDefault(),z=!1},g.addEventListener("mouseenter",()=>i(!0)),g.addEventListener("mouseleave",C),g.$$mouseup=h,g.$$mousedown=A,g.$$click=Y,U(g,r?(()=>{var S=te(wo);return le(()=>y(S,pe.basePointMarker)),S})():s?null:(()=>{var S=te(xo);return le(()=>y(S,pe.emptyMarker)),S})()),le(S=>{var oe=_(),he={[pe.gridCell]:!0,[pe.basePoint]:r,[pe.selected]:s,[pe.playerPosition]:k,[pe.hovered]:d,[pe.valid]:c&&!w};return oe!==S.e&&y(g,S.e=oe),S.t=En(g,he,S.t),S},{e:void 0,t:void 0}),Fe(),g})()};it(["click","mousedown","mouseup","contextmenu"]);function Ee(t,n){return[t,n]}async function kt(t){try{const e=[];for(let o=0;o<15;o++)for(let f=0;f<15;f++)e.push(o*15+f);const i=await fetch("/api/calculate-squares",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({borderIndices:e,currentPosition:t,direction:"up"})});if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);return(await i.json())?.data?.squares||[]}catch(n){return console.error("Failed to fetch restricted squares:",n),null}}async function po(t,n,e){try{const i=Ee(Math.floor(t),Math.floor(n)),a=await kt(i);return a===null?(console.error("Failed to fetch restricted squares"),null):(e(i),console.log(`Jumped to position: [${t}, ${n}] with ${a.length} restricted squares`),{position:i,restrictedSquares:a})}catch(i){return console.error("Failed to jump to position:",i),null}}function yo(){const{setPosition:t}=Mt();return{jumpToPosition:async(n,e)=>{try{const i=Ee(n,e);console.log(`Jumping to position: [${n}, ${e}]`);const a=await kt(i);return a===null?(console.error("Failed to fetch restricted squares"),null):(console.log(`Jumped to position: [${n}, ${e}] with ${a.length} restricted squares`),{restrictedSquares:a})}catch(i){return console.error("Failed to jump to position:",i),null}},fetchRestrictedSquares:kt}}const rt=1e3,Q={GRID_SIZE:15,DEFAULT_POSITION:Ee(0,0),WORLD_BOUNDS:{MIN_X:-rt,MAX_X:rt,MIN_Y:-rt,MAX_Y:rt},DIRECTION_MAP:{ArrowUp:"down",ArrowDown:"up",ArrowLeft:"right",ArrowRight:"left"},BUTTONS:[{label:"Random",className:"randomButton"},{label:"Clear All",className:"clearButton"}],DIRECTIONS:[{key:"up",label:"↑ Up"},{key:"down",label:"↓ Down"},{key:"left",label:"← Left"},{key:"right",label:"→ Right"}]},Oe=Q.GRID_SIZE,st=t=>{const n=Oe-1;switch(t){case"top":return Array.from({length:Oe},(i,a)=>a);case"bottom":return Array.from({length:Oe},(i,a)=>n*Oe+a);case"left":return Array.from({length:Oe},(i,a)=>a*Oe);case"right":return Array.from({length:Oe},(i,a)=>a*Oe+n);default:return t}},ht={up:{delta:Ee(0,-1),borderIndices:st("bottom")},down:{delta:Ee(0,1),borderIndices:st("top")},left:{delta:Ee(-1,0),borderIndices:st("right")},right:{delta:Ee(1,0),borderIndices:st("left")}},So=([t,n],e)=>{const{delta:[i,a]}=ht[e];return Ee(t+i,n+a)},To=(t,n,e)=>t.map(i=>So(i,n)).filter(([i,a])=>i>=0&&i<Oe&&a>=0&&a<Oe),Eo=async({x:t,y:n,currentUser:e,isSaving:i,setIsSaving:a,setBasePoints:o,isBasePoint:f})=>{if(!e)return{success:!1,error:"User not authenticated",timestamp:Date.now()};if(i())return{success:!1,error:"Operation already in progress",timestamp:Date.now()};if(!qt(t)||!qt(n))return{success:!1,error:`Coordinates must be integers between ${Q.WORLD_BOUNDS.MIN_X} and ${Q.WORLD_BOUNDS.MAX_X} (inclusive)`,timestamp:Date.now()};const l=await new Promise(b=>{o(r=>(b(r),r))});if(f(t,n,l))return{success:!1,error:"Base point already exists at these coordinates",timestamp:Date.now()};try{a(!0);const b=await fetch("/api/base-points",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:JSON.stringify({x:t,y:n})});if(!b.ok)return{success:!1,error:(await b.json().catch(()=>({}))).error||`Failed to save base point: ${b.status} ${b.statusText}`,timestamp:Date.now()};const r=await b.json();if(!r.success)return{success:!1,error:r.error||"Failed to save base point",timestamp:Date.now()};const s={x:t,y:n,userId:r.data?.userId||e.id,createdAtMs:r.data?.createdAtMs||Date.now(),id:r.data?.id||0};return o(k=>[...k,s]),{success:!0,data:s,timestamp:Date.now()}}catch(b){return{success:!1,error:b instanceof Error?b.message:"Failed to save base point",timestamp:Date.now()}}finally{a(!1)}},Co=(t,n,e)=>{const[i,a]=t,[o,f]=e,l=Q.GRID_SIZE,b=l*l-1,r=i+o,s=a+f,k=w=>w>=0&&w<=b,d=(w,z)=>{const m=[];let E=r+w,P=s+z;for(;E>=0&&E<l&&P>=0&&P<l;){const A=E+P*l;k(A)&&m.push(A),E+=w,P+=z}return m},c=[...d(1,0),...d(-1,0),...d(0,1),...d(0,-1),...d(1,-1),...d(-1,-1),...d(1,1),...d(-1,1),...d(2,-1),...d(-2,-1),...d(1,-2),...d(-1,-2),...d(2,1),...d(-2,1),...d(1,2),...d(-1,2)].filter(w=>w!==i+a*l);return[...new Set([...n,...c.filter(w=>w>=0&&w<=b)])]};let bt=0;const Bt=50,ko=async(t,n)=>{const{isMoving:e,currentPosition:i,setCurrentPosition:a,restrictedSquares:o,setRestrictedSquares:f,setIsMoving:l,isBasePoint:b}=n,r=Date.now(),s=r-bt,k=s<5e3;if(!(e()||k&&s<Bt)){bt=r,l(!0);try{const[d,c]=i(),[w,z]=ht[t].delta,m=d+w,E=c+z;if(m<Q.WORLD_BOUNDS.MIN_X||m>Q.WORLD_BOUNDS.MAX_X||E<Q.WORLD_BOUNDS.MIN_Y||E>Q.WORLD_BOUNDS.MAX_Y)return;const P=Ee(m,E),A=Io([...o()]),h=To(A,t,P),C=Ut(h);Cn(()=>{a(P),f(M=>[...C])});const Y=[...ht[t].borderIndices],_=await fetch("/api/calculate-squares",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({borderIndices:Y,currentPosition:P,direction:t})});if(!_.ok)throw new Error(`API call failed with status: ${_.status} ${_.statusText}`);const R=await _.json();if(!R.success||!R.data?.squares||!Array.isArray(R.data.squares))throw new Error(`Invalid API response format: ${JSON.stringify(R)}`);const x=Ut(h),g=x.filter(M=>R.data.squares.includes(M));if(g.length>0)throw new Error(`Duplicate restricted squares found: ${g.join(", ")}`);const S=[...x,...R.data.squares],[oe,he]=i(),v=S.filter(M=>{const $=M%Q.GRID_SIZE,T=Math.floor(M/Q.GRID_SIZE),I=$-oe,D=T-he;return!b(I,D)});f(v)}catch(d){throw d instanceof Error?d:new Error("Failed to process movement",{cause:d})}finally{const d=Bt-(Date.now()-bt);setTimeout(()=>{l(!1)},Math.max(0,d))}}},Io=t=>t.map(n=>Ee(n%Q.GRID_SIZE,Math.floor(n/Q.GRID_SIZE))),Ut=t=>t.map(([n,e])=>e*Q.GRID_SIZE+n),qt=t=>Number.isInteger(t)&&t>=Q.WORLD_BOUNDS.MIN_X&&t<=Q.WORLD_BOUNDS.MAX_X,ft=(t,n,e)=>e.some(i=>i.x===t&&i.y===n),Do=({index:t,currentUser:n,currentPosition:e,basePoints:i,restrictedSquares:a})=>{if(!n)return{isValid:!1,reason:"Not logged in"};const o=t%Q.GRID_SIZE,f=Math.floor(t/Q.GRID_SIZE),[l,b]=e,r=o-l,s=f-b;return r===0&&s===0?{isValid:!1,reason:"Cannot place on player position"}:ft(r,s,i)?{isValid:!1,reason:"Base point already exists here"}:a.includes(t)?{isValid:!1,reason:"Cannot place in restricted area"}:{isValid:!0}},Po=async({user:t,currentPosition:n,lastFetchTime:e,isFetching:i,setBasePoints:a,setLastFetchTime:o,setIsFetching:f})=>{if(!t()){console.log("[Board:fetchBasePoints] setBasePoints([])"),a([]);return}const b=Date.now(),r=b-e();if(console.log("[Board:fetchBasePoints] setIsFetching(true)"),!(i()||r<1e3)){f(!0);try{let[s,k]=n();s=-s,k=-k;const d=await fetch(`/api/base-points?x=${s}&y=${k}`,{credentials:"include",headers:{"Cache-Control":"no-cache",Pragma:"no-cache"}});if(!d.ok)throw new Error(`HTTP error! status: ${d.status}`);const{data:c}=await d.json();if(!c||!Array.isArray(c.basePoints))throw new Error("Invalid response: expected data.basePoints to be an array");const w=c.basePoints;a(w),o(b)}catch(s){console.error("Error fetching base points:",s)}finally{f(!1)}}};var Ao=fe("<div><!$><!/><div>Position: (<!$><!/>, <!$><!/>)</div><div></div><!$><!/>"),Mo=fe("<div>You've reached the edge of the world!"),Oo=fe("<div>");const Lo=()=>{const{user:t}=At(),n=t(),[e,i]=ue(Ee(Q.DEFAULT_POSITION[0],Q.DEFAULT_POSITION[1])),[a,o]=ue([]);qe(()=>{const $=w();if($){const[T,I]=$,[D,X]=e();(T!==D||I!==X)&&(console.log(`[Board] Syncing position from context: [${T}, ${I}]`),i(Ee(T,I)))}});const[f,l]=ue(0),[b,r]=ue(!1),[s,k]=ue(!1),[d,c]=ue(!1),{position:w,setPosition:z,restrictedSquares:m,setRestrictedSquares:E}=Mt();tt(async()=>{document.documentElement.style.setProperty("--grid-size",Q.GRID_SIZE.toString());try{const $=await po(Q.DEFAULT_POSITION[0],Q.DEFAULT_POSITION[1],z);if(!$)throw new Error("Failed to initialize game: Could not determine starting position");const{position:T,restrictedSquares:I}=$;i(T),E(I),await S()}catch($){throw $ instanceof Error?new Error(`Failed to initialize game: ${$.message}`):new Error("Failed to initialize game: Unknown error occurred")}});const[P,A]=ue(null),[h,C]=ue(null),[Y,_]=ue(!1),R=$=>Do({index:$,currentUser:n,currentPosition:e(),basePoints:a(),restrictedSquares:m()}),x=$=>{if(A($),$===null)C(null);else{const T=R($);T.isValid?C(null):C(T.reason||"Invalid placement")}};let g=null;const S=async()=>{const $=e(),T=Po({user:()=>n,currentPosition:()=>$,lastFetchTime:f,isFetching:b,setBasePoints:o,setLastFetchTime:l,setIsFetching:r});return T?(g=T.finally(()=>{g=null}),g):Promise.resolve()};qe(Wn(()=>t(),$=>{if($!==void 0){if(!$){E([]);return}S().catch(console.error)}},{defer:!0})),qe(()=>{const[$,T]=e();if(!t())return;console.log(`[Board] Effect1 - Position changed to [${$}, ${T}], fetching base points`);const D=requestIdleCallback(()=>{S().catch(console.error)});return()=>cancelIdleCallback(D)});const oe=$=>{if(!(D=>typeof D=="string"&&D in Q.DIRECTION_MAP)($.key))return;$.preventDefault();const I=Q.DIRECTION_MAP[$.key];M(I)},he=$=>{};tt(()=>{const $=[["keydown",oe],["keyup",he]];return $.forEach(([T,I])=>{window.addEventListener(T,I)}),()=>{$.forEach(([T,I])=>{window.removeEventListener(T,I)})}});const v=async $=>{const T=$%Q.GRID_SIZE,I=Math.floor($/Q.GRID_SIZE),[D,X]=e(),ge=T-D,J=I-X;try{const _e=await Eo({x:ge,y:J,currentUser:n,isSaving:d,setIsSaving:c,setBasePoints:o,isBasePoint:(ve,be)=>ft(ve,be,a())});if(_e.success&&_e.data){const ve=Co(Ee(ge,J),m(),e());E(ve)}else _e.error&&C(_e.error)}catch(_e){const ve=_e instanceof Error?_e.message:"An unknown error occurred";C(ve)}},M=async $=>{_(!1);const T=e(),[I,D]=ht[$].delta,X=T[0]+I,ge=T[1]+D,J=Ee(X,ge);if(X<Q.WORLD_BOUNDS.MIN_X||X>Q.WORLD_BOUNDS.MAX_X||ge<Q.WORLD_BOUNDS.MIN_Y||ge>Q.WORLD_BOUNDS.MAX_Y){_(!0);return}let _e=!1;_e=!1;try{await ko($,{isMoving:s,currentPosition:()=>e(),setCurrentPosition:ve=>{if(_e)return console.warn("Position already updated, ignoring duplicate update"),J;const be=typeof ve=="function"?ve(e()):ve;i(be),z(be),_e=!0},restrictedSquares:m,setRestrictedSquares:E,setIsMoving:k,isBasePoint:(ve,be)=>ft(ve,be,a())})}catch(ve){throw i(e()),z(e()),ve}};return(()=>{var $=te(Ao),T=$.firstChild,[I,D]=ee(T.nextSibling),X=I.nextSibling,ge=X.firstChild,J=ge.nextSibling,[_e,ve]=ee(J.nextSibling),be=_e.nextSibling,Le=be.nextSibling,[Pe,Re]=ee(Le.nextSibling);Pe.nextSibling;var Ue=X.nextSibling,u=Ue.nextSibling,[p,Z]=ee(u.nextSibling);return U($,(()=>{var q=Ye(()=>!!Y());return()=>q()&&(()=>{var L=te(Mo);return le(()=>y(L,pe.boundaryMessage)),L})()})(),I,D),U(X,()=>e()[0],_e,ve),U(X,()=>e()[1],Pe,Re),U(Ue,()=>Array.from({length:Q.GRID_SIZE*Q.GRID_SIZE}).map((q,L)=>{const G=L%Q.GRID_SIZE,W=Math.floor(L/Q.GRID_SIZE),[F,N]=e(),O=G-F,j=W-N,B=W*Q.GRID_SIZE+G,H=ft(O,j,a()),V=m().includes(B),ne={isBasePoint:H,isSelected:V,isPlayerPosition:O===0&&j===0,isHovered:P()===L,isValid:R(L).isValid&&!d(),isSaving:d()};return ye($o,{position:{x:G,y:W,worldX:O,worldY:j},state:ne,onHover:se=>{x(se?W*Q.GRID_SIZE+G:null)},onClick:se=>{se.stopPropagation(),se.preventDefault(),!(V||d()||H)&&v(B).catch(we=>console.error("Error processing click:",we))}})})),U($,(()=>{var q=Ye(()=>!!h());return()=>q()&&(()=>{var L=te(Oo);return U(L,h),le(()=>y(L,pe.errorMessage)),L})()})(),p,Z),le(q=>{var L=pe.board,G=pe.positionIndicator,W=pe.grid;return L!==q.e&&y($,q.e=L),G!==q.t&&y(X,q.t=G),W!==q.a&&y(Ue,q.a=W),q},{e:void 0,t:void 0,a:void 0}),$})()},Ro="_sidePanel_1sqod_1",No="_menuToggle_1sqod_16",Bo="_open_1sqod_42",Uo="_overlay_1sqod_50",qo="_tabs_1sqod_63",zo="_tab_1sqod_63",Zo="_active_1sqod_84",jo="_tabContent_1sqod_90",Fo="_notificationsSection_1sqod_143",Xo="_counters_1sqod_158",Go="_counter_1sqod_158",Ho="_counterNumber_1sqod_182",Vo="_added_1sqod_195",Yo="_deleted_1sqod_204",Wo="_counterLabel_1sqod_208",Jo="_notificationItem_1sqod_241",Ko="_notificationTime_1sqod_253",Qo="_notificationText_1sqod_258",ei="_gameStatusContainer_1sqod_267",ti="_infoTab_1sqod_322",ni="_settingsTab_1sqod_328",re={sidePanel:Ro,menuToggle:No,open:Bo,overlay:Uo,tabs:qo,tab:zo,active:Zo,tabContent:jo,notificationsSection:Fo,counters:Xo,counter:Go,counterNumber:Ho,added:Vo,deleted:Yo,counterLabel:Wo,notificationItem:Jo,notificationTime:Ko,notificationText:Qo,gameStatusContainer:ei,infoTab:ti,settingsTab:ni},oi="_gameStatus_13a4o_3",ii="_loading_13a4o_11",ri="_errorMessage_13a4o_18",si="_successMessage_13a4o_28",ai="_statusInfo_13a4o_38",li="_isLoading_13a4o_48",ci="_statusRow_13a4o_53",di="_statusLabel_13a4o_66",ui="_statusValue_13a4o_71",fi="_actions_13a4o_76",hi="_joinButton_13a4o_83",gi="_leaveButton_13a4o_84",Te={gameStatus:oi,loading:ii,errorMessage:ri,successMessage:si,statusInfo:ai,isLoading:li,statusRow:ci,statusLabel:di,statusValue:ui,actions:fi,joinButton:hi,leaveButton:gi};var _i=fe("<div>Loading game status..."),zt=fe("<div>"),vi=fe("<div><span>Home Base:</span><span>(<!$><!/>, <!$><!/>)"),Zt=fe("<button>"),mi=fe("<div><!$><!/><!$><!/><!$><!/><div><div><span>Game Status:</span><span></span></div><!$><!/></div><div>");function bi(){const[t,n]=ue({gameJoined:!1,homeX:0,homeY:0,isLoading:!0,error:null,message:null}),e=to(),i=At(),a=no(),{jumpToPosition:o}=yo(),{setPosition:f,setRestrictedSquares:l}=Mt(),b=d=>{n(c=>({...c,...d,...d.isLoading===!0?{error:null,message:null}:{}}))},r=async()=>{if(!e.user()){b({isLoading:!1,error:"You must be logged in to view game status"});return}b({isLoading:!0});try{const d=await fetch("/api/game/status",{credentials:"include"}),c=await d.json();if(!d.ok)throw new Error(c.error||"Failed to fetch game status");b({isLoading:!1,gameJoined:c.gameJoined,homeX:c.homeX,homeY:c.homeY,message:c.message||null})}catch(d){console.error("Error fetching game status:",d),b({isLoading:!1,error:d instanceof Error?d.message:"Failed to load game status",message:"An error occurred while loading the game status."})}},s=async()=>{if(!i.user()){console.log("User is not logged in");const d=window.location.pathname+window.location.search;a(`/login?returnUrl=${encodeURIComponent(d)}`);return}b({isLoading:!0});try{const d=await fetch("/api/game/join",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"}}),c=await d.json();if(!d.ok)throw new Error(c.error||"Failed to join game");if(b({isLoading:!1,gameJoined:c.gameJoined,homeX:c.homeX,homeY:c.homeY,message:c.message||"Successfully joined the game!"}),typeof c.homeX=="number"&&typeof c.homeY=="number")try{const w=Ee(-c.homeX,-c.homeY);f(w);const z=await o(-c.homeX,-c.homeY);z&&l(z.restrictedSquares)}catch(w){console.error("Failed to jump to home base:",w)}}catch(d){console.error("Error joining game:",d),b({isLoading:!1,error:d instanceof Error?d.message:"Failed to join game",message:"An error occurred while joining the game."})}},k=async()=>{if(e.user()&&confirm("Are you sure you want to leave the game? Your base will remain but you won't be able to add new base points.")){b({isLoading:!0});try{const d=await fetch("/api/game/leave",{method:"POST",headers:{"Content-Type":"application/json"}}),c=await d.json();if(!d.ok)throw new Error(c.error||"Failed to leave game");b({isLoading:!1,gameJoined:!1,message:c.message||"Successfully left the game."}),setTimeout(()=>{window.location.reload()},1500)}catch(d){console.error("Error leaving game:",d),b({isLoading:!1,error:d instanceof Error?d.message:"Failed to leave game",message:"An error occurred while leaving the game."})}}};return tt(()=>{r()}),qe(()=>{e.user()&&r()}),(()=>{var d=te(mi),c=d.firstChild,[w,z]=ee(c.nextSibling),m=w.nextSibling,[E,P]=ee(m.nextSibling),A=E.nextSibling,[h,C]=ee(A.nextSibling),Y=h.nextSibling,_=Y.firstChild,R=_.firstChild,x=R.nextSibling,g=_.nextSibling,[S,oe]=ee(g.nextSibling),he=Y.nextSibling;return U(d,ye(De,{get when(){return t().isLoading},get children(){var v=te(_i);return le(()=>y(v,Te.loading)),v}}),w,z),U(d,ye(De,{get when(){return t().error},get children(){var v=te(zt);return U(v,()=>t().error),le(()=>y(v,Te.errorMessage)),v}}),E,P),U(d,ye(De,{get when(){return Ye(()=>!!t().message)()&&!t().isLoading},get children(){var v=te(zt);return U(v,()=>t().message),le(()=>y(v,Te.successMessage)),v}}),h,C),U(x,()=>t().gameJoined?"✅ Joined":"❌ Not Joined"),U(Y,ye(De,{get when(){return t().gameJoined},get children(){var v=te(vi),M=v.firstChild,$=M.nextSibling,T=$.firstChild,I=T.nextSibling,[D,X]=ee(I.nextSibling),ge=D.nextSibling,J=ge.nextSibling,[_e,ve]=ee(J.nextSibling);return _e.nextSibling,U($,()=>t().homeX,D,X),U($,()=>t().homeY,_e,ve),le(be=>{var Le=Te.statusRow,Pe=Te.statusLabel,Re=Te.statusValue;return Le!==be.e&&y(v,be.e=Le),Pe!==be.t&&y(M,be.t=Pe),Re!==be.a&&y($,be.a=Re),be},{e:void 0,t:void 0,a:void 0}),v}}),S,oe),U(he,ye(De,{get when(){return t().gameJoined},get fallback(){return(()=>{var v=te(Zt);return v.$$click=s,U(v,()=>t().isLoading?"Joining...":"Join Game"),le(M=>{var $=t().isLoading,T=Te.joinButton;return $!==M.e&&Nt(v,"disabled",M.e=$),T!==M.t&&y(v,M.t=T),M},{e:void 0,t:void 0}),Fe(),v})()},get children(){var v=te(Zt);return v.$$click=k,U(v,()=>t().isLoading?"Leaving...":"Leave Game"),le(M=>{var $=t().isLoading,T=Te.leaveButton;return $!==M.e&&Nt(v,"disabled",M.e=$),T!==M.t&&y(v,M.t=T),M},{e:void 0,t:void 0}),Fe(),v}})),le(v=>{var M=Te.gameStatus,$=Te.statusInfo,T={[Te.isLoading]:t().isLoading},I=Te.statusRow,D=Te.statusLabel,X=Te.statusValue,ge=Te.actions;return M!==v.e&&y(d,v.e=M),$!==v.t&&y(Y,v.t=$),v.a=En(Y,T,v.a),I!==v.o&&y(_,v.o=I),D!==v.i&&y(R,v.i=D),X!==v.n&&y(x,v.n=X),ge!==v.s&&y(he,v.s=ge),v},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0}),d})()}it(["click"]);var wi=fe("<p>Total base points: <!$><!/>"),xi=fe("<div style=margin-top:1rem><h4>Oldest Prime Notification</h4><div><div></div><div>"),$i=fe("<div><h3>Player: <!$><!/></h3><div><h4>Activity Counters</h4><div><div><span></span><span>Added</span></div><div><span></span><span>Removed</span></div></div><div><h3>Game Information</h3><div></div><!$><!/><!$><!/>");const pi=t=>(()=>{var n=te($i),e=n.firstChild,i=e.firstChild,a=i.nextSibling,[o,f]=ee(a.nextSibling),l=e.nextSibling,b=l.firstChild,r=b.nextSibling,s=r.firstChild,k=s.firstChild,d=k.nextSibling,c=s.nextSibling,w=c.firstChild,z=w.nextSibling,m=r.nextSibling,E=m.firstChild,P=E.nextSibling,A=P.nextSibling,[h,C]=ee(A.nextSibling),Y=h.nextSibling,[_,R]=ee(Y.nextSibling);return U(e,()=>t.username,o,f),U(k,()=>t.addedCount),U(w,()=>t.deletedCount),U(P,ye(bi,{})),U(m,ye(De,{get when(){return t.totalBasePoints()!==null},get children(){var x=te(wi),g=x.firstChild,S=g.nextSibling,[oe,he]=ee(S.nextSibling);return U(x,()=>t.totalBasePoints(),oe,he),x}}),h,C),U(m,ye(De,{get when(){return t.oldestPrimeNotification},get children(){var x=te(xi),g=x.firstChild,S=g.nextSibling,oe=S.firstChild,he=oe.nextSibling;return U(oe,()=>t.oldestPrimeNotification?.message),U(he,()=>new Date(t.oldestPrimeNotification?.timestamp||0).toLocaleString()),le(v=>{var M=re.notificationsSection,$=re.notificationItem,T=re.notificationText,I=re.notificationTime;return M!==v.e&&y(x,v.e=M),$!==v.t&&y(S,v.t=$),T!==v.a&&y(oe,v.a=T),I!==v.o&&y(he,v.o=I),v},{e:void 0,t:void 0,a:void 0,o:void 0}),x}}),_,R),le(x=>{var g=re.infoTab,S=re.notifications,oe=re.counters,he=re.counter,v=`${re.counterNumber} ${re.added}`,M=re.counterLabel,$=re.counter,T=`${re.counterNumber} ${re.deleted}`,I=re.counterLabel,D=re.tabContent,X=re.gameStatusContainer;return g!==x.e&&y(n,x.e=g),S!==x.t&&y(l,x.t=S),oe!==x.a&&y(r,x.a=oe),he!==x.o&&y(s,x.o=he),v!==x.i&&y(k,x.i=v),M!==x.n&&y(d,x.n=M),$!==x.s&&y(c,x.s=$),T!==x.h&&y(w,x.h=T),I!==x.r&&y(z,x.r=I),D!==x.d&&y(m,x.d=D),X!==x.l&&y(P,x.l=X),x},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0,r:void 0,d:void 0,l:void 0}),n})();var yi=fe("<div><h3>Settings</h3><div><div><h4>Account</h4><button>Logout");const Si=t=>(()=>{var n=te(yi),e=n.firstChild,i=e.nextSibling,a=i.firstChild,o=a.firstChild,f=o.nextSibling;return Jn(f,"click",t.onLogout,!0),le(l=>{var b=re.settingsTab,r=re.settingsContent,s=re.settingGroup,k=re.logoutButton;return b!==l.e&&y(n,l.e=b),r!==l.t&&y(i,l.t=r),s!==l.a&&y(a,l.a=s),k!==l.o&&y(f,l.o=k),l},{e:void 0,t:void 0,a:void 0,o:void 0}),Fe(),n})();it(["click"]);var Ti=fe("<div><div><button>Info</button><button>Settings</button></div><div></div><button></button><div>"),Ei=fe("<div>");const Ci=t=>{const[n,e]=ue([]),[i,a]=ue(null),[o,f]=ue(0),[l,b]=ue(0),[r,s]=ue(null),[k,d]=ue(null),[c,w]=ue(!1);let z,m=null,E=0;const P=5;let A=!1,h,C;const Y=5e3;let _=!0;const R={},x=()=>{if(E<P){const v=Math.min(1e3*Math.pow(2,E),3e4);h=setTimeout(()=>{oe()},v)}else console.error("[SSE] Max reconnection attempts reached")},g=v=>{try{if(!v.data||v.data.trim()==="")return;let M=v.type,$={};if(v.data.startsWith("event: ")){const I=v.data.match(/^event: (\w+)\s*(\{.*\})?/s);if(I&&(M=I[1],I[2]))try{$=JSON.parse(I[2].trim())}catch(D){console.error("[SSE] Error parsing message data:",D)}}else try{$=JSON.parse(v.data)}catch(I){console.error("[SSE] Error parsing message data as JSON:",I);return}if(M==="ping"||$?.type==="ping")return;const T=$;if(T.type==="basePointChanged"||T.event==="basePointChanged"||T.type==="basePointDeleted"||T.event==="basePointDeleted"){const I=T.point||T;if(I){const D=T.type==="basePointDeleted"||T.event==="basePointDeleted",X=T.count||1;D?b(J=>J+(X||1)):f(J=>J+(X||1));const ge={id:I.id||Date.now(),message:D?`Removed ${X} base point${X>1?"s":""} at (${I.x}, ${I.y})`:`Added ${X} base point${X>1?"s":""} at (${I.x}, ${I.y})`,timestamp:I.timestamp||Date.now(),userId:I.userId,count:X};(I.isPrime||I.message&&I.message.toLowerCase().includes("prime"))&&a(J=>!J||ge.timestamp<J.timestamp?ge:J),e(J=>[ge,...J].slice(0,50))}}if(T.type==="cleanup"||T.event==="cleanup"){if(T.totalBasePoints!==void 0||T.initialCount!==void 0){const I=T.initialCount!==void 0?T.initialCount:T.totalBasePoints;s(D=>I)}T.oldestPrimeTimestamp!==void 0&&(d(T.oldestPrimeTimestamp),i()||a({id:"system-prime",message:"Initial prime point detected",timestamp:T.oldestPrimeTimestamp}))}else if(T.type==="worldReset"||T.event==="worldReset"){console.log("[World Reset] Received world reset event:",T),s(0),f(0),b(0),a(null);const I={id:Date.now(),message:`World has been reset! ${T.pointsBeforeReset} points were cleared.`,timestamp:Date.now()};e(D=>[I,...D]),T.oldestPrimeTimestamp!==void 0&&d(T.oldestPrimeTimestamp)}}catch(M){console.error("[SSE] Error processing message:",M)}},S=()=>{C&&(clearTimeout(C),C=void 0),m&&(m.onopen=null,m.onerror=null,m.onmessage=null,m.close(),m=null)},oe=()=>{if(!_)return;S(),h&&(clearTimeout(h),h=void 0);const M=`/api/events?_=${Date.now()}`;try{m=new EventSource(M,{withCredentials:!0}),A=!1,C=setTimeout(()=>{_&&m?.readyState===EventSource.CONNECTING&&(console.error("[SSE] Connection timeout - server is not responding"),fetch(m.url,{method:"GET",credentials:"include",headers:{Accept:"text/event-stream","Cache-Control":"no-cache"}}).then(D=>D.text().then(X=>({status:D.status,statusText:D.statusText,headers:Object.fromEntries(D.headers.entries()),text:X.substring(0,200)}))).catch(D=>console.error("[SSE] Test fetch error:",D)).finally(()=>{S(),x()}))},Y),m.onopen=D=>{C&&(clearTimeout(C),C=void 0);const X=new Date().toISOString();A=!0,E=0},m.onmessage=D=>{g({...D,type:"message",data:D.data})};const $=m;if(!$){console.error("[SSE] Cannot add event listeners: eventSource is null");return}["created","updated","deleted","ping","cleanup"].forEach(D=>{const X=ge=>{g({...ge,type:ge.type,data:ge.data})};R[D]=X,$.addEventListener(D,X)});const I=()=>{m&&Object.entries(R).forEach(([D,X])=>{m?.removeEventListener(D,X)}),Object.keys(R).forEach(D=>delete R[D])};Qe(()=>{_=!1,I(),S(),h&&(clearTimeout(h),h=void 0),C&&(clearTimeout(C),C=void 0),m&&(m.close(),m=null)}),m.onerror=D=>{m&&(A=!1,m.readyState,EventSource.CLOSED,x())}}catch($){console.error("[SSE] Error creating EventSource:",$),x()}};tt(()=>(oe(),()=>{if(h&&(clearTimeout(h),h=void 0),m)try{m.removeEventListener("created",g),m.removeEventListener("updated",g),m.removeEventListener("deleted",g),m.readyState!==EventSource.CLOSED&&m.close(),m=null}catch(v){console.error("Error during cleanup:",v)}}));const he=v=>{z&&!z.contains(v.target)&&w(!1)};return qe(()=>{c()?document.addEventListener("mousedown",he):document.removeEventListener("mousedown",he),Qe(()=>{document.removeEventListener("mousedown",he)})}),qe(()=>{c()&&w(!1)}),(()=>{var v=te(Ti),M=v.firstChild,$=M.firstChild,T=$.nextSibling,I=M.nextSibling,D=I.nextSibling,X=D.nextSibling,ge=z;return typeof ge=="function"?kn(ge,v):z=v,$.$$click=()=>t.onTabChange("info"),T.$$click=()=>t.onTabChange("settings"),U(I,(()=>{var J=Ye(()=>t.activeTab==="info");return()=>J()?(()=>{var _e=te(Ei);return U(_e,ye(pi,{get username(){return t.username},get addedCount(){return o()},get deletedCount(){return l()},totalBasePoints:r,get oldestPrimeNotification(){return i()}})),_e})():ye(Si,{get onLogout(){return t.onLogout}})})()),D.$$click=()=>w(!c()),U(D,()=>c()?"×":"☰"),X.$$click=()=>w(!1),le(J=>{var _e=`${re.sidePanel} ${c()?re.open:""}`,ve=re.tabs,be=`${re.tab} ${t.activeTab==="info"?re.active:""}`,Le=`${re.tab} ${t.activeTab==="settings"?re.active:""}`,Pe=re.content,Re=re.menuToggle,Ue=`${re.overlay} ${c()?re.open:""}`;return _e!==J.e&&y(v,J.e=_e),ve!==J.t&&y(M,J.t=ve),be!==J.a&&y($,J.a=be),Le!==J.o&&y(T,J.o=Le),Pe!==J.i&&y(I,J.i=Pe),Re!==J.n&&y(D,J.n=Re),Ue!==J.s&&y(X,J.s=Ue),J},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0}),Fe(),v})()};it(["click"]);function We(t){let n=t.length;for(;--n>=0;)t[n]=0}const ki=3,Ii=258,Dn=29,Di=256,Pi=Di+1+Dn,Pn=30,Ai=512,Mi=new Array((Pi+2)*2);We(Mi);const Oi=new Array(Pn*2);We(Oi);const Li=new Array(Ai);We(Li);const Ri=new Array(Ii-ki+1);We(Ri);const Ni=new Array(Dn);We(Ni);const Bi=new Array(Pn);We(Bi);const Ui=(t,n,e,i)=>{let a=t&65535|0,o=t>>>16&65535|0,f=0;for(;e!==0;){f=e>2e3?2e3:e,e-=f;do a=a+n[i++]|0,o=o+a|0;while(--f);a%=65521,o%=65521}return a|o<<16|0};var It=Ui;const qi=()=>{let t,n=[];for(var e=0;e<256;e++){t=e;for(var i=0;i<8;i++)t=t&1?3988292384^t>>>1:t>>>1;n[e]=t}return n},zi=new Uint32Array(qi()),Zi=(t,n,e,i)=>{const a=zi,o=i+e;t^=-1;for(let f=i;f<o;f++)t=t>>>8^a[(t^n[f])&255];return t^-1};var Me=Zi,Dt={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},An={Z_NO_FLUSH:0,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_DEFLATED:8};const ji=(t,n)=>Object.prototype.hasOwnProperty.call(t,n);var Fi=function(t){const n=Array.prototype.slice.call(arguments,1);for(;n.length;){const e=n.shift();if(e){if(typeof e!="object")throw new TypeError(e+"must be non-object");for(const i in e)ji(e,i)&&(t[i]=e[i])}}return t},Xi=t=>{let n=0;for(let i=0,a=t.length;i<a;i++)n+=t[i].length;const e=new Uint8Array(n);for(let i=0,a=0,o=t.length;i<o;i++){let f=t[i];e.set(f,a),a+=f.length}return e},Mn={assign:Fi,flattenChunks:Xi};let On=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{On=!1}const nt=new Uint8Array(256);for(let t=0;t<256;t++)nt[t]=t>=252?6:t>=248?5:t>=240?4:t>=224?3:t>=192?2:1;nt[254]=nt[254]=1;var Gi=t=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(t);let n,e,i,a,o,f=t.length,l=0;for(a=0;a<f;a++)e=t.charCodeAt(a),(e&64512)===55296&&a+1<f&&(i=t.charCodeAt(a+1),(i&64512)===56320&&(e=65536+(e-55296<<10)+(i-56320),a++)),l+=e<128?1:e<2048?2:e<65536?3:4;for(n=new Uint8Array(l),o=0,a=0;o<l;a++)e=t.charCodeAt(a),(e&64512)===55296&&a+1<f&&(i=t.charCodeAt(a+1),(i&64512)===56320&&(e=65536+(e-55296<<10)+(i-56320),a++)),e<128?n[o++]=e:e<2048?(n[o++]=192|e>>>6,n[o++]=128|e&63):e<65536?(n[o++]=224|e>>>12,n[o++]=128|e>>>6&63,n[o++]=128|e&63):(n[o++]=240|e>>>18,n[o++]=128|e>>>12&63,n[o++]=128|e>>>6&63,n[o++]=128|e&63);return n};const Hi=(t,n)=>{if(n<65534&&t.subarray&&On)return String.fromCharCode.apply(null,t.length===n?t:t.subarray(0,n));let e="";for(let i=0;i<n;i++)e+=String.fromCharCode(t[i]);return e};var Vi=(t,n)=>{const e=n||t.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(t.subarray(0,n));let i,a;const o=new Array(e*2);for(a=0,i=0;i<e;){let f=t[i++];if(f<128){o[a++]=f;continue}let l=nt[f];if(l>4){o[a++]=65533,i+=l-1;continue}for(f&=l===2?31:l===3?15:7;l>1&&i<e;)f=f<<6|t[i++]&63,l--;if(l>1){o[a++]=65533;continue}f<65536?o[a++]=f:(f-=65536,o[a++]=55296|f>>10&1023,o[a++]=56320|f&1023)}return Hi(o,a)},Yi=(t,n)=>{n=n||t.length,n>t.length&&(n=t.length);let e=n-1;for(;e>=0&&(t[e]&192)===128;)e--;return e<0||e===0?n:e+nt[t[e]]>n?e:n},Pt={string2buf:Gi,buf2string:Vi,utf8border:Yi};function Wi(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}var Ji=Wi;const at=16209,Ki=16191;var Qi=function(n,e){let i,a,o,f,l,b,r,s,k,d,c,w,z,m,E,P,A,h,C,Y,_,R,x,g;const S=n.state;i=n.next_in,x=n.input,a=i+(n.avail_in-5),o=n.next_out,g=n.output,f=o-(e-n.avail_out),l=o+(n.avail_out-257),b=S.dmax,r=S.wsize,s=S.whave,k=S.wnext,d=S.window,c=S.hold,w=S.bits,z=S.lencode,m=S.distcode,E=(1<<S.lenbits)-1,P=(1<<S.distbits)-1;e:do{w<15&&(c+=x[i++]<<w,w+=8,c+=x[i++]<<w,w+=8),A=z[c&E];t:for(;;){if(h=A>>>24,c>>>=h,w-=h,h=A>>>16&255,h===0)g[o++]=A&65535;else if(h&16){C=A&65535,h&=15,h&&(w<h&&(c+=x[i++]<<w,w+=8),C+=c&(1<<h)-1,c>>>=h,w-=h),w<15&&(c+=x[i++]<<w,w+=8,c+=x[i++]<<w,w+=8),A=m[c&P];n:for(;;){if(h=A>>>24,c>>>=h,w-=h,h=A>>>16&255,h&16){if(Y=A&65535,h&=15,w<h&&(c+=x[i++]<<w,w+=8,w<h&&(c+=x[i++]<<w,w+=8)),Y+=c&(1<<h)-1,Y>b){n.msg="invalid distance too far back",S.mode=at;break e}if(c>>>=h,w-=h,h=o-f,Y>h){if(h=Y-h,h>s&&S.sane){n.msg="invalid distance too far back",S.mode=at;break e}if(_=0,R=d,k===0){if(_+=r-h,h<C){C-=h;do g[o++]=d[_++];while(--h);_=o-Y,R=g}}else if(k<h){if(_+=r+k-h,h-=k,h<C){C-=h;do g[o++]=d[_++];while(--h);if(_=0,k<C){h=k,C-=h;do g[o++]=d[_++];while(--h);_=o-Y,R=g}}}else if(_+=k-h,h<C){C-=h;do g[o++]=d[_++];while(--h);_=o-Y,R=g}for(;C>2;)g[o++]=R[_++],g[o++]=R[_++],g[o++]=R[_++],C-=3;C&&(g[o++]=R[_++],C>1&&(g[o++]=R[_++]))}else{_=o-Y;do g[o++]=g[_++],g[o++]=g[_++],g[o++]=g[_++],C-=3;while(C>2);C&&(g[o++]=g[_++],C>1&&(g[o++]=g[_++]))}}else if((h&64)===0){A=m[(A&65535)+(c&(1<<h)-1)];continue n}else{n.msg="invalid distance code",S.mode=at;break e}break}}else if((h&64)===0){A=z[(A&65535)+(c&(1<<h)-1)];continue t}else if(h&32){S.mode=Ki;break e}else{n.msg="invalid literal/length code",S.mode=at;break e}break}}while(i<a&&o<l);C=w>>3,i-=C,w-=C<<3,c&=(1<<w)-1,n.next_in=i,n.next_out=o,n.avail_in=i<a?5+(a-i):5-(i-a),n.avail_out=o<l?257+(l-o):257-(o-l),S.hold=c,S.bits=w};const He=15,jt=852,Ft=592,Xt=0,wt=1,Gt=2,er=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),tr=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),nr=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),or=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]),ir=(t,n,e,i,a,o,f,l)=>{const b=l.bits;let r=0,s=0,k=0,d=0,c=0,w=0,z=0,m=0,E=0,P=0,A,h,C,Y,_,R=null,x;const g=new Uint16Array(He+1),S=new Uint16Array(He+1);let oe=null,he,v,M;for(r=0;r<=He;r++)g[r]=0;for(s=0;s<i;s++)g[n[e+s]]++;for(c=b,d=He;d>=1&&g[d]===0;d--);if(c>d&&(c=d),d===0)return a[o++]=1<<24|64<<16|0,a[o++]=1<<24|64<<16|0,l.bits=1,0;for(k=1;k<d&&g[k]===0;k++);for(c<k&&(c=k),m=1,r=1;r<=He;r++)if(m<<=1,m-=g[r],m<0)return-1;if(m>0&&(t===Xt||d!==1))return-1;for(S[1]=0,r=1;r<He;r++)S[r+1]=S[r]+g[r];for(s=0;s<i;s++)n[e+s]!==0&&(f[S[n[e+s]]++]=s);if(t===Xt?(R=oe=f,x=20):t===wt?(R=er,oe=tr,x=257):(R=nr,oe=or,x=0),P=0,s=0,r=k,_=o,w=c,z=0,C=-1,E=1<<c,Y=E-1,t===wt&&E>jt||t===Gt&&E>Ft)return 1;for(;;){he=r-z,f[s]+1<x?(v=0,M=f[s]):f[s]>=x?(v=oe[f[s]-x],M=R[f[s]-x]):(v=96,M=0),A=1<<r-z,h=1<<w,k=h;do h-=A,a[_+(P>>z)+h]=he<<24|v<<16|M|0;while(h!==0);for(A=1<<r-1;P&A;)A>>=1;if(A!==0?(P&=A-1,P+=A):P=0,s++,--g[r]===0){if(r===d)break;r=n[e+f[s]]}if(r>c&&(P&Y)!==C){for(z===0&&(z=c),_+=k,w=r-z,m=1<<w;w+z<d&&(m-=g[w+z],!(m<=0));)w++,m<<=1;if(E+=1<<w,t===wt&&E>jt||t===Gt&&E>Ft)return 1;C=P&Y,a[C]=c<<24|w<<16|_-o|0}}return P!==0&&(a[_+P]=r-z<<24|64<<16|0),l.bits=c,0};var et=ir;const rr=0,Ln=1,Rn=2,{Z_FINISH:Ht,Z_BLOCK:sr,Z_TREES:lt,Z_OK:Xe,Z_STREAM_END:ar,Z_NEED_DICT:lr,Z_STREAM_ERROR:Ie,Z_DATA_ERROR:Nn,Z_MEM_ERROR:Bn,Z_BUF_ERROR:cr,Z_DEFLATED:Vt}=An,_t=16180,Yt=16181,Wt=16182,Jt=16183,Kt=16184,Qt=16185,en=16186,tn=16187,nn=16188,on=16189,gt=16190,Ne=16191,xt=16192,rn=16193,$t=16194,sn=16195,an=16196,ln=16197,cn=16198,ct=16199,dt=16200,dn=16201,un=16202,fn=16203,hn=16204,gn=16205,pt=16206,_n=16207,vn=16208,me=16209,Un=16210,qn=16211,dr=852,ur=592,fr=15,hr=fr,mn=t=>(t>>>24&255)+(t>>>8&65280)+((t&65280)<<8)+((t&255)<<24);function gr(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const Ge=t=>{if(!t)return 1;const n=t.state;return!n||n.strm!==t||n.mode<_t||n.mode>qn?1:0},zn=t=>{if(Ge(t))return Ie;const n=t.state;return t.total_in=t.total_out=n.total=0,t.msg="",n.wrap&&(t.adler=n.wrap&1),n.mode=_t,n.last=0,n.havedict=0,n.flags=-1,n.dmax=32768,n.head=null,n.hold=0,n.bits=0,n.lencode=n.lendyn=new Int32Array(dr),n.distcode=n.distdyn=new Int32Array(ur),n.sane=1,n.back=-1,Xe},Zn=t=>{if(Ge(t))return Ie;const n=t.state;return n.wsize=0,n.whave=0,n.wnext=0,zn(t)},jn=(t,n)=>{let e;if(Ge(t))return Ie;const i=t.state;return n<0?(e=0,n=-n):(e=(n>>4)+5,n<48&&(n&=15)),n&&(n<8||n>15)?Ie:(i.window!==null&&i.wbits!==n&&(i.window=null),i.wrap=e,i.wbits=n,Zn(t))},Fn=(t,n)=>{if(!t)return Ie;const e=new gr;t.state=e,e.strm=t,e.window=null,e.mode=_t;const i=jn(t,n);return i!==Xe&&(t.state=null),i},_r=t=>Fn(t,hr);let bn=!0,yt,St;const vr=t=>{if(bn){yt=new Int32Array(512),St=new Int32Array(32);let n=0;for(;n<144;)t.lens[n++]=8;for(;n<256;)t.lens[n++]=9;for(;n<280;)t.lens[n++]=7;for(;n<288;)t.lens[n++]=8;for(et(Ln,t.lens,0,288,yt,0,t.work,{bits:9}),n=0;n<32;)t.lens[n++]=5;et(Rn,t.lens,0,32,St,0,t.work,{bits:5}),bn=!1}t.lencode=yt,t.lenbits=9,t.distcode=St,t.distbits=5},Xn=(t,n,e,i)=>{let a;const o=t.state;return o.window===null&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new Uint8Array(o.wsize)),i>=o.wsize?(o.window.set(n.subarray(e-o.wsize,e),0),o.wnext=0,o.whave=o.wsize):(a=o.wsize-o.wnext,a>i&&(a=i),o.window.set(n.subarray(e-i,e-i+a),o.wnext),i-=a,i?(o.window.set(n.subarray(e-i,e),0),o.wnext=i,o.whave=o.wsize):(o.wnext+=a,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=a))),0},mr=(t,n)=>{let e,i,a,o,f,l,b,r,s,k,d,c,w,z,m=0,E,P,A,h,C,Y,_,R;const x=new Uint8Array(4);let g,S;const oe=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(Ge(t)||!t.output||!t.input&&t.avail_in!==0)return Ie;e=t.state,e.mode===Ne&&(e.mode=xt),f=t.next_out,a=t.output,b=t.avail_out,o=t.next_in,i=t.input,l=t.avail_in,r=e.hold,s=e.bits,k=l,d=b,R=Xe;e:for(;;)switch(e.mode){case _t:if(e.wrap===0){e.mode=xt;break}for(;s<16;){if(l===0)break e;l--,r+=i[o++]<<s,s+=8}if(e.wrap&2&&r===35615){e.wbits===0&&(e.wbits=15),e.check=0,x[0]=r&255,x[1]=r>>>8&255,e.check=Me(e.check,x,2,0),r=0,s=0,e.mode=Yt;break}if(e.head&&(e.head.done=!1),!(e.wrap&1)||(((r&255)<<8)+(r>>8))%31){t.msg="incorrect header check",e.mode=me;break}if((r&15)!==Vt){t.msg="unknown compression method",e.mode=me;break}if(r>>>=4,s-=4,_=(r&15)+8,e.wbits===0&&(e.wbits=_),_>15||_>e.wbits){t.msg="invalid window size",e.mode=me;break}e.dmax=1<<e.wbits,e.flags=0,t.adler=e.check=1,e.mode=r&512?on:Ne,r=0,s=0;break;case Yt:for(;s<16;){if(l===0)break e;l--,r+=i[o++]<<s,s+=8}if(e.flags=r,(e.flags&255)!==Vt){t.msg="unknown compression method",e.mode=me;break}if(e.flags&57344){t.msg="unknown header flags set",e.mode=me;break}e.head&&(e.head.text=r>>8&1),e.flags&512&&e.wrap&4&&(x[0]=r&255,x[1]=r>>>8&255,e.check=Me(e.check,x,2,0)),r=0,s=0,e.mode=Wt;case Wt:for(;s<32;){if(l===0)break e;l--,r+=i[o++]<<s,s+=8}e.head&&(e.head.time=r),e.flags&512&&e.wrap&4&&(x[0]=r&255,x[1]=r>>>8&255,x[2]=r>>>16&255,x[3]=r>>>24&255,e.check=Me(e.check,x,4,0)),r=0,s=0,e.mode=Jt;case Jt:for(;s<16;){if(l===0)break e;l--,r+=i[o++]<<s,s+=8}e.head&&(e.head.xflags=r&255,e.head.os=r>>8),e.flags&512&&e.wrap&4&&(x[0]=r&255,x[1]=r>>>8&255,e.check=Me(e.check,x,2,0)),r=0,s=0,e.mode=Kt;case Kt:if(e.flags&1024){for(;s<16;){if(l===0)break e;l--,r+=i[o++]<<s,s+=8}e.length=r,e.head&&(e.head.extra_len=r),e.flags&512&&e.wrap&4&&(x[0]=r&255,x[1]=r>>>8&255,e.check=Me(e.check,x,2,0)),r=0,s=0}else e.head&&(e.head.extra=null);e.mode=Qt;case Qt:if(e.flags&1024&&(c=e.length,c>l&&(c=l),c&&(e.head&&(_=e.head.extra_len-e.length,e.head.extra||(e.head.extra=new Uint8Array(e.head.extra_len)),e.head.extra.set(i.subarray(o,o+c),_)),e.flags&512&&e.wrap&4&&(e.check=Me(e.check,i,c,o)),l-=c,o+=c,e.length-=c),e.length))break e;e.length=0,e.mode=en;case en:if(e.flags&2048){if(l===0)break e;c=0;do _=i[o+c++],e.head&&_&&e.length<65536&&(e.head.name+=String.fromCharCode(_));while(_&&c<l);if(e.flags&512&&e.wrap&4&&(e.check=Me(e.check,i,c,o)),l-=c,o+=c,_)break e}else e.head&&(e.head.name=null);e.length=0,e.mode=tn;case tn:if(e.flags&4096){if(l===0)break e;c=0;do _=i[o+c++],e.head&&_&&e.length<65536&&(e.head.comment+=String.fromCharCode(_));while(_&&c<l);if(e.flags&512&&e.wrap&4&&(e.check=Me(e.check,i,c,o)),l-=c,o+=c,_)break e}else e.head&&(e.head.comment=null);e.mode=nn;case nn:if(e.flags&512){for(;s<16;){if(l===0)break e;l--,r+=i[o++]<<s,s+=8}if(e.wrap&4&&r!==(e.check&65535)){t.msg="header crc mismatch",e.mode=me;break}r=0,s=0}e.head&&(e.head.hcrc=e.flags>>9&1,e.head.done=!0),t.adler=e.check=0,e.mode=Ne;break;case on:for(;s<32;){if(l===0)break e;l--,r+=i[o++]<<s,s+=8}t.adler=e.check=mn(r),r=0,s=0,e.mode=gt;case gt:if(e.havedict===0)return t.next_out=f,t.avail_out=b,t.next_in=o,t.avail_in=l,e.hold=r,e.bits=s,lr;t.adler=e.check=1,e.mode=Ne;case Ne:if(n===sr||n===lt)break e;case xt:if(e.last){r>>>=s&7,s-=s&7,e.mode=pt;break}for(;s<3;){if(l===0)break e;l--,r+=i[o++]<<s,s+=8}switch(e.last=r&1,r>>>=1,s-=1,r&3){case 0:e.mode=rn;break;case 1:if(vr(e),e.mode=ct,n===lt){r>>>=2,s-=2;break e}break;case 2:e.mode=an;break;case 3:t.msg="invalid block type",e.mode=me}r>>>=2,s-=2;break;case rn:for(r>>>=s&7,s-=s&7;s<32;){if(l===0)break e;l--,r+=i[o++]<<s,s+=8}if((r&65535)!==(r>>>16^65535)){t.msg="invalid stored block lengths",e.mode=me;break}if(e.length=r&65535,r=0,s=0,e.mode=$t,n===lt)break e;case $t:e.mode=sn;case sn:if(c=e.length,c){if(c>l&&(c=l),c>b&&(c=b),c===0)break e;a.set(i.subarray(o,o+c),f),l-=c,o+=c,b-=c,f+=c,e.length-=c;break}e.mode=Ne;break;case an:for(;s<14;){if(l===0)break e;l--,r+=i[o++]<<s,s+=8}if(e.nlen=(r&31)+257,r>>>=5,s-=5,e.ndist=(r&31)+1,r>>>=5,s-=5,e.ncode=(r&15)+4,r>>>=4,s-=4,e.nlen>286||e.ndist>30){t.msg="too many length or distance symbols",e.mode=me;break}e.have=0,e.mode=ln;case ln:for(;e.have<e.ncode;){for(;s<3;){if(l===0)break e;l--,r+=i[o++]<<s,s+=8}e.lens[oe[e.have++]]=r&7,r>>>=3,s-=3}for(;e.have<19;)e.lens[oe[e.have++]]=0;if(e.lencode=e.lendyn,e.lenbits=7,g={bits:e.lenbits},R=et(rr,e.lens,0,19,e.lencode,0,e.work,g),e.lenbits=g.bits,R){t.msg="invalid code lengths set",e.mode=me;break}e.have=0,e.mode=cn;case cn:for(;e.have<e.nlen+e.ndist;){for(;m=e.lencode[r&(1<<e.lenbits)-1],E=m>>>24,P=m>>>16&255,A=m&65535,!(E<=s);){if(l===0)break e;l--,r+=i[o++]<<s,s+=8}if(A<16)r>>>=E,s-=E,e.lens[e.have++]=A;else{if(A===16){for(S=E+2;s<S;){if(l===0)break e;l--,r+=i[o++]<<s,s+=8}if(r>>>=E,s-=E,e.have===0){t.msg="invalid bit length repeat",e.mode=me;break}_=e.lens[e.have-1],c=3+(r&3),r>>>=2,s-=2}else if(A===17){for(S=E+3;s<S;){if(l===0)break e;l--,r+=i[o++]<<s,s+=8}r>>>=E,s-=E,_=0,c=3+(r&7),r>>>=3,s-=3}else{for(S=E+7;s<S;){if(l===0)break e;l--,r+=i[o++]<<s,s+=8}r>>>=E,s-=E,_=0,c=11+(r&127),r>>>=7,s-=7}if(e.have+c>e.nlen+e.ndist){t.msg="invalid bit length repeat",e.mode=me;break}for(;c--;)e.lens[e.have++]=_}}if(e.mode===me)break;if(e.lens[256]===0){t.msg="invalid code -- missing end-of-block",e.mode=me;break}if(e.lenbits=9,g={bits:e.lenbits},R=et(Ln,e.lens,0,e.nlen,e.lencode,0,e.work,g),e.lenbits=g.bits,R){t.msg="invalid literal/lengths set",e.mode=me;break}if(e.distbits=6,e.distcode=e.distdyn,g={bits:e.distbits},R=et(Rn,e.lens,e.nlen,e.ndist,e.distcode,0,e.work,g),e.distbits=g.bits,R){t.msg="invalid distances set",e.mode=me;break}if(e.mode=ct,n===lt)break e;case ct:e.mode=dt;case dt:if(l>=6&&b>=258){t.next_out=f,t.avail_out=b,t.next_in=o,t.avail_in=l,e.hold=r,e.bits=s,Qi(t,d),f=t.next_out,a=t.output,b=t.avail_out,o=t.next_in,i=t.input,l=t.avail_in,r=e.hold,s=e.bits,e.mode===Ne&&(e.back=-1);break}for(e.back=0;m=e.lencode[r&(1<<e.lenbits)-1],E=m>>>24,P=m>>>16&255,A=m&65535,!(E<=s);){if(l===0)break e;l--,r+=i[o++]<<s,s+=8}if(P&&(P&240)===0){for(h=E,C=P,Y=A;m=e.lencode[Y+((r&(1<<h+C)-1)>>h)],E=m>>>24,P=m>>>16&255,A=m&65535,!(h+E<=s);){if(l===0)break e;l--,r+=i[o++]<<s,s+=8}r>>>=h,s-=h,e.back+=h}if(r>>>=E,s-=E,e.back+=E,e.length=A,P===0){e.mode=gn;break}if(P&32){e.back=-1,e.mode=Ne;break}if(P&64){t.msg="invalid literal/length code",e.mode=me;break}e.extra=P&15,e.mode=dn;case dn:if(e.extra){for(S=e.extra;s<S;){if(l===0)break e;l--,r+=i[o++]<<s,s+=8}e.length+=r&(1<<e.extra)-1,r>>>=e.extra,s-=e.extra,e.back+=e.extra}e.was=e.length,e.mode=un;case un:for(;m=e.distcode[r&(1<<e.distbits)-1],E=m>>>24,P=m>>>16&255,A=m&65535,!(E<=s);){if(l===0)break e;l--,r+=i[o++]<<s,s+=8}if((P&240)===0){for(h=E,C=P,Y=A;m=e.distcode[Y+((r&(1<<h+C)-1)>>h)],E=m>>>24,P=m>>>16&255,A=m&65535,!(h+E<=s);){if(l===0)break e;l--,r+=i[o++]<<s,s+=8}r>>>=h,s-=h,e.back+=h}if(r>>>=E,s-=E,e.back+=E,P&64){t.msg="invalid distance code",e.mode=me;break}e.offset=A,e.extra=P&15,e.mode=fn;case fn:if(e.extra){for(S=e.extra;s<S;){if(l===0)break e;l--,r+=i[o++]<<s,s+=8}e.offset+=r&(1<<e.extra)-1,r>>>=e.extra,s-=e.extra,e.back+=e.extra}if(e.offset>e.dmax){t.msg="invalid distance too far back",e.mode=me;break}e.mode=hn;case hn:if(b===0)break e;if(c=d-b,e.offset>c){if(c=e.offset-c,c>e.whave&&e.sane){t.msg="invalid distance too far back",e.mode=me;break}c>e.wnext?(c-=e.wnext,w=e.wsize-c):w=e.wnext-c,c>e.length&&(c=e.length),z=e.window}else z=a,w=f-e.offset,c=e.length;c>b&&(c=b),b-=c,e.length-=c;do a[f++]=z[w++];while(--c);e.length===0&&(e.mode=dt);break;case gn:if(b===0)break e;a[f++]=e.length,b--,e.mode=dt;break;case pt:if(e.wrap){for(;s<32;){if(l===0)break e;l--,r|=i[o++]<<s,s+=8}if(d-=b,t.total_out+=d,e.total+=d,e.wrap&4&&d&&(t.adler=e.check=e.flags?Me(e.check,a,d,f-d):It(e.check,a,d,f-d)),d=b,e.wrap&4&&(e.flags?r:mn(r))!==e.check){t.msg="incorrect data check",e.mode=me;break}r=0,s=0}e.mode=_n;case _n:if(e.wrap&&e.flags){for(;s<32;){if(l===0)break e;l--,r+=i[o++]<<s,s+=8}if(e.wrap&4&&r!==(e.total&4294967295)){t.msg="incorrect length check",e.mode=me;break}r=0,s=0}e.mode=vn;case vn:R=ar;break e;case me:R=Nn;break e;case Un:return Bn;case qn:default:return Ie}return t.next_out=f,t.avail_out=b,t.next_in=o,t.avail_in=l,e.hold=r,e.bits=s,(e.wsize||d!==t.avail_out&&e.mode<me&&(e.mode<pt||n!==Ht))&&Xn(t,t.output,t.next_out,d-t.avail_out),k-=t.avail_in,d-=t.avail_out,t.total_in+=k,t.total_out+=d,e.total+=d,e.wrap&4&&d&&(t.adler=e.check=e.flags?Me(e.check,a,d,t.next_out-d):It(e.check,a,d,t.next_out-d)),t.data_type=e.bits+(e.last?64:0)+(e.mode===Ne?128:0)+(e.mode===ct||e.mode===$t?256:0),(k===0&&d===0||n===Ht)&&R===Xe&&(R=cr),R},br=t=>{if(Ge(t))return Ie;let n=t.state;return n.window&&(n.window=null),t.state=null,Xe},wr=(t,n)=>{if(Ge(t))return Ie;const e=t.state;return(e.wrap&2)===0?Ie:(e.head=n,n.done=!1,Xe)},xr=(t,n)=>{const e=n.length;let i,a,o;return Ge(t)||(i=t.state,i.wrap!==0&&i.mode!==gt)?Ie:i.mode===gt&&(a=1,a=It(a,n,e,0),a!==i.check)?Nn:(o=Xn(t,n,e,e),o?(i.mode=Un,Bn):(i.havedict=1,Xe))};var $r=Zn,pr=jn,yr=zn,Sr=_r,Tr=Fn,Er=mr,Cr=br,kr=wr,Ir=xr,Dr="pako inflate (from Nodeca project)",Be={inflateReset:$r,inflateReset2:pr,inflateResetKeep:yr,inflateInit:Sr,inflateInit2:Tr,inflate:Er,inflateEnd:Cr,inflateGetHeader:kr,inflateSetDictionary:Ir,inflateInfo:Dr};function Pr(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}var Ar=Pr;const Gn=Object.prototype.toString,{Z_NO_FLUSH:Mr,Z_FINISH:Or,Z_OK:ot,Z_STREAM_END:Tt,Z_NEED_DICT:Et,Z_STREAM_ERROR:Lr,Z_DATA_ERROR:wn,Z_MEM_ERROR:Rr}=An;function vt(t){this.options=Mn.assign({chunkSize:1024*64,windowBits:15,to:""},t||{});const n=this.options;n.raw&&n.windowBits>=0&&n.windowBits<16&&(n.windowBits=-n.windowBits,n.windowBits===0&&(n.windowBits=-15)),n.windowBits>=0&&n.windowBits<16&&!(t&&t.windowBits)&&(n.windowBits+=32),n.windowBits>15&&n.windowBits<48&&(n.windowBits&15)===0&&(n.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Ji,this.strm.avail_out=0;let e=Be.inflateInit2(this.strm,n.windowBits);if(e!==ot)throw new Error(Dt[e]);if(this.header=new Ar,Be.inflateGetHeader(this.strm,this.header),n.dictionary&&(typeof n.dictionary=="string"?n.dictionary=Pt.string2buf(n.dictionary):Gn.call(n.dictionary)==="[object ArrayBuffer]"&&(n.dictionary=new Uint8Array(n.dictionary)),n.raw&&(e=Be.inflateSetDictionary(this.strm,n.dictionary),e!==ot)))throw new Error(Dt[e])}vt.prototype.push=function(t,n){const e=this.strm,i=this.options.chunkSize,a=this.options.dictionary;let o,f,l;if(this.ended)return!1;for(n===~~n?f=n:f=n===!0?Or:Mr,Gn.call(t)==="[object ArrayBuffer]"?e.input=new Uint8Array(t):e.input=t,e.next_in=0,e.avail_in=e.input.length;;){for(e.avail_out===0&&(e.output=new Uint8Array(i),e.next_out=0,e.avail_out=i),o=Be.inflate(e,f),o===Et&&a&&(o=Be.inflateSetDictionary(e,a),o===ot?o=Be.inflate(e,f):o===wn&&(o=Et));e.avail_in>0&&o===Tt&&e.state.wrap>0&&t[e.next_in]!==0;)Be.inflateReset(e),o=Be.inflate(e,f);switch(o){case Lr:case wn:case Et:case Rr:return this.onEnd(o),this.ended=!0,!1}if(l=e.avail_out,e.next_out&&(e.avail_out===0||o===Tt))if(this.options.to==="string"){let b=Pt.utf8border(e.output,e.next_out),r=e.next_out-b,s=Pt.buf2string(e.output,b);e.next_out=r,e.avail_out=i-r,r&&e.output.set(e.output.subarray(b,b+r),0),this.onData(s)}else this.onData(e.output.length===e.next_out?e.output:e.output.subarray(0,e.next_out));if(!(o===ot&&l===0)){if(o===Tt)return o=Be.inflateEnd(this.strm),this.onEnd(o),this.ended=!0,!0;if(e.avail_in===0)break}}return!0};vt.prototype.onData=function(t){this.chunks.push(t)};vt.prototype.onEnd=function(t){t===ot&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=Mn.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg};function Nr(t,n){const e=new vt(n);if(e.push(t),e.err)throw e.msg||Dt[e.err];return e.result}var Br=Nr,Ur={inflate:Br};const{inflate:qr}=Ur;var zr=qr;const xn="mapTilesDB",je="tiles",ut=1,$n=100;class Hn{db=null;dbName=xn;storeName=je;isInitialized=!1;initPromise=null;maxAge=30*1e3;refreshThreshold=20*1e3;lastUpdateTime=0;refreshInterval=null;accessTimes=new Map;constructor(){this.init()}async init(){if(console.log("[TileCache] Initializing IndexedDB..."),this.isInitialized){console.log("[TileCache] Already initialized");return}return this.initPromise?(console.log("[TileCache] Initialization already in progress, waiting..."),this.initPromise):(console.log("[TileCache] Starting new initialization"),this.initPromise=new Promise((n,e)=>{if(typeof window>"u"){console.log("[TileCache] Skipping IndexedDB initialization in SSR"),this.isInitialized=!0,n();return}console.log(`[TileCache] Opening IndexedDB: ${this.dbName} v${ut}`);const i=indexedDB.open(this.dbName,ut);i.onblocked=a=>{console.error("[TileCache] Database access blocked:",a),e(new Error("Database access is blocked"))},i.onerror=a=>{const o=a.target;console.error("[TileCache] Error opening IndexedDB:",{error:o.error,name:o.error?.name,message:o.error?.message,type:a.type,dbName:this.dbName,version:ut}),e(o.error||new Error("Unknown error opening database"))},i.onerror=a=>{const o=a.target;console.error("[TileCache] Error opening IndexedDB:",{error:o.error,type:a.type,target:o});const f=o.error||new Error("Unknown error opening IndexedDB");e(f)},i.onsuccess=a=>{const o=a.target.result;if(this.db=o,this.isInitialized=!0,console.log(`[TileCache] Database '${xn}' v${ut} ready`),console.log("[TileCache] Object stores:",Array.from(o.objectStoreNames)),o.objectStoreNames.contains("tiles")){const b=o.transaction(["tiles"],"readonly").objectStore("tiles").count();b.onsuccess=()=>{console.log(`[TileCache] Found ${b.result} tiles in the store`)},b.onerror=r=>{console.error("[TileCache] Error counting tiles:",r)}}else console.error("[TileCache] Tiles store not found in database!");this.cleanupOldTiles().catch(console.error),n()},i.onupgradeneeded=a=>{const o=a.target.result;if(console.log(`[TileCache] Database upgrade needed for ${this.dbName} v${a.oldVersion} -> v${a.newVersion}`),o.objectStoreNames.contains(this.storeName))console.log(`[TileCache] Object store ${this.storeName} already exists`);else{console.log(`[TileCache] Creating object store: ${this.storeName}`);try{o.createObjectStore(this.storeName,{keyPath:["x","y"]}).createIndex("timestamp","timestamp",{unique:!1}),console.log("[TileCache] Object store and index created")}catch(f){throw console.error("[TileCache] Error creating object store:",f),f}}}}),this.initPromise)}getStore(n){if(typeof window>"u")return console.error("[TileCache] Not in browser environment"),null;if(!this.db)return console.error("[TileCache] Database not initialized"),null;try{const e=this.db.transaction([je],n);return e.onerror=i=>{console.error("[TileCache] Transaction error:",i.target.error)},e.oncomplete=()=>{},e.onabort=i=>{console.error("[TileCache] Transaction aborted:",i.target.error)},e.objectStore(je)}catch(e){return console.error("[TileCache] Error getting store:",e),null}}async deleteTile(n,e){return new Promise((i,a)=>{const o=this.getStore("readwrite");if(!o){a(new Error("Failed to get store for deletion"));return}const f=o.delete([n,e]);f.onsuccess=()=>{this.accessTimes.delete(`${n},${e}`),i()},f.onerror=l=>{console.error(`[TileCache] Error deleting tile (${n},${e}):`,l.target.error),a(l.target.error)}})}async getTile(n,e,i=!1){if(!this.isInitialized)try{await this.init()}catch(o){return console.error("[TileCache] Error initializing in getTile:",o),null}if(typeof window>"u"||i)return null;const a=`${n},${e}`;this.accessTimes.set(a,Date.now());try{const o=this.getStore("readonly");if(!o)return console.error("[TileCache] Failed to get store"),null;const f=o.get([n,e]);return new Promise(l=>{f.onsuccess=()=>{const b=f.result;if(!b){l(null);return}Date.now()-b.timestamp>this.maxAge?this.deleteTile(n,e).then(()=>{console.log(`[TileCache] Deleted expired tile (${n},${e})`),l(null)}).catch(k=>{console.error(`[TileCache] Error deleting expired tile (${n},${e}):`,k),l(null)}):l(b)},f.onerror=()=>{console.error(`[TileCache] Error checking tile (${n},${e}):`,f.error),l(null)}})}catch(o){return console.error(`[TileCache] Error in getTile for (${n},${e}):`,o),null}}async setTile(n,e,i,a){if(!this.isInitialized)try{await this.init()}catch(l){throw console.error("[TileCache] Error initializing in setTile:",l),l}this.lastUpdateTime=Date.now();const o=`${n},${e}`;this.accessTimes.set(o,Date.now());const f=await this.getCacheSize();if(f>=$n&&await this.evictLRUTiles(f-$n+1),this.refreshInterval||this.scheduleNextCleanup(),!(typeof window>"u"))return new Promise((l,b)=>{try{const r=this.getStore("readwrite");if(!r){const d=new Error("Failed to access IndexedDB store");console.error("[TileCache]",d),b(d);return}const s={x:n,y:e,data:i,timestamp:Date.now(),etag:a},k=r.put(s);k.onsuccess=()=>{r.get([n,e]).onsuccess=d=>{d.target.result||console.error(`[TileCache] Failed to verify tile (${n}, ${e}) was stored`),l()}},k.onerror=d=>{const c=k.error||new Error("Unknown error setting tile in cache");console.error(`[TileCache] Error storing tile (${n}, ${e}):`,{error:c,event:d.type,target:d.target.result}),b(c)}}catch(r){console.error("Error in setTile:",r),b(r)}})}async clear(){}async cleanupOldTiles(){return new Promise(n=>{if(!this.db){console.log("[TileCache] No database to clean up"),n();return}const a=this.db.transaction([je],"readwrite").objectStore(je).index("timestamp"),f=Date.now()-this.maxAge,l=a.openCursor(IDBKeyRange.upperBound(f)),b=[];l.onsuccess=r=>{const s=r.target.result;if(s)b.push([s.value.x,s.value.y]),s.continue();else if(b.length>0){const k=this.db.transaction([je],"readwrite"),d=k.objectStore(je);b.forEach(([c,w])=>{d.delete([c,w])}),k.oncomplete=()=>{this.scheduleNextCleanup(),n()},k.onerror=c=>{console.error("[TileCache] Error deleting old tiles:",c),n()}}else this.scheduleNextCleanup(),n()},l.onerror=r=>{console.error("[TileCache] Error cleaning up old tiles:",r),n()}})}async evictLRUTiles(n){if(n<=0)return;const i=Array.from(this.accessTimes.entries()).map(([a,o])=>({key:a,lastAccess:o,coords:a.split(",").map(Number)})).sort((a,o)=>a.lastAccess-o.lastAccess).slice(0,n);for(const{coords:[a,o],key:f}of i)await this.deleteTile(a,o),this.accessTimes.delete(f)}scheduleNextCleanup(){this.refreshInterval&&clearTimeout(this.refreshInterval),this.refreshInterval=window.setTimeout(()=>{this.cleanupOldTiles().catch(console.error)},1e4)}async getCacheSize(){return this.isInitialized||await this.init(),typeof window>"u"?0:new Promise((n,e)=>{try{const i=this.getStore("readonly");if(!i){n(0);return}const a=i.count();a.onsuccess=()=>{n(a.result)},a.onerror=()=>{const o=a.error||new Error("Unknown error getting cache size");console.error("Error getting cache size",o),n(0)}}catch(i){console.error("Error in getCacheSize:",i),n(0)}})}}new Hn;const Zr="_mapContainer_10ovn_4",jr="_mapViewport_10ovn_20",Fr="_mapViewportDragging_10ovn_29",Xr="_mapContent_10ovn_35",Gr="_tileContainer_10ovn_59",Hr="_tile_10ovn_59",Vr="_fallbackTile_10ovn_118",Yr="_loading_10ovn_137",Wr="_gridLabel_10ovn_173",Jr="_major_10ovn_188",Kr="_zero_10ovn_194",Qr="_tileLabel_10ovn_201",es="_loadingIndicator_10ovn_218",ts="_spin_10ovn_1",ns="_tileImage_10ovn_234",os="_tileSvg_10ovn_235",is="_fallbackTileContent_10ovn_285",rs="_error_10ovn_293",ss="_gridOverlay_10ovn_321",as="_tileImageScaled_10ovn_365",ls="_tileImageScaledDynamic_10ovn_381",cs="_tileContent_10ovn_403",ds="_coordinateLabel_10ovn_411",us="_loadingOverlay_10ovn_417",fs="_errorOverlay_10ovn_418",hs="_controls_10ovn_435",gs="_coordinates_10ovn_468",ae={mapContainer:Zr,mapViewport:jr,mapViewportDragging:Fr,mapContent:Xr,tileContainer:Gr,tile:Hr,fallbackTile:Vr,loading:Yr,"loading-progress":"_loading-progress_10ovn_1",gridLabel:Wr,major:Jr,zero:Kr,tileLabel:Qr,loadingIndicator:es,spin:ts,tileImage:ns,tileSvg:os,fallbackTileContent:is,error:rs,gridOverlay:ss,tileImageScaled:as,tileImageScaledDynamic:ls,tileContent:cs,coordinateLabel:ds,loadingOverlay:us,errorOverlay:fs,controls:hs,coordinates:gs,"loading-pulse":"_loading-pulse_10ovn_1"};var Ct=fe("<div>"),pn=fe("<div><div>Error<div><!$><!/>,<!$><!/>"),_s=fe("<div><div><div></div><div><!$><!/>,<!$><!/>"),yn=fe("<div><div><div><!$><!/>,<!$><!/>"),vs=fe('<div><svg width=64 height=64 viewBox="0 0 64 64"></svg><div><!$><!/>,<!$><!/><!$><!/>'),ms=fe("<svg><circle></svg>",!1,!0,!1),bs=fe("<div><div><div style=--translate-x:0px;--translate-y:0px><div style=z-index:2></div></div></div><!$><!/><div><div>Position: <!$><!/>, <!$><!/><br>Tiles: <!$><!/>"),ws=fe("<div>Loading map...");const ke=64,Ve={BATCH_SIZE:4,MAX_TILES_TO_LOAD:30,BATCH_DELAY:100,BATCH_TIMEOUT:5e3,MAX_TILES_IN_MEMORY:50},Sn=800,Tn=600,xs=()=>{const[t,n]=ue({});let e;const i=()=>{const u=e?.clientWidth||Sn,p=e?.clientHeight||Tn;return console.log(`width, height: ${u}, ${p}`),{x:0,y:0,width:u,height:p}},[a,o]=ue(i());n({});const[f,l]=ue(!1),[b,r]=ue(null),[s,k]=ue({x:0,y:0,startX:0,startY:0}),[d,c]=ue(!1),w=new Hn;let z=!1;w.init().then(()=>{z=!0}).catch(u=>{console.error("[MapView] Failed to initialize tile cache:",u)});const[m,E]=ue([]),[P,A]=ue(!1),h=new Set;let C=null,Y=!1;const[_,R]=ue(!1),x=Math.floor(Math.random()*1e6),g=u=>!u||u.error?!0:Date.now()-u.timestamp>20*1e3,S=()=>{if(!_())return;const u=t();Object.values(u).forEach(p=>{g(p)&&D(p.x,p.y,!0).catch(Z=>{console.error(`[loadVisibleTiles] Error refreshing tile (${p.x}, ${p.y}):`,Z)})})};tt(()=>{R(!0),S();const u=setInterval(()=>{_()&&S()},10*1e3);return()=>{clearInterval(u),R(!1)}}),qe(()=>{const u=()=>{if(!_())return;console.log("[MapView] Effect initialLoad");const Z=e?.clientWidth||Sn,q=e?.clientHeight||Tn;console.log(`[MapView] Effect initialLoad width: ${Z}, height: ${q}`),o(L=>({...L,width:Z,height:q}))},p=setTimeout(()=>{_()&&u()},50);Qe(()=>{clearTimeout(p)})});const oe=u=>{o(p=>{const Z={...p,...u};return requestAnimationFrame(()=>{v()}),Z})},he=(u,p,Z)=>{const q=[];q.push({x:u,y:p,distance:0});for(let L=1;L<=Z;L++){let G=L,W=-L;for(;G>=-L;G--)q.push({x:u+G,y:p+W,distance:L});for(G++,W++;W<=L;W++)q.push({x:u+G,y:p+W,distance:L});for(W--,G++;G<=L;G++)q.push({x:u+G,y:p+W,distance:L});for(G--,W--;W>-L;W--)q.push({x:u+G,y:p+W,distance:L})}return q},v=u=>{const p=a(),Z=Math.floor(Math.abs(p.x)/64),q=Math.floor(Math.abs(p.y)/64);if(Z>16||q>16||Y)return;const L=m(),G=L.length;if(G>=Ve.MAX_TILES_TO_LOAD){$();return}const W=2,F=T(p.x,p.y),N=he(F.tileX,F.tileY,W),O=[],j=new Set(L.map(V=>`${V.x},${V.y}`));for(const{x:V,y:ne,distance:ce}of N){const se=`${V},${ne}`,we=t()[se];we?.data||we?.loading||j.has(se)||O.push({x:V,y:ne,priority:ce})}console.log(`visibleTiles: ${O}`),O.sort((V,ne)=>V.priority-ne.priority);const B=Math.max(0,Ve.MAX_TILES_TO_LOAD-G),H=O.slice(0,B);H.length>0&&(E(V=>{const ne=[...V],ce=new Set(ne.map(se=>`${se.x},${se.y}`));for(const se of H){const we=`${se.x},${se.y}`;ce.has(we)||(ne.push({x:se.x,y:se.y}),ce.add(we))}return ne}),P()||setTimeout($,0))};Qe(()=>{if(!_())return;Y=!0,R(!1),C!==null&&(clearTimeout(C),C=null);const u=Array.from(h);h.clear(),u.forEach(p=>{try{p.abort()}catch(Z){console.warn("Error aborting operation:",Z)}}),Cn(()=>{E([]),n({})})});const M=()=>{if(!_())throw new Error("Cannot create operation - component not mounted");const u=new AbortController;return h.add(u),{signal:u.signal,cleanup:()=>{h.delete(u)}}},$=async()=>{if(!(P()||!_())){C&&(clearTimeout(C),C=null);try{if(A(!0),!_())return;const u=m();if(u.length===0)return;const p=a(),Z=p.width/2,q=p.height/2,L=[...u].sort((O,j)=>{const B=Math.sqrt(Math.pow(O.x-Z,2)+Math.pow(O.y-q,2)),H=Math.sqrt(Math.pow(j.x-Z,2)+Math.pow(j.y-q,2));return B-H}),G=Math.min(Ve.BATCH_SIZE,L.length),W=L.slice(0,G),F=W.map(({x:O,y:j})=>D(O,j).catch(B=>(_()&&console.error(`[processTileQueue] Error loading tile (${O},${j}):`,B),null)));if(await Promise.race([Promise.all(F),new Promise(O=>setTimeout(O,Ve.BATCH_TIMEOUT||5e3))]),!_())return;E(O=>{const j=new Set(W.map(B=>`${B.x},${B.y}`));return O.filter(B=>!j.has(`${B.x},${B.y}`))}),m().length>0&&_()?C=window.setTimeout(()=>{_()&&$()},Ve.BATCH_DELAY):console.log("[processTileQueue] Queue processing complete")}catch(u){_()&&console.error("[processTileQueue] Error in queue processing:",u)}finally{_()&&A(!1)}}},T=(u,p)=>({tileX:Math.floor(u/ke),tileY:Math.floor(p/ke)}),I=(u,p)=>`${u},${p}`,D=async(u,p,Z=!1)=>{const q=t();if(Object.keys(q).length>=Ve.MAX_TILES_IN_MEMORY){const F=a(),N=Math.floor(F.x/64),O=Math.floor(F.y/64),j=Object.entries(q).filter(([B,H])=>!H.loading).sort((B,H)=>{const V=Math.abs(B[1].x-N)+Math.abs(B[1].y-O),ne=Math.abs(H[1].x-N)+Math.abs(H[1].y-O);return-(V-ne)});if(j.length>0){const[B]=j[0];n(H=>{const V={...H};return delete V[B],V})}}if(!z)try{await w.init(),z=!0}catch(F){console.error("[loadTile] Error initializing tile cache:",F)}const L=I(u,p);if(q[L]?.loading&&!Z||!_())return;if(!Z)try{const F=await w.getTile(u,p);if(F){const N=Date.now()-F.timestamp;n(j=>({...j,[L]:{x:u,y:p,data:F.data,loading:!1,error:!1,timestamp:Date.now(),mountId:x,fromCache:!0}}));const O=20*1e3;N>O&&D(u,p,!0).catch(console.error);return}}catch(F){console.error(`[loadTile] Error reading from cache for tile (${u}, ${p}):`,F)}n(F=>{const N=F[L];return{...F,[L]:{x:u,y:p,data:N?.data||null,loading:!0,error:!1,timestamp:N?.timestamp||0,mountId:x}}});let W=null;try{const{signal:F,cleanup:N}=M();W=N;const O=typeof window<"u"?sessionStorage.getItem("token"):null,j={Accept:"application/json"};O&&(j.Authorization=`Bearer ${O}`);const B=await fetch(`/api/map/tile/${u}/${p}`,{signal:F,headers:j,credentials:"include"});if(!B.ok)throw new Error(`HTTP ${B.status}: ${B.statusText}`);const H=await B.json();if(!_()){console.log(`[loadTile] Component unmounted during fetch for tile (${u}, ${p})`);return}if(!H.success||!H.data)throw console.error(`[loadTile] Invalid response format for tile (${u}, ${p}):`,H),new Error("Invalid response format");const V=H.data;let ne;if(typeof V.data=="string")try{const ce=V.data.split(",").map(Number);if(ce.some(isNaN))throw new Error("Invalid number in tile data");ne=new Uint8Array(ce);try{await w.setTile(u,p,ne)}catch(se){console.error(`[loadTile] Error caching tile (${u}, ${p}):`,se)}}catch(ce){throw console.error("Error parsing tile data:",ce),new Error("Failed to parse tile data")}else if(Array.isArray(V.data)){ne=new Uint8Array(V.data);try{await w.setTile(u,p,ne)}catch(ce){console.error(`[loadTile] Error caching tile (${u}, ${p}):`,ce)}}else throw new Error("Unexpected tile data format");_()&&n(ce=>({...ce,[L]:{x:u,y:p,data:ne,loading:!1,error:!1,timestamp:Date.now(),mountId:x,fromCache:!1}}))}catch(F){if(F instanceof Error&&F.name==="AbortError")return;_()&&n(N=>({...N,[L]:{...N[L]||{x:u,y:p},loading:!1,error:!0,timestamp:Date.now(),mountId:x}}))}finally{W&&W()}},X=u=>{if(u.button!==0)return;u.preventDefault(),u.stopPropagation();const p=a();l(!0),r({x:u.clientX,y:u.clientY}),k({x:u.clientX,y:u.clientY,startX:p.x,startY:p.y}),document.addEventListener("selectstart",ve),document.body.style.cursor="grabbing"},ge=u=>{if(f()){u.preventDefault(),u.stopPropagation(),l(!1),document.removeEventListener("selectstart",ve),document.body.style.cursor="";const p=u.target;p.style.display="none",p.offsetHeight,p.style.display=""}},J=u=>{if(!f())return;const p={x:u.clientX,y:u.clientY},Z=b();if(Z){const q=p.x-Z.x,L=p.y-Z.y;if(q===0&&L===0)return;const G=a(),W=G.x-q,F=G.y-L;console.log(`[MapView] handleMouseMove newX: ${W}, newY: ${F}`),oe({x:W,y:F})}r(p)},_e=u=>{f()&&(u.preventDefault(),u.stopPropagation(),l(!1),document.removeEventListener("selectstart",ve),document.body.style.cursor="")},ve=u=>(u.preventDefault(),!1);Qe(()=>{document.body.style.cursor="",E([]),C&&(clearTimeout(C),C=null)}),qe(()=>{a();const u=setTimeout(()=>{v()},50);return()=>clearTimeout(u)});const be=(u,p)=>`hsl(${(u*13+p*7)%360}, 70%, ${t()[`${u},${p}`]?.data?"85%":"90%"})`,Le=u=>{a();const p=(u.x+16)*ke,Z=(u.y+16)*ke,q=Math.round(p),L=Math.round(Z),G=q,W=L;let F=te(Ct);if(u.error)F=(()=>{var N=te(pn),O=N.firstChild,j=O.firstChild,B=j.nextSibling,H=B.firstChild,[V,ne]=ee(H.nextSibling),ce=V.nextSibling,se=ce.nextSibling,[we,$e]=ee(se.nextSibling);return U(B,()=>u.x,V,ne),U(B,()=>u.y,we,$e),le(K=>{var xe=`${ae.fallbackTile} ${ae.error}`,Se=ae.fallbackTileContent,de=ae.tileCoords;return xe!==K.e&&y(N,K.e=xe),Se!==K.t&&y(O,K.t=Se),de!==K.a&&y(B,K.a=de),K},{e:void 0,t:void 0,a:void 0}),N})();else if(u.loading&&(!u.data||u.data.length===0))F=(()=>{var N=te(_s),O=N.firstChild,j=O.firstChild,B=j.nextSibling,H=B.firstChild,[V,ne]=ee(H.nextSibling),ce=V.nextSibling,se=ce.nextSibling,[we,$e]=ee(se.nextSibling);return U(B,()=>u.x,V,ne),U(B,()=>u.y,we,$e),le(K=>{var xe=`${ae.fallbackTile} loading`,Se=`--tile-bg-color: ${be(u.x,u.y)}`,de=ae.fallbackTileContent,ie=ae.loadingSpinner,Ce=ae.tileCoords;return xe!==K.e&&y(N,K.e=xe),K.t=mt(N,Se,K.t),de!==K.a&&y(O,K.a=de),ie!==K.o&&y(j,K.o=ie),Ce!==K.i&&y(B,K.i=Ce),K},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),N})();else if(!u.data||u.data.length===0)F=(()=>{var N=te(yn),O=N.firstChild,j=O.firstChild,B=j.firstChild,[H,V]=ee(B.nextSibling),ne=H.nextSibling,ce=ne.nextSibling,[se,we]=ee(ce.nextSibling);return U(j,()=>u.x,H,V),U(j,()=>u.y,se,we),le($e=>{var K=ae.fallbackTile,xe=`--tile-bg-color: ${be(u.x,u.y)}`,Se=ae.fallbackTileContent,de=ae.tileCoords;return K!==$e.e&&y(N,$e.e=K),$e.t=mt(N,xe,$e.t),Se!==$e.a&&y(O,$e.a=Se),de!==$e.o&&y(j,$e.o=de),$e},{e:void 0,t:void 0,a:void 0,o:void 0}),N})();else try{const N=Re(u.data);N.length>0?F=(()=>{var O=te(vs),j=O.firstChild,B=j.nextSibling,H=B.firstChild,[V,ne]=ee(H.nextSibling),ce=V.nextSibling,se=ce.nextSibling,[we,$e]=ee(se.nextSibling),K=we.nextSibling,[xe,Se]=ee(K.nextSibling);return U(j,()=>N.map(({x:de,y:ie},Ce)=>{const ze={cx:de+.5,cy:ie+.5,r:2,fill:"black"};return(()=>{var Je=te(ms);return Kn(Je,Qn(ze,{key:Ce}),!0,!1),Fe(),Je})()})),U(B,()=>u.x,V,ne),U(B,()=>u.y,we,$e),U(B,(()=>{var de=Ye(()=>!!u.loading);return()=>de()&&(()=>{var ie=te(Ct);return le(()=>y(ie,ae.loadingIndicator)),ie})()})(),xe,Se),le(de=>{var ie=ae.tileContent,Ce=ae.tileSvg,ze=ae.tileLabel;return ie!==de.e&&y(O,de.e=ie),Ce!==de.t&&Ze(j,"class",de.t=Ce),ze!==de.a&&y(B,de.a=ze),de},{e:void 0,t:void 0,a:void 0}),O})():F=(()=>{var O=te(yn),j=O.firstChild,B=j.firstChild,H=B.firstChild,[V,ne]=ee(H.nextSibling),ce=V.nextSibling,se=ce.nextSibling,[we,$e]=ee(se.nextSibling);return U(B,()=>u.x,V,ne),U(B,()=>u.y,we,$e),le(K=>{var xe=ae.fallbackTile,Se=`--tile-bg-color: ${be(u.x,u.y)}`,de=ae.fallbackTileContent,ie=ae.tileCoords;return xe!==K.e&&y(O,K.e=xe),K.t=mt(O,Se,K.t),de!==K.a&&y(j,K.a=de),ie!==K.o&&y(B,K.o=ie),K},{e:void 0,t:void 0,a:void 0,o:void 0}),O})()}catch(N){console.error("Error rendering tile:",N),F=(()=>{var O=te(pn),j=O.firstChild,B=j.firstChild,H=B.nextSibling,V=H.firstChild,[ne,ce]=ee(V.nextSibling),se=ne.nextSibling,we=se.nextSibling,[$e,K]=ee(we.nextSibling);return U(H,()=>u.x,ne,ce),U(H,()=>u.y,$e,K),le(xe=>{var Se=`${ae.fallbackTile} ${ae.error}`,de=ae.fallbackTileContent,ie=ae.tileCoords;return Se!==xe.e&&y(O,xe.e=Se),de!==xe.t&&y(j,xe.t=de),ie!==xe.a&&y(H,xe.a=ie),xe},{e:void 0,t:void 0,a:void 0}),O})()}return(()=>{var N=te(Ct);return Ae(N,"--tile-pos-x",`${G}px`),Ae(N,"--tile-pos-y",`${W}px`),Ae(N,"--tile-size","64px"),Ae(N,"--tile-base-size","64px"),Ze(N,"data-world-x",p),Ze(N,"data-world-y",Z),Ze(N,"data-pos-x",G),Ze(N,"data-pos-y",W),U(N,F),le(O=>{var j=`${ae.tileContainer} ${ae.tile}`,B=u.x,H=u.y;return j!==O.e&&y(N,O.e=j),B!==O.t&&Ze(N,"data-tile-x",O.t=B),H!==O.a&&Ze(N,"data-tile-y",O.a=H),O},{e:void 0,t:void 0,a:void 0}),N})()},Pe=u=>{const p=[];let Z=0;for(let q=0;q<u.length&&Z<ke*ke;q++){const L=u[q];for(let G=7;G>=0&&Z<ke*ke;G--,Z++)if(L>>G&1){const W=Z%ke,F=Math.floor(Z/ke);p.push({x:W,y:F})}}return p},Re=u=>{if(typeof document>"u")return[];if(!(u instanceof Uint8Array)||u.length===0)return console.log("Invalid or empty tile data"),[];if(u[0]!==1)return console.log("Unsupported data format or missing version byte"),[];try{const p=u.subarray(1),Z=zr(p),q=Math.ceil(ke*ke/8);return Z.length!==q&&console.warn(`Unexpected decompressed size: ${Z.length}, expected ${q}`),Pe(Z)}catch(p){return console.error("Failed to process tile data:",p),[]}},Ue=()=>{const Z=[];for(let q=-16;q<=16;q++)for(let L=-16;L<=16;L++){const G=`${L},${q}`,F=t()[G]||{x:L,y:q,loading:!1,error:!1,data:null,mountId:x,timestamp:Date.now(),fromCache:!1};Z.push(Le(F))}return Z};return(()=>{var u=te(bs),p=u.firstChild,Z=p.firstChild,q=Z.firstChild,L=p.nextSibling,[G,W]=ee(L.nextSibling),F=G.nextSibling,N=F.firstChild,O=N.firstChild,j=O.nextSibling,[B,H]=ee(j.nextSibling),V=B.nextSibling,ne=V.nextSibling,[ce,se]=ee(ne.nextSibling),we=ce.nextSibling,$e=we.nextSibling,K=$e.nextSibling,[xe,Se]=ee(K.nextSibling);u.addEventListener("mouseleave",_e),u.$$mouseup=ge,u.$$mousemove=J,u.$$mousedown=X;var de=e;return typeof de=="function"?kn(de,u):e=u,Ae(q,"position","absolute"),Ae(q,"top","0"),Ae(q,"left","0"),Ae(q,"width","100%"),Ae(q,"height","100%"),U(q,Ue),U(u,(()=>{var ie=Ye(()=>!!d());return()=>ie()&&(()=>{var Ce=te(ws);return le(()=>y(Ce,ae.loadingOverlay)),Ce})()})(),G,W),U(N,()=>Math.round(a().x),B,H),U(N,()=>Math.round(a().y),ce,se),U(N,()=>Object.keys(t()).length,xe,Se),le(ie=>{var Ce=ae.mapContainer,ze=f()?ae.mapViewportDragging:ae.mapViewport,Je=ae.mapContent,Ot=`translate(${-a().x-1024}px, ${-a().y-1024}px)`,Lt=ae.controls,Rt=ae.coordinates;return Ce!==ie.e&&y(u,ie.e=Ce),ze!==ie.t&&y(p,ie.t=ze),Je!==ie.a&&y(Z,ie.a=Je),Ot!==ie.o&&Ae(Z,"transform",ie.o=Ot),Lt!==ie.i&&y(F,ie.i=Lt),Rt!==ie.n&&y(N,ie.n=Rt),ie},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0}),Fe(),u})()};it(["mousedown","mousemove","mouseup"]);const $s="_container_5fa2b_3",ps="_gameContainer_5fa2b_11",ys="_gameBoard_5fa2b_60",Ss="_loadingContainer_5fa2b_67",Ts="_loginContainer_5fa2b_68",Ke={container:$s,gameContainer:ps,gameBoard:ys,loadingContainer:Ss,loginContainer:Ts};var Es=fe("<div><!$><!/><div><!$><!/><!$><!/>"),Cs=fe("<div><!$><!/><!$><!/>"),ks=fe("<div><h1>Loading Game...</h1><div>Initializing authentication..."),Is=fe("<div><h1>Not Logged In</h1><p>Please log in to access the game.");function Os(){const{user:t,isInitialized:n,logout:e}=At(),[i,a]=ue("info");return(()=>{var o=te(Cs),f=o.firstChild,[l,b]=ee(f.nextSibling),r=l.nextSibling,[s,k]=ee(r.nextSibling);return U(o,ye(eo,{children:"Game"}),l,b),U(o,ye(De,{get when(){return n()},get fallback(){return(()=>{var d=te(ks);return le(()=>y(d,Ke.loadingContainer)),d})()},get children(){return ye(De,{get when(){return t()},get fallback(){return(()=>{var d=te(Is);return le(()=>y(d,Ke.loginContainer)),d})()},get children(){return ye(oo,{get children(){var d=te(Es),c=d.firstChild,[w,z]=ee(c.nextSibling),m=w.nextSibling,E=m.firstChild,[P,A]=ee(E.nextSibling),h=P.nextSibling,[C,Y]=ee(h.nextSibling);return U(d,ye(Ci,{get activeTab(){return i()},onTabChange:_=>a(_),get username(){return t().username},get userId(){return t().id},onLogout:e}),w,z),U(m,ye(De,{get when(){return i()==="info"},get children(){return ye(Lo,{})}}),P,A),U(m,ye(De,{get when(){return i()==="settings"},get children(){return ye(xs,{})}}),C,Y),le(_=>{var R=Ke.gameContainer,x=Ke.gameBoard;return R!==_.e&&y(d,_.e=R),x!==_.t&&y(m,_.t=x),_},{e:void 0,t:void 0}),d}})}})}}),s,k),le(()=>y(o,Ke.container)),o})()}export{Os as default};
